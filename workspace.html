<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endgame Workspace</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           Design Tokens - Metis Dark Theme
           ============================================ */
        :root {
            /* Backgrounds - Warm Charcoal */
            --bg-primary: #2b2a27;
            --bg-surface: #353432;
            --bg-elevated: #3f3e3b;
            --bg-hover: #4a4946;
            --bg-active: #555451;
            
            /* Text - Soft White */
            --text-primary: #ececec;
            --text-secondary: #b8b8b6;
            --text-muted: #888886;
            --text-inverse: #2b2a27;
            
            /* Borders */
            --border-default: #4a4946;
            --border-strong: #5a5956;
            
            /* Accent - Gold */
            --accent: #d4a574;
            --accent-hover: #e0b588;
            --accent-subtle: rgba(212, 165, 116, 0.15);
            
            /* Status Colors */
            --status-inbox: #9CA3AF;
            --status-assigned: #60A5FA;
            --status-progress: #FBBF24;
            --status-review: #A78BFA;
            --status-failed: #DC2626;
            --status-done: #34D399;
            --status-blocked: #F87171;
            
            /* Priority */
            --priority-critical: #EF4444;
            --priority-high: #F97316;
            --priority-medium: #EAB308;
            --priority-low: #22C55E;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -1px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.5), 0 4px 6px -2px rgba(0,0,0,0.3);
            
            /* Typography */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'SF Mono', 'Fira Code', monospace;
        }

        /* ============================================
           Reset & Base
           ============================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body, #root {
            height: 100%;
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* ============================================
           Scrollbar Styling
           ============================================ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-strong);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ============================================
           View Toggle
           ============================================ */
        .view-toggle {
            display: flex;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 2px;
            gap: 2px;
        }

        .view-toggle-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-family: var(--font-sans);
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .view-toggle-btn.active {
            background: var(--accent);
            color: var(--text-inverse);
        }

        .view-toggle-btn:hover:not(.active) {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        /* ============================================
           Projects View
           ============================================ */
        .projects-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
        }

        .project-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 20px;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .project-card:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow-md);
        }

        .project-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .project-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-card-code {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--accent);
            background: var(--accent-subtle);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .project-card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-progress {
            margin-bottom: 12px;
        }

        .project-progress-bar {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .project-progress-fill {
            height: 100%;
            background: var(--status-done);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .project-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
        }

        .project-wo-list {
            border-top: 1px solid var(--border-default);
            padding-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .project-wo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            background: var(--bg-elevated);
        }

        .project-wo-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .project-wo-status.draft { background: var(--status-inbox); }
        .project-wo-status.ready { background: var(--status-assigned); }
        .project-wo-status.in_progress { background: var(--status-progress); }
        .project-wo-status.review { background: var(--status-review); }
        .project-wo-status.done { background: var(--status-done); }
        .project-wo-status.blocked { background: var(--status-blocked); }

        .project-wo-name {
            flex: 1;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .project-wo-commit {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--accent);
            text-decoration: none;
            padding: 2px 6px;
            background: var(--accent-subtle);
            border-radius: 4px;
        }

        .project-wo-commit:hover {
            color: var(--accent-hover);
        }

        .project-repo-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--accent);
            text-decoration: none;
            margin-bottom: 12px;
        }

        .project-repo-link:hover {
            color: var(--accent-hover);
        }

        .project-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-default);
        }

        .projects-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .projects-empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* ============================================
           Layout
           ============================================ */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-default);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
        }

        .stats {
            display: flex;
            gap: 24px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-time {
            text-align: right;
        }

        .header-time-value {
            font-size: 18px;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .header-time-date {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(52, 211, 153, 0.15);
            color: #34D399;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #34D399;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ============================================
           Sidebar - Agents
           ============================================ */
        .sidebar {
            width: 240px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-count {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .agents-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .agent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .agent-item:hover {
            background: var(--bg-hover);
        }

        .agent-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-inverse);
            flex-shrink: 0;
        }

        .agent-avatar.metis { background: #3B82F6; }
        .agent-avatar.ilmarinen { background: #F59E0B; }
        .agent-avatar.audit { background: #8B5CF6; }
        .agent-avatar.product { background: #10B981; }
        .agent-avatar.security { background: #EF4444; }
        .agent-avatar.qa { background: #06B6D4; }

        .agent-info {
            flex: 1;
            min-width: 0;
        }

        .agent-name {
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .agent-badge {
            font-size: 9px;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .agent-badge.leader { background: rgba(96, 165, 250, 0.2); color: #60A5FA; }
        .agent-badge.executor { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }
        .agent-badge.reviewer { background: rgba(167, 139, 250, 0.2); color: #A78BFA; }
        .agent-badge.specialist { background: rgba(52, 211, 153, 0.2); color: #34D399; }

        .agent-role {
            font-size: 12px;
            color: var(--text-muted);
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--status-done);
            font-weight: 500;
        }

        .agent-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .agent-status.offline {
            color: var(--text-muted);
        }

        /* ============================================
           Kanban Board
           ============================================ */
        .board-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .board-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-surface);
        }

        .board-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .board-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--text-inverse);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }

        .board {
            flex: 1;
            display: flex;
            gap: 16px;
            padding: 16px 24px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .column {
            flex: 0 0 280px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--bg-surface);
            border-radius: 10px 10px 0 0;
            border: 1px solid var(--border-default);
            border-bottom: none;
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .column-dot.inbox { background: var(--status-inbox); }
        .column-dot.assigned { background: var(--status-assigned); }
        .column-dot.progress { background: var(--status-progress); }
        .column-dot.review { background: var(--status-review); }
        .column-dot.failed { background: var(--status-failed); }
        .column-dot.done { background: var(--status-done); }
        .column-dot.blocked { background: var(--status-blocked); }

        .column-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .column-count {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .column-cards {
            flex: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 8px;
            overflow-y: auto;
            min-height: 200px;
        }

        .column-cards.drag-over {
            background: var(--accent-subtle);
            border-color: var(--accent);
        }

        /* ============================================
           Work Order Cards
           ============================================ */
        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.15s ease;
            box-shadow: var(--shadow-sm);
        }

        .card:hover {
            border-color: var(--border-strong);
            box-shadow: var(--shadow-md);
        }

        .card:active {
            cursor: grabbing;
        }

        .card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .card-title {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.4;
            flex: 1;
            margin-right: 8px;
        }

        .card-priority {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .card-priority.p0_critical { background: var(--priority-critical); }
        .card-priority.p1_high { background: var(--priority-high); }
        .card-priority.p2_medium { background: var(--priority-medium); }
        .card-priority.p3_low { background: var(--priority-low); }

        .card-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }

        .card-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .card-escalation-banner {
            margin-bottom: 8px;
            padding: 8px 10px;
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid #F59E0B;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .escalation-icon {
            font-size: 16px;
        }

        .escalation-text {
            font-size: 11px;
            font-weight: 600;
            color: #F59E0B;
        }

        .escalation-action {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .card-failure-reason {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--status-failed);
            border-radius: 4px;
        }

        .failure-reason-header {
            font-size: 11px;
            font-weight: 600;
            color: var(--status-failed);
            margin-bottom: 4px;
        }

        .failure-reason-content {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-assignee-avatar {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: var(--text-inverse);
        }

        .card-assignee-name {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .card-meta {
            font-size: 10px;
            color: var(--text-muted);
        }

        .card-expand {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-default);
        }

        .card-expand-row {
            display: flex;
            margin-bottom: 8px;
        }

        .card-expand-label {
            font-size: 11px;
            color: var(--text-muted);
            width: 80px;
            flex-shrink: 0;
        }

        .card-expand-value {
            font-size: 11px;
            color: var(--text-secondary);
            flex: 1;
        }

        .card-actions {
            display: flex;
            gap: 4px;
            margin-top: 10px;
        }

        .card-action-btn {
            flex: 1;
            padding: 6px 8px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid var(--border-default);
            background: var(--bg-surface);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .card-action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-strong);
        }

        .card-action-btn.approve-btn {
            background: rgba(125, 180, 130, 0.15);
            border-color: #7db482;
            color: #7db482;
        }

        .card-action-btn.approve-btn:hover {
            background: rgba(125, 180, 130, 0.3);
        }

        .card-action-btn.reject-btn {
            background: rgba(212, 116, 106, 0.15);
            border-color: #d4746a;
            color: #d4746a;
        }

        .card-action-btn.reject-btn:hover {
            background: rgba(212, 116, 106, 0.3);
        }

        .card-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .card-quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-default);
        }

        .card-quick-actions:empty {
            display: none;
        }

        /* ============================================
           QA Results Panel
           ============================================ */
        .qa-results-panel {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            overflow: hidden;
        }

        .qa-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-default);
        }

        .qa-results-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .qa-results-summary {
            font-size: 11px;
            color: var(--text-muted);
        }

        .qa-rounds {
            max-height: 400px;
            overflow-y: auto;
        }

        .qa-round {
            border-bottom: 1px solid var(--border-default);
        }

        .qa-round:last-child {
            border-bottom: none;
        }

        .qa-round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-surface);
            transition: background 0.15s ease;
        }

        .qa-round-header:hover {
            background: var(--bg-hover);
        }

        .qa-round-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .qa-round-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .qa-round-meta {
            font-size: 10px;
            color: var(--text-muted);
        }

        .qa-round-stats {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qa-stat {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .qa-stat-pass {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
        }

        .qa-stat-fail {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .qa-stat-na {
            background: rgba(156, 163, 175, 0.15);
            color: #9ca3af;
        }

        .qa-round-toggle {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: 8px;
        }

        .qa-round-content {
            background: var(--bg-primary);
            padding: 8px 12px;
        }

        .qa-finding {
            padding: 8px;
            margin-bottom: 6px;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 4px;
        }

        .qa-finding:last-child {
            margin-bottom: 0;
        }

        .qa-finding-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .qa-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .qa-badge-pass {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .qa-badge-fail {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .qa-badge-na {
            background: rgba(156, 163, 175, 0.15);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .qa-badge-unknown {
            background: rgba(212, 165, 116, 0.15);
            color: var(--accent);
            border: 1px solid rgba(212, 165, 116, 0.3);
        }

        .qa-finding-criterion {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }

        .qa-finding-resolved {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
            border-radius: 3px;
        }

        .qa-finding-summary {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-top: 4px;
            padding-left: 24px;
        }

        .qa-round-footer {
            padding: 8px 0 0 0;
            margin-top: 8px;
            border-top: 1px solid var(--border-default);
        }

        .qa-round-footer-text {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* ============================================
           Live Feed Sidebar
           ============================================ */
        .feed-sidebar {
            width: 320px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow: hidden;
        }

        .feed-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-default);
        }

        .feed-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .feed-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .feed-filter {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 12px;
            border: 1px solid var(--border-default);
            background: var(--bg-surface);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .feed-filter:hover {
            border-color: var(--border-strong);
        }

        .feed-filter.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-inverse);
        }

        .feed-content {
            flex: 1;
            overflow-y: auto;
        }

        .feed-section {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-default);
        }

        .feed-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .agent-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .agent-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .agent-chip:hover {
            background: var(--bg-hover);
        }

        .agent-chip-avatar {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: var(--text-inverse);
        }

        .agent-chip-count {
            font-weight: 600;
            color: var(--text-primary);
        }

        .feed-events {
            padding: 0;
        }

        .feed-event {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-default);
            transition: background 0.15s ease;
        }

        .feed-event:hover {
            background: var(--bg-hover);
        }

        .feed-event-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            background: var(--bg-elevated);
        }

        .feed-event-content {
            flex: 1;
            min-width: 0;
        }

        .feed-event-text {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .feed-event-text strong {
            color: var(--accent);
            font-weight: 500;
        }

        .feed-event-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* ============================================
           Modal
           ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.15s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-surface);
            border-radius: 12px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-default);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            font-size: 18px;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            background: var(--bg-surface);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-default);
            background: var(--bg-elevated);
        }

        /* ============================================
           Loading & Empty States
           ============================================ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-default);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            color: var(--text-muted);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 13px;
        }

        /* ============================================
           Responsive
           ============================================ */
        @media (max-width: 1200px) {
            .feed-sidebar {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                width: 200px;
            }
            .column {
                flex: 0 0 240px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .header {
                padding: 12px 16px;
            }
            .stats {
                display: none;
            }
            .board {
                padding: 12px;
            }
        }

        /* ============================================
           Toast Notifications
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.2s ease;
            max-width: 320px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast-icon {
            font-size: 16px;
        }

        .toast-message {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 14px;
            padding: 0 2px;
            line-height: 1;
            opacity: 0.6;
        }
        .toast-close:hover { opacity: 1; }

        .toast.success { border-left: 3px solid var(--status-done); }
        .toast.error { border-left: 3px solid var(--status-blocked); }
        .toast.info { border-left: 3px solid var(--status-assigned); }
        .toast.warning { border-left: 3px solid var(--status-progress); }

        /* Live Log Panel */
        .live-log-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .live-log-panel {
            width: min(92vw, 960px);
            height: min(85vh, 800px);
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .live-log-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid #333;
            background: #252525;
        }

        .live-log-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .live-log-title {
            font-size: 15px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .live-log-slug {
            font-size: 12px;
            color: #777;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        .live-log-pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--status-progress);
            animation: pulse 1.5s ease-in-out infinite;
            flex-shrink: 0;
        }

        .live-log-pulse.complete {
            background: var(--status-done);
            animation: none;
        }

        .live-log-pulse.error {
            background: var(--status-blocked);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .live-log-close {
            background: none;
            border: none;
            color: #777;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .live-log-close:hover {
            background: #333;
            color: #e8e8e8;
        }

        .live-log-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #ccc;
        }

        .live-log-body::-webkit-scrollbar { width: 6px; }
        .live-log-body::-webkit-scrollbar-track { background: transparent; }
        .live-log-body::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* Event wrapper */
        .log-event {
            padding: 2px 20px;
            border-left: 3px solid transparent;
            margin: 0;
        }

        /* System events (start/complete/error) */
        .log-event.evt-execution_start {
            background: rgba(96, 165, 250, 0.08);
            border-left-color: #60A5FA;
            padding: 10px 20px;
            margin-bottom: 8px;
            color: #60A5FA;
            font-weight: 600;
            font-size: 13px;
        }

        .log-event.evt-execution_complete {
            background: rgba(52, 211, 153, 0.08);
            border-left-color: #34D399;
            padding: 10px 20px;
            margin-top: 8px;
            color: #34D399;
            font-weight: 600;
            font-size: 13px;
        }

        .log-event.evt-execution_error {
            background: rgba(248, 113, 113, 0.1);
            border-left-color: #F87171;
            padding: 10px 20px;
            margin-top: 8px;
            color: #F87171;
            font-weight: 600;
        }

        /* Thinking/reasoning text */
        .log-event.evt-thinking {
            color: #999;
            font-style: italic;
            padding: 4px 20px;
            border-left-color: #444;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Tool call header */
        .log-event.evt-tool_call {
            background: rgba(212, 165, 116, 0.08);
            border-left-color: var(--accent);
            padding: 8px 20px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(212, 165, 116, 0.2);
            color: var(--accent);
            padding: 2px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .tool-badge-icon {
            font-size: 10px;
        }

        /* Tool input */
        .log-event.evt-tool_input {
            background: #1a1a1a;
            border-left-color: var(--accent);
            padding: 6px 20px;
            margin-bottom: 2px;
        }

        .tool-input-content {
            background: #151515;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: #b0b0b0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Tool result */
        .log-event.evt-tool_result {
            border-left-color: #4ade80;
            padding: 6px 20px;
            margin-bottom: 10px;
        }

        .tool-result-content {
            background: rgba(74, 222, 128, 0.04);
            border: 1px solid rgba(74, 222, 128, 0.12);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: #a0a0a0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .tool-result-header {
            font-size: 11px;
            color: #4ade80;
            margin-bottom: 4px;
            font-weight: 500;
        }

        /* Result summary */
        .log-event.evt-result {
            background: rgba(52, 211, 153, 0.06);
            border-left-color: #34D399;
            padding: 10px 20px;
            margin-top: 6px;
            color: #d0d0d0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* System messages */
        .log-event.evt-system {
            color: #60A5FA;
            padding: 6px 20px;
            border-left-color: #60A5FA;
            font-size: 12px;
        }

        /* Error messages */
        .log-event.evt-error {
            background: rgba(248, 113, 113, 0.06);
            border-left-color: #F87171;
            color: #F87171;
            padding: 8px 20px;
            margin: 4px 0;
        }

        /* Status/text fallbacks */
        .log-event.evt-status,
        .log-event.evt-text {
            color: #888;
            padding: 2px 20px;
            font-size: 12px;
        }

        /* Timestamp */
        .log-ts {
            color: #555;
            font-size: 11px;
            margin-right: 10px;
            user-select: none;
            flex-shrink: 0;
        }

        .live-log-empty {
            text-align: center;
            color: #666;
            padding: 60px 20px;
            font-size: 14px;
        }

        .live-log-empty-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .live-log-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-top: 1px solid #333;
            background: #252525;
            font-size: 12px;
            color: #777;
        }

        .live-log-stats {
            display: flex;
            gap: 16px;
        }

        .live-log-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .live-log-stat-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .collapsible-toggle {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        .collapsible-toggle:hover {
            background: #333;
            color: #aaa;
        }

        .watch-btn {
            background: var(--status-progress);
            color: #000;
            border: none;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .watch-btn:hover {
            filter: brightness(1.1);
        }
    </style>
</head>
<body>
    <!-- Global Nav -->
    <nav style="display:flex;align-items:center;gap:20px;padding:8px 24px;background:var(--bg-surface);border-bottom:1px solid var(--border-default);font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;font-size:13px;">
        <span style="font-weight:700;color:var(--accent);letter-spacing:0.5px;margin-right:8px;">ENDGAME</span>
        <a href="index.html" style="color:var(--text-secondary);text-decoration:none;padding:4px 10px;border-radius:6px;">Chat</a>
        <a href="workspace.html" style="color:var(--text-primary);text-decoration:none;padding:4px 10px;border-radius:6px;background:var(--accent-subtle);">Workspace</a>
        <a href="health.html" style="color:var(--text-secondary);text-decoration:none;padding:4px 10px;border-radius:6px;">Health</a>
    </nav>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // ============================================
        // Configuration
        // ============================================
        const SUPABASE_URL = 'https://phfblljwuvzqzlbzkzpr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoZmJsbGp3dXZ6cXpsYnprenByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjAzODgsImV4cCI6MjA4NTA5NjM4OH0.mWIj2vtQb1F2Pk540f_S9WwsZFwZK0n6oeqUmZgDZlA';

        const COLUMNS = [
            { id: 'draft', name: 'Inbox', color: 'inbox' },
            { id: 'ready', name: 'Assigned', color: 'assigned' },
            { id: 'in_progress', name: 'In Progress', color: 'progress' },
            { id: 'review', name: 'Review', color: 'review' },
            { id: 'failed', name: 'Failed', color: 'failed' },
            { id: 'done', name: 'Done', color: 'done' },
            { id: 'blocked', name: 'Blocked', color: 'blocked' },
        ];

        // ============================================
        // API Helpers
        // ============================================
        const api = async (endpoint, options = {}) => {
            const res = await fetch(`${SUPABASE_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    ...options.headers,
                },
            });
            if (!res.ok) throw new Error(`API error: ${res.status}`);
            // Handle 204 No Content
            if (res.status === 204) return null;
            const text = await res.text();
            return text ? JSON.parse(text) : null;
        };

        const workspaceApi = async (action, params = {}, agentName = 'metis') => {
            return api('/functions/v1/workspace-api', {
                method: 'POST',
                headers: { 'x-agent-name': agentName },
                body: JSON.stringify({ action, ...params }),
            });
        };

        // ============================================
        // Utilities
        // ============================================
        const formatTime = (date) => {
            return new Date(date).toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        };

        const formatDate = (date) => {
            return new Date(date).toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric' 
            });
        };

        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        };

        const getInitials = (name) => {
            return name.split(/[\s_-]/).map(w => w[0]).join('').toUpperCase().slice(0, 2);
        };

        // ============================================
        // Components
        // ============================================
        
        const Toast = ({ message, type, onClose }) => {
            const closeRef = React.useRef(onClose);
            closeRef.current = onClose;
            useEffect(() => {
                const timer = setTimeout(() => closeRef.current(), 5000);
                return () => clearTimeout(timer);
            }, []);

            const icons = { success: '', error: '', info: '', warning: '' };
            return (
                <div className={`toast ${type}`}>
                    <span className="toast-icon">{icons[type]}</span>
                    <span className="toast-message">{message}</span>
                    <button className="toast-close" onClick={onClose}></button>
                </div>
            );
        };

        const AgentItem = ({ agent }) => {
            const initials = getInitials(agent.name);
            return (
                <div className="agent-item">
                    <div className={`agent-avatar ${agent.name}`}>{initials}</div>
                    <div className="agent-info">
                        <div className="agent-name">
                            {agent.name.charAt(0).toUpperCase() + agent.name.slice(1)}
                            <span className={`agent-badge ${agent.agent_type}`}>
                                {agent.agent_type}
                            </span>
                        </div>
                        <div className="agent-role">{agent.description?.split('.')[0] || 'Agent'}</div>
                    </div>
                    <div className={`agent-status ${agent.status === 'active' ? '' : 'offline'}`}>
                        <span className="agent-status-dot"></span>
                        {agent.status === 'active' ? 'Active' : 'Offline'}
                    </div>
                </div>
            );
        };

        const LiveLogPanel = ({ workOrder, onClose }) => {
            const [logEntries, setLogEntries] = useState([]);
            const [status, setStatus] = useState('streaming');
            const bodyRef = useRef(null);
            const [autoScroll, setAutoScroll] = useState(true);
            const [collapsed, setCollapsed] = useState({});
            const [activeTab, setActiveTab] = useState('stream');
            const [qaData, setQaData] = useState(null);
            const [workflowHistory, setWorkflowHistory] = useState([]);
            const [summaryData, setSummaryData] = useState(null);

            useEffect(() => {
                if (!workOrder) return;
                let active = true;
                let lastCount = 0;

                const fetchLogs = async () => {
                    try {
                        const entries = await api(
                            `/rest/v1/work_order_execution_log?work_order_id=eq.${workOrder.id}&phase=in.(stream,execution_start,execution_complete,execution_error,qa_validation)&order=created_at.asc,iteration.asc`
                        );
                        if (!active) return;
                        setLogEntries(entries || []);

                        const phases = (entries || []).map(e => e.phase);
                        if (phases.includes('execution_complete')) setStatus('complete');
                        else if (phases.includes('execution_error')) setStatus('error');
                        else setStatus('streaming');

                        if (entries && entries.length > lastCount && autoScroll && bodyRef.current) {
                            setTimeout(() => {
                                if (bodyRef.current) bodyRef.current.scrollTop = bodyRef.current.scrollHeight;
                            }, 50);
                        }
                        lastCount = entries ? entries.length : 0;
                    } catch (err) {
                        console.error('Log fetch error:', err);
                    }
                };

                const fetchQAData = async () => {
                    try {
                        // Fetch execution log entries
                        const qaEntries = await api(
                            `/rest/v1/work_order_execution_log?work_order_id=eq.${workOrder.id}&phase=in.(qa_validation,qa_review,completing)&order=created_at.desc`
                        );

                        // Fetch qa_findings for this work order
                        const findings = await api(
                            `/rest/v1/qa_findings?work_order_id=eq.${workOrder.id}&order=created_at.desc`
                        );

                        if (!active) return;

                        // Enrich qa entries with findings data
                        const enrichedData = (qaEntries || []).map(entry => {
                            // Find findings created near this QA round (within 5 min window)
                            const entryTime = new Date(entry.created_at);
                            const relatedFindings = (findings || []).filter(f => {
                                const fTime = new Date(f.created_at);
                                const diffMs = Math.abs(fTime - entryTime);
                                return diffMs < 5 * 60 * 1000; // 5 minutes
                            });

                            const passCount = relatedFindings.filter(f => f.finding_type === 'pass').length;
                            const failCount = relatedFindings.filter(f => f.finding_type === 'fail').length;
                            const activeCount = relatedFindings.filter(f => !f.resolved_at).length;
                            const resolvedCount = relatedFindings.filter(f => f.resolved_at).length;

                            return {
                                ...entry,
                                findings: relatedFindings,
                                findingStats: {
                                    pass: passCount,
                                    fail: failCount,
                                    active: activeCount,
                                    resolved: resolvedCount,
                                    total: relatedFindings.length
                                }
                            };
                        });

                        setQaData(enrichedData);
                    } catch (err) {
                        console.error('QA fetch error:', err);
                    }
                };

                const fetchWorkflowHistory = async () => {
                    try {
                        const history = await api(
                            `/rest/v1/audit_log?target_id=eq.${workOrder.id}&event_type=eq.work_order_transition&order=created_at.asc`
                        );
                        if (!active) return;
                        setWorkflowHistory(history || []);
                    } catch (err) {
                        console.error('Workflow history fetch error:', err);
                    }
                };

                const fetchSummary = async () => {
                    try {
                        const summaryEntries = await api(
                            `/rest/v1/work_order_execution_log?work_order_id=eq.${workOrder.id}&phase=in.(completing,completion_summary)&order=created_at.desc&limit=1`
                        );
                        if (!active) return;
                        if (summaryEntries && summaryEntries.length > 0) {
                            setSummaryData(summaryEntries[0]);
                        }
                    } catch (err) {
                        console.error('Summary fetch error:', err);
                    }
                };

                // Initial fetch
                fetchLogs();
                fetchQAData();
                fetchWorkflowHistory();
                fetchSummary();

                // Polling: 2s for in_progress, 30s otherwise
                const pollInterval = workOrder.status === 'in_progress' ? 2000 : 30000;
                const interval = setInterval(() => {
                    fetchLogs();
                    fetchQAData();
                    fetchWorkflowHistory();
                    fetchSummary();
                }, pollInterval);

                return () => { active = false; clearInterval(interval); };
            }, [workOrder?.id, workOrder?.status, autoScroll]);

            const handleScroll = () => {
                if (!bodyRef.current) return;
                const { scrollTop, scrollHeight, clientHeight } = bodyRef.current;
                setAutoScroll(scrollHeight - scrollTop - clientHeight < 50);
            };

            const formatTime = (ts) => {
                if (!ts) return '';
                const d = new Date(ts);
                return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            };

            const toggleCollapse = (id) => {
                setCollapsed(prev => ({ ...prev, [id]: !prev[id] }));
            };

            // Compute stats
            const toolCalls = logEntries.filter(e => e.detail?.event_type === 'tool_call').length;
            const thinkingBlocks = logEntries.filter(e => e.detail?.event_type === 'thinking').length;
            const streamEvents = logEntries.filter(e => e.phase === 'stream').length;

            const renderEvent = (entry, i) => {
                const detail = entry.detail || {};
                const eventType = detail.event_type || entry.phase;
                const content = detail.content || '';
                const toolName = detail.tool_name || '';
                const ts = formatTime(detail.ts || entry.created_at);
                const key = entry.id || i;
                const isCollapsed = collapsed[key];

                // Phase-level events (execution_start, execution_complete, execution_error)
                if (entry.phase === 'execution_start') {
                    return (
                        <div key={key} className="log-event evt-execution_start">
                            <span className="log-ts">{ts}</span>
                            {content}
                        </div>
                    );
                }
                if (entry.phase === 'execution_complete') {
                    return (
                        <div key={key} className="log-event evt-execution_complete">
                            <span className="log-ts">{ts}</span>
                            {content}
                        </div>
                    );
                }
                if (entry.phase === 'execution_error') {
                    return (
                        <div key={key} className="log-event evt-execution_error">
                            <span className="log-ts">{ts}</span>
                            {content}
                        </div>
                    );
                }

                // Semantic event types from daemon v4 stream parser
                switch (eventType) {
                    case 'thinking':
                        return (
                            <div key={key} className="log-event evt-thinking">
                                <span className="log-ts">{ts}</span>
                                {content}
                            </div>
                        );

                    case 'tool_call':
                        return (
                            <div key={key} className="log-event evt-tool_call">
                                <span className="log-ts">{ts}</span>
                                <span className="tool-badge">
                                    <span className="tool-badge-icon">&#9881;</span>
                                    {toolName || content}
                                </span>
                            </div>
                        );

                    case 'tool_input':
                        return (
                            <div key={key} className="log-event evt-tool_input">
                                <div className="tool-input-content">
                                    {content}
                                </div>
                            </div>
                        );

                    case 'tool_result':
                        return (
                            <div key={key} className="log-event evt-tool_result">
                                <div className="tool-result-header">
                                    {toolName ? `Result from ${toolName}` : 'Tool Result'}
                                </div>
                                <div className="tool-result-content">
                                    {content}
                                </div>
                            </div>
                        );

                    case 'result':
                        return (
                            <div key={key} className="log-event evt-result">
                                <span className="log-ts">{ts}</span>
                                <strong style={{ color: '#34D399', marginRight: 8 }}>Final Result</strong>
                                <div style={{ marginTop: 6 }}>{content}</div>
                            </div>
                        );

                    case 'system':
                        if (!content) return null;
                        return (
                            <div key={key} className="log-event evt-system">
                                <span className="log-ts">{ts}</span>
                                {content}
                            </div>
                        );

                    case 'error':
                        return (
                            <div key={key} className="log-event evt-error">
                                <span className="log-ts">{ts}</span>
                                {content}
                            </div>
                        );

                    case 'status':
                    case 'text':
                        return (
                            <div key={key} className="log-event evt-status">
                                <span className="log-ts">{ts}</span>
                                {content}
                            </div>
                        );

                    default:
                        // Legacy format fallback (pre-semantic batched entries)
                        // Skip entries with no meaningful content
                        if (!content && !detail.tool_name) return null;
                        return (
                            <div key={key} className="log-event evt-text">
                                <span className="log-ts">{ts}</span>
                                {content || ''}
                            </div>
                        );
                }
            };

            const renderTabContent = () => {
                switch (activeTab) {
                    case 'stream':
                        return (
                            <div className="live-log-body" ref={bodyRef} onScroll={handleScroll}>
                                {logEntries.length === 0 ? (
                                    <div className="live-log-empty">
                                        <div className="live-log-empty-icon">&#9672;</div>
                                        {workOrder.status === 'in_progress'
                                            ? 'Waiting for Claude CLI to begin...'
                                            : 'No execution logs for this work order.'}
                                    </div>
                                ) : (
                                    logEntries.map((entry, i) => renderEvent(entry, i))
                                )}
                            </div>
                        );

                    case 'qa':
                        return (
                            <div className="live-log-body" style={{ padding: '16px' }}>
                                {!qaData || qaData.length === 0 ? (
                                    <div className="live-log-empty">
                                        <div className="live-log-empty-icon">&#10003;</div>
                                        No QA validation data yet
                                    </div>
                                ) : (
                                    qaData.map((entry, idx) => {
                                        const detail = entry.detail || {};
                                        const results = detail.results || [];
                                        const model = detail.model || 'unknown';
                                        const stats = entry.findingStats || {};
                                        const findings = entry.findings || [];

                                        // Legacy results from execution_log
                                        const legacyPassed = results.filter(r => r.status === 'pass').length;
                                        const legacyFailed = results.filter(r => r.status === 'fail').length;
                                        const legacyNA = results.filter(r => r.status === 'na').length;

                                        // New findings-based counts
                                        const passCount = stats.pass || legacyPassed;
                                        const failCount = stats.fail || legacyFailed;
                                        const naCount = legacyNA;
                                        const activeCount = stats.active || 0;
                                        const resolvedCount = stats.resolved || 0;
                                        const totalFindings = stats.total || 0;

                                        const isExpanded = idx === 0; // Expand most recent by default
                                        const roundKey = `qa-round-${entry.id}`;

                                        return (
                                            <div key={entry.id} style={{ marginBottom: '20px', background: 'var(--bg-surface)', borderRadius: '8px', padding: '12px', border: '1px solid var(--border-default)' }}>
                                                <div
                                                    style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', cursor: 'pointer' }}
                                                    onClick={() => toggleCollapse(roundKey)}
                                                >
                                                    <div>
                                                        <span style={{ fontWeight: 600, color: 'var(--text-primary)' }}>
                                                            {entry.phase === 'completing' ? ' Final Validation' : `QA Round ${entry.iteration || idx + 1}`}
                                                        </span>
                                                        <span style={{ marginLeft: '12px', fontSize: '12px', color: 'var(--text-muted)' }}>
                                                            {model}  {formatTime(entry.created_at)}
                                                        </span>
                                                    </div>
                                                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                                        {passCount > 0 && <span style={{ padding: '3px 8px', background: '#34D39920', color: '#34D399', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>{passCount} PASS</span>}
                                                        {failCount > 0 && <span style={{ padding: '3px 8px', background: '#F8717120', color: '#F87171', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>{failCount} FAIL</span>}
                                                        {naCount > 0 && <span style={{ padding: '3px 8px', background: 'var(--bg-hover)', color: 'var(--text-muted)', borderRadius: '4px', fontSize: '11px', fontWeight: 600 }}>{naCount} N/A</span>}
                                                        <span style={{ fontSize: '18px', color: 'var(--text-muted)' }}>
                                                            {collapsed[roundKey] ? '' : ''}
                                                        </span>
                                                    </div>
                                                </div>

                                                {/* Findings Stats Summary */}
                                                {totalFindings > 0 && (
                                                    <div style={{ marginBottom: '12px', padding: '8px', background: 'var(--bg-hover)', borderRadius: '6px', fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                        <strong style={{ color: 'var(--text-primary)' }}>Findings:</strong> {totalFindings} total
                                                        {activeCount > 0 && <>  <span style={{ color: '#FBBF24' }}>{activeCount} active</span></>}
                                                        {resolvedCount > 0 && <>  <span style={{ color: '#34D399' }}>{resolvedCount} resolved</span></>}
                                                    </div>
                                                )}

                                                {/* Final Acceptance Indicator */}
                                                {entry.phase === 'completing' && detail.final_status && (
                                                    <div style={{ marginBottom: '12px', padding: '10px', background: detail.final_status === 'done' ? '#34D39920' : '#60A5FA20', borderRadius: '6px', borderLeft: `3px solid ${detail.final_status === 'done' ? '#34D399' : '#60A5FA'}` }}>
                                                        <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-primary)', marginBottom: '4px' }}>
                                                            {detail.final_status === 'done' ? ' Accepted' : ' Review Required'}
                                                        </div>
                                                        {detail.result && (
                                                            <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                                {detail.result}
                                                            </div>
                                                        )}
                                                        {totalFindings > 0 && (
                                                            <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' }}>
                                                                Items evaluated: {totalFindings}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}

                                                {/* Expandable Details */}
                                                {!collapsed[roundKey] && (
                                                    <>
                                                        {/* Legacy results (backward compatibility) */}
                                                        {results.length > 0 && results.map((result, ridx) => {
                                                            const statusColor = result.status === 'pass' ? '#34D399' : result.status === 'fail' ? '#F87171' : '#888';
                                                            const statusIcon = result.status === 'pass' ? '' : result.status === 'fail' ? '' : '';

                                                            return (
                                                                <div key={ridx} style={{ padding: '10px', background: 'var(--bg-primary)', borderRadius: '6px', marginBottom: '8px', borderLeft: `3px solid ${statusColor}` }}>
                                                                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: '6px' }}>
                                                                        <span style={{ color: statusColor, fontWeight: 'bold', marginRight: '8px' }}>{statusIcon}</span>
                                                                        <span style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-primary)' }}>
                                                                            {result.criterion || `Item ${ridx + 1}`}
                                                                        </span>
                                                                    </div>
                                                                    {result.summary && (
                                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginLeft: '24px' }}>
                                                                            {result.summary}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}

                                                        {/* New findings breakdown */}
                                                        {findings.length > 0 && findings.map((finding, fidx) => {
                                                            const statusColor = finding.finding_type === 'pass' ? '#34D399' : finding.finding_type === 'fail' ? '#F87171' : '#888';
                                                            const statusIcon = finding.finding_type === 'pass' ? '' : finding.finding_type === 'fail' ? '' : '';
                                                            const isResolved = !!finding.resolved_at;

                                                            return (
                                                                <div key={finding.id} style={{ padding: '10px', background: 'var(--bg-primary)', borderRadius: '6px', marginBottom: '8px', borderLeft: `3px solid ${statusColor}`, opacity: isResolved ? 0.6 : 1 }}>
                                                                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '6px' }}>
                                                                        <div style={{ display: 'flex', alignItems: 'center' }}>
                                                                            <span style={{ color: statusColor, fontWeight: 'bold', marginRight: '8px' }}>{statusIcon}</span>
                                                                            <span style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-primary)' }}>
                                                                                {finding.description}
                                                                            </span>
                                                                        </div>
                                                                        {isResolved && (
                                                                            <span style={{ fontSize: '10px', padding: '2px 6px', background: '#34D39920', color: '#34D399', borderRadius: '3px', fontWeight: 600 }}>
                                                                                RESOLVED
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginLeft: '24px', marginBottom: '4px' }}>
                                                                        {finding.category}
                                                                    </div>
                                                                    {finding.evidence && typeof finding.evidence === 'object' && (
                                                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginLeft: '24px', marginTop: '6px', padding: '6px', background: 'var(--bg-surface)', borderRadius: '4px', fontFamily: 'var(--font-mono)' }}>
                                                                            {finding.evidence.summary || finding.evidence.criterion || JSON.stringify(finding.evidence).slice(0, 150)}
                                                                            {JSON.stringify(finding.evidence).length > 150 && '...'}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        );

                    case 'workflow':
                        return (
                            <div className="live-log-body" style={{ padding: '24px' }}>
                                {!workflowHistory || workflowHistory.length === 0 ? (
                                    <div className="live-log-empty">
                                        <div className="live-log-empty-icon">&#10146;</div>
                                        No workflow transitions yet
                                    </div>
                                ) : (
                                    <div style={{ position: 'relative', paddingLeft: '24px' }}>
                                        <div style={{ position: 'absolute', left: '8px', top: '12px', bottom: '12px', width: '2px', background: 'var(--border-default)' }}></div>
                                        {workflowHistory.map((entry, idx) => {
                                            const payload = entry.payload || {};
                                            const fromStatus = payload.from_status || 'unknown';
                                            const toStatus = payload.to_status || 'unknown';

                                            const statusColors = {
                                                draft: '#9CA3AF',
                                                ready: '#60A5FA',
                                                in_progress: '#FBBF24',
                                                review: '#A78BFA',
                                                done: '#34D399',
                                                cancelled: '#F87171',
                                                failed: '#EF4444'
                                            };

                                            return (
                                                <div key={entry.id} style={{ position: 'relative', marginBottom: '24px' }}>
                                                    <div style={{
                                                        position: 'absolute',
                                                        left: '-20px',
                                                        width: '16px',
                                                        height: '16px',
                                                        borderRadius: '50%',
                                                        background: statusColors[toStatus] || '#888',
                                                        border: '3px solid var(--bg-primary)',
                                                        zIndex: 1
                                                    }}></div>
                                                    <div style={{ padding: '12px', background: 'var(--bg-surface)', borderRadius: '8px', border: '1px solid var(--border-default)' }}>
                                                        <div style={{ fontSize: '13px', fontWeight: 600, color: 'var(--text-primary)', marginBottom: '4px' }}>
                                                            {fromStatus.replace('_', ' ')}  {toStatus.replace('_', ' ')}
                                                        </div>
                                                        <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>
                                                            {formatTime(entry.created_at)}  {entry.actor_id || 'system'}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        );

                    case 'summary':
                        return (
                            <div className="live-log-body" style={{ padding: '16px' }}>
                                {!summaryData ? (
                                    <div className="live-log-empty">
                                        <div className="live-log-empty-icon">&#128221;</div>
                                        No completion summary yet
                                    </div>
                                ) : (
                                    <div style={{ color: 'var(--text-secondary)', fontSize: '13px', lineHeight: '1.6' }}>
                                        <div style={{ marginBottom: '16px', padding: '12px', background: 'var(--bg-surface)', borderRadius: '8px', borderLeft: '3px solid var(--accent)' }}>
                                            <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '8px' }}>
                                                COMPLETION SUMMARY
                                            </div>
                                            <div style={{ color: 'var(--text-primary)' }}>
                                                {summaryData.detail?.content || summaryData.detail?.summary || 'No summary available'}
                                            </div>
                                        </div>

                                        {summaryData.detail?.verification && (
                                            <div style={{ marginBottom: '16px', padding: '12px', background: 'var(--bg-surface)', borderRadius: '8px', borderLeft: '3px solid #34D399' }}>
                                                <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '8px' }}>
                                                    VERIFICATION
                                                </div>
                                                <div style={{ color: 'var(--text-primary)' }}>
                                                    {JSON.stringify(summaryData.detail.verification, null, 2)}
                                                </div>
                                            </div>
                                        )}

                                        <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '12px' }}>
                                            Completed at {formatTime(summaryData.created_at)}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );

                    default:
                        return null;
                }
            };

            return (
                <div className="live-log-overlay" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                    <div className="live-log-panel">
                        <div className="live-log-header">
                            <div className="live-log-header-left">
                                <div className={`live-log-pulse ${status}`}></div>
                                <div>
                                    <div className="live-log-title">
                                        {status === 'streaming' ? 'Live Execution' : status === 'complete' ? 'Execution Complete' : 'Execution Failed'}
                                    </div>
                                    <div className="live-log-slug">{workOrder.slug} - {workOrder.name}</div>
                                </div>
                            </div>
                            <button className="live-log-close" onClick={onClose}>&times;</button>
                        </div>

                        <div style={{ display: 'flex', gap: '0', borderBottom: '1px solid var(--border-default)', background: 'var(--bg-surface)' }}>
                            <button
                                onClick={() => setActiveTab('stream')}
                                style={{
                                    flex: 1,
                                    padding: '12px 16px',
                                    background: activeTab === 'stream' ? 'var(--bg-primary)' : 'transparent',
                                    color: activeTab === 'stream' ? 'var(--text-primary)' : 'var(--text-muted)',
                                    border: 'none',
                                    borderBottom: activeTab === 'stream' ? '2px solid var(--accent)' : '2px solid transparent',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: activeTab === 'stream' ? 600 : 400,
                                    transition: 'all 0.2s'
                                }}
                            >
                                 CLI Output
                            </button>
                            <button
                                onClick={() => setActiveTab('qa')}
                                style={{
                                    flex: 1,
                                    padding: '12px 16px',
                                    background: activeTab === 'qa' ? 'var(--bg-primary)' : 'transparent',
                                    color: activeTab === 'qa' ? 'var(--text-primary)' : 'var(--text-muted)',
                                    border: 'none',
                                    borderBottom: activeTab === 'qa' ? '2px solid var(--accent)' : '2px solid transparent',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: activeTab === 'qa' ? 600 : 400,
                                    transition: 'all 0.2s'
                                }}
                            >
                                 QA Results
                            </button>
                            <button
                                onClick={() => setActiveTab('workflow')}
                                style={{
                                    flex: 1,
                                    padding: '12px 16px',
                                    background: activeTab === 'workflow' ? 'var(--bg-primary)' : 'transparent',
                                    color: activeTab === 'workflow' ? 'var(--text-primary)' : 'var(--text-muted)',
                                    border: 'none',
                                    borderBottom: activeTab === 'workflow' ? '2px solid var(--accent)' : '2px solid transparent',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: activeTab === 'workflow' ? 600 : 400,
                                    transition: 'all 0.2s'
                                }}
                            >
                                 Workflow
                            </button>
                            <button
                                onClick={() => setActiveTab('summary')}
                                style={{
                                    flex: 1,
                                    padding: '12px 16px',
                                    background: activeTab === 'summary' ? 'var(--bg-primary)' : 'transparent',
                                    color: activeTab === 'summary' ? 'var(--text-primary)' : 'var(--text-muted)',
                                    border: 'none',
                                    borderBottom: activeTab === 'summary' ? '2px solid var(--accent)' : '2px solid transparent',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    fontWeight: activeTab === 'summary' ? 600 : 400,
                                    transition: 'all 0.2s'
                                }}
                            >
                                 Summary
                            </button>
                        </div>

                        {renderTabContent()}

                        {activeTab === 'stream' && (
                            <div className="live-log-footer">
                                <div className="live-log-stats">
                                    <span className="live-log-stat">
                                        <span className="live-log-stat-dot" style={{ background: '#999' }}></span>
                                        {thinkingBlocks} reasoning
                                    </span>
                                    <span className="live-log-stat">
                                        <span className="live-log-stat-dot" style={{ background: 'var(--accent)' }}></span>
                                        {toolCalls} tool calls
                                    </span>
                                    <span className="live-log-stat">
                                        <span className="live-log-stat-dot" style={{ background: '#60A5FA' }}></span>
                                        {streamEvents} events
                                    </span>
                                </div>
                                <span>{autoScroll ? 'Auto-scrolling' : 'Scroll paused  scroll to bottom to resume'}</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const QAResultsPanel = ({ workOrderId }) => {
            const [qaData, setQaData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [expandedRound, setExpandedRound] = useState(null);

            useEffect(() => {
                if (!workOrderId) return;

                const fetchQAData = async () => {
                    try {
                        setLoading(true);

                        // Fetch QA findings
                        const findingsRes = await fetch(`${SUPABASE_URL}/rest/v1/qa_findings?work_order_id=eq.${workOrderId}&select=*&order=created_at.desc`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        const findings = await findingsRes.json();

                        // Fetch QA execution log entries
                        const logRes = await fetch(`${SUPABASE_URL}/rest/v1/work_order_execution_log?work_order_id=eq.${workOrderId}&phase=in.("qa_validation","qa_review","completing")&select=*&order=created_at.desc`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });
                        const logs = await logRes.json();

                        // Group findings by iteration/round
                        const findingsByIteration = findings.reduce((acc, f) => {
                            const iter = f.evidence?.iteration || 0;
                            if (!acc[iter]) acc[iter] = [];
                            acc[iter].push(f);
                            return acc;
                        }, {});

                        // Group logs by iteration
                        const logsByIteration = logs.reduce((acc, l) => {
                            const iter = l.iteration || 0;
                            if (!acc[iter]) acc[iter] = [];
                            acc[iter].push(l);
                            return acc;
                        }, {});

                        // Combine into rounds
                        const allIterations = new Set([...Object.keys(findingsByIteration), ...Object.keys(logsByIteration)]);
                        const rounds = Array.from(allIterations).map(iter => {
                            const iterNum = parseInt(iter);
                            const iterFindings = findingsByIteration[iter] || [];
                            const iterLogs = logsByIteration[iter] || [];

                            const passCount = iterFindings.filter(f => f.evidence?.status === 'pass').length;
                            const failCount = iterFindings.filter(f => f.evidence?.status === 'fail').length;
                            const naCount = iterFindings.filter(f => f.evidence?.status === 'na').length;
                            const resolvedCount = iterFindings.filter(f => f.resolved_at).length;

                            const qaLog = iterLogs.find(l => l.phase === 'qa_validation' || l.phase === 'qa_review');
                            const model = qaLog?.detail?.model || 'unknown';
                            const timestamp = qaLog?.created_at || (iterFindings[0]?.created_at);
                            const itemsEvaluated = qaLog?.detail?.items_evaluated || iterFindings.length;

                            return {
                                iteration: iterNum,
                                timestamp,
                                model,
                                passCount,
                                failCount,
                                naCount,
                                resolvedCount,
                                totalCount: iterFindings.length,
                                findings: iterFindings,
                                logs: iterLogs
                            };
                        }).sort((a, b) => b.iteration - a.iteration);

                        setQaData({ rounds, totalFindings: findings.length });
                        // Auto-expand most recent round
                        if (rounds.length > 0) {
                            setExpandedRound(rounds[0].iteration);
                        }
                    } catch (err) {
                        console.error('Failed to fetch QA data:', err);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchQAData();
            }, [workOrderId]);

            if (loading) {
                return (
                    <div style={{ padding: '12px', color: 'var(--text-muted)', fontSize: '12px' }}>
                        Loading QA results...
                    </div>
                );
            }

            if (!qaData || qaData.rounds.length === 0) {
                return (
                    <div style={{ padding: '12px', color: 'var(--text-muted)', fontSize: '12px' }}>
                        No QA results available
                    </div>
                );
            }

            return (
                <div className="qa-results-panel">
                    <div className="qa-results-header">
                        <span className="qa-results-title">QA Results</span>
                        <span className="qa-results-summary">
                            {qaData.rounds.length} round{qaData.rounds.length !== 1 ? 's' : ''}  {qaData.totalFindings} finding{qaData.totalFindings !== 1 ? 's' : ''}
                        </span>
                    </div>

                    <div className="qa-rounds">
                        {qaData.rounds.map(round => {
                            const isExpanded = expandedRound === round.iteration;
                            const isPassing = round.failCount === 0 && round.totalCount > 0;

                            return (
                                <div key={round.iteration} className="qa-round">
                                    <div
                                        className="qa-round-header"
                                        onClick={() => setExpandedRound(isExpanded ? null : round.iteration)}
                                        style={{ cursor: 'pointer' }}
                                    >
                                        <div className="qa-round-info">
                                            <span className="qa-round-label">
                                                Round {round.iteration}
                                                {isPassing && <span className="qa-badge qa-badge-pass" style={{ marginLeft: '8px' }}> PASS</span>}
                                                {!isPassing && round.failCount > 0 && <span className="qa-badge qa-badge-fail" style={{ marginLeft: '8px' }}> FAIL</span>}
                                            </span>
                                            <span className="qa-round-meta">
                                                {round.model}  {timeAgo(round.timestamp)}
                                            </span>
                                        </div>
                                        <div className="qa-round-stats">
                                            {round.passCount > 0 && <span className="qa-stat qa-stat-pass">{round.passCount} pass</span>}
                                            {round.failCount > 0 && <span className="qa-stat qa-stat-fail">{round.failCount} fail</span>}
                                            {round.naCount > 0 && <span className="qa-stat qa-stat-na">{round.naCount} n/a</span>}
                                            <span className="qa-round-toggle">{isExpanded ? '' : ''}</span>
                                        </div>
                                    </div>

                                    {isExpanded && (
                                        <div className="qa-round-content">
                                            {round.findings.length === 0 ? (
                                                <div style={{ padding: '8px', color: 'var(--text-muted)', fontSize: '12px' }}>
                                                    No findings in this round
                                                </div>
                                            ) : (
                                                round.findings.map((finding, idx) => {
                                                    const status = finding.evidence?.status || 'unknown';
                                                    const summary = finding.evidence?.summary || finding.description;
                                                    const criterion = finding.evidence?.criterion || finding.checklist_item_id;

                                                    return (
                                                        <div key={finding.id} className="qa-finding">
                                                            <div className="qa-finding-header">
                                                                <span className={`qa-badge qa-badge-${status}`}>
                                                                    {status === 'pass' && ''}
                                                                    {status === 'fail' && ''}
                                                                    {status === 'na' && ''}
                                                                    {status !== 'pass' && status !== 'fail' && status !== 'na' && '?'}
                                                                </span>
                                                                <span className="qa-finding-criterion">
                                                                    {criterion || `Finding ${idx + 1}`}
                                                                </span>
                                                                {finding.resolved_at && (
                                                                    <span className="qa-finding-resolved"> Resolved</span>
                                                                )}
                                                            </div>
                                                            {summary && (
                                                                <div className="qa-finding-summary">
                                                                    {summary}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })
                                            )}

                                            <div className="qa-round-footer">
                                                <span className="qa-round-footer-text">
                                                    {round.resolvedCount} of {round.totalCount} resolved  {round.logs.length} log entries
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const WorkOrderCard = ({ workOrder, agents, onStatusChange, onExpand, onApprove, onAccept, onReject, onRollback, onWatch, onCancel, onRetry, expanded, actionLoading, staleThreshold }) => {
            const isLoading = actionLoading?.[workOrder.id];
            const assignedAgent = agents.find(a => a.id === workOrder.assigned_to);

            // State for failure reason from execution_log
            const [failureReason, setFailureReason] = useState(null);

            // Check if work order is stale
            const isStale = staleThreshold && (() => {
                const updatedAt = new Date(workOrder.updated_at || workOrder.created_at);
                const staleDate = new Date();
                staleDate.setDate(staleDate.getDate() - staleThreshold);
                return updatedAt < staleDate;
            })();

            // Fetch failure reason from execution_log for failed WOs
            useEffect(() => {
                if (workOrder.status !== 'failed') {
                    setFailureReason(null);
                    return;
                }

                const fetchFailureReason = async () => {
                    try {
                        // Fetch execution_error phase entries
                        const errorEntries = await api(
                            `/rest/v1/work_order_execution_log?work_order_id=eq.${workOrder.id}&phase=eq.execution_error&order=created_at.desc&limit=1`
                        );

                        if (errorEntries && errorEntries.length > 0) {
                            const errorDetail = errorEntries[0].detail;
                            if (errorDetail) {
                                // Extract error message from detail
                                const errorMsg = errorDetail.error || errorDetail.message || JSON.stringify(errorDetail);
                                setFailureReason(errorMsg);
                                return;
                            }
                        }

                        // Fallback to summary if no execution_log error found
                        setFailureReason(workOrder.summary || null);
                    } catch (err) {
                        console.error('Failed to fetch failure reason:', err);
                        setFailureReason(workOrder.summary || null);
                    }
                };

                fetchFailureReason();
            }, [workOrder.id, workOrder.status, workOrder.summary]);

            const handleDragStart = (e) => {
                e.dataTransfer.setData('text/plain', workOrder.id);
                e.currentTarget.classList.add('dragging');
            };

            const handleDragEnd = (e) => {
                e.currentTarget.classList.remove('dragging');
            };

            return (
                <div
                    className="card"
                    draggable
                    onDragStart={handleDragStart}
                    onDragEnd={handleDragEnd}
                    style={{ opacity: isStale ? 0.6 : 1 }}
                >
                    <div className="card-header">
                        <div className="card-title" onClick={() => onExpand(workOrder.id)}>
                            {workOrder.slug && <span style={{ color: 'var(--text-muted)', marginRight: '8px' }}>{workOrder.slug}</span>}
                            {workOrder.name}
                            {isStale && <span style={{ marginLeft: '8px', fontSize: '11px', padding: '2px 6px', background: 'var(--bg-hover)', borderRadius: '4px', color: 'var(--text-muted)' }}>stale</span>}
                        </div>
                        <div className={`card-priority ${workOrder.priority || 'p2_medium'}`}
                             title={workOrder.priority?.replace('_', ' ')} />
                    </div>
                    
                    {workOrder.objective && (
                        <div className="card-description">{workOrder.objective}</div>
                    )}

                    {workOrder.tags?.length > 0 && (
                        <div className="card-tags">
                            {workOrder.tags.slice(0, 3).map((tag, i) => (
                                <span key={i} className="card-tag">{tag}</span>
                            ))}
                        </div>
                    )}

                    {/* Escalation Banner  circuit breaker tripped, needs manual intervention */}
                    {(() => {
                        if (workOrder.status !== 'failed') return null;
                        const escalationTag = (workOrder.tags || []).find(tag => tag.startsWith('escalation:'));
                        if (!escalationTag) return null;
                        const escalatedTo = escalationTag.split(':')[1] || 'unknown';
                        return (
                            <div className="card-escalation-banner">
                                <span className="escalation-icon">&#9888;</span>
                                <div>
                                    <div className="escalation-text">Escalated to {escalatedTo}</div>
                                    <div className="escalation-action">Auto-remediation exhausted  needs manual pickup</div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* Failure Reason Display */}
                    {workOrder.status === 'failed' && (
                        <div className="card-failure-reason">
                            <div className="failure-reason-header"> Failure Reason</div>
                            <div className="failure-reason-content">
                                {failureReason || 'No failure details recorded'}
                            </div>
                        </div>
                    )}

                    <div className="card-footer">
                        {assignedAgent ? (
                            <div className="card-assignee">
                                <div className={`card-assignee-avatar ${assignedAgent.name}`}>
                                    {getInitials(assignedAgent.name)}
                                </div>
                                <span className="card-assignee-name">{assignedAgent.name}</span>
                            </div>
                        ) : (
                            <span className="card-assignee-name" style={{ color: 'var(--text-muted)' }}>
                                Unassigned
                            </span>
                        )}
                        <span className="card-meta">{timeAgo(workOrder.created_at)}</span>
                    </div>

                    {/* Quick action buttons - always visible */}
                    <div className="card-quick-actions">
                        {workOrder.status === 'draft' && (
                            <button
                                className="card-action-btn approve-btn"
                                onClick={(e) => { e.stopPropagation(); onApprove(workOrder.id); }}
                                disabled={isLoading}
                            >
                                {isLoading === 'approve' ? 'Approving...' : ' Approve'}
                            </button>
                        )}
                        {workOrder.status === 'review' && (
                            <>
                                <button
                                    className="card-action-btn approve-btn"
                                    onClick={(e) => { e.stopPropagation(); onAccept(workOrder.id); }}
                                    disabled={isLoading}
                                >
                                    {isLoading === 'accept' ? 'Accepting...' : ' Accept'}
                                </button>
                                <button
                                    className="card-action-btn reject-btn"
                                    onClick={(e) => { e.stopPropagation(); onReject(workOrder.id); }}
                                    disabled={isLoading}
                                >
                                    {isLoading === 'reject' ? 'Rejecting...' : ' Reject'}
                                </button>
                            </>
                        )}
                        {workOrder.status === 'done' && (
                            <button
                                className="card-action-btn reject-btn"
                                onClick={(e) => { e.stopPropagation(); onRollback(workOrder.id); }}
                                disabled={isLoading}
                                title="Administrative rollback: done  cancelled"
                            >
                                {isLoading === 'rollback' ? 'Rolling back...' : ' Rollback'}
                            </button>
                        )}
                        {(workOrder.status === 'in_progress' || workOrder.status === 'review' || workOrder.status === 'done' || workOrder.status === 'failed') && (
                            <button
                                className="watch-btn"
                                onClick={(e) => { e.stopPropagation(); onWatch(workOrder); }}
                            >
                                {workOrder.status === 'in_progress' ? ' Watch Live' : ' View Log'}
                            </button>
                        )}
                        {workOrder.status !== 'cancelled' && workOrder.status !== 'done' && onCancel && (
                            <button
                                className="card-action-btn"
                                onClick={(e) => { e.stopPropagation(); onCancel(workOrder.id); }}
                                disabled={isLoading}
                                style={{ background: 'var(--status-blocked)', color: 'white' }}
                                title="Cancel this work order"
                            >
                                {isLoading === 'cancel' ? 'Cancelling...' : ' Cancel'}
                            </button>
                        )}
                        {workOrder.status === 'failed' && (workOrder.tags || []).includes('escalation:ilmarinen') && onRetry && (
                            <button
                                className="card-action-btn"
                                onClick={(e) => { e.stopPropagation(); onRetry(workOrder.id); }}
                                disabled={isLoading}
                                style={{ background: '#F59E0B', color: '#000' }}
                                title="Reset to draft for re-approval and re-execution"
                            >
                                {isLoading === 'retry' ? 'Resetting...' : ' Retry'}
                            </button>
                        )}
                    </div>

                    {expanded === workOrder.id && (
                        <div className="card-expand">
                            <div className="card-expand-row">
                                <span className="card-expand-label">Slug</span>
                                <span className="card-expand-value">{workOrder.slug}</span>
                            </div>
                            {workOrder.design_doc_id && (
                                <div className="card-expand-row">
                                    <span className="card-expand-label">Design Doc</span>
                                    <span className="card-expand-value">
                                        <a
                                            href={`#/design-doc/${workOrder.design_doc_id}`}
                                            style={{ color: 'var(--accent)', textDecoration: 'none' }}
                                            onClick={(e) => e.stopPropagation()}
                                        >
                                             View Design Document
                                        </a>
                                    </span>
                                </div>
                            )}
                            {workOrder.design_doc_required && (
                                <div className="card-expand-row" style={{ background: 'rgba(212, 165, 116, 0.1)', padding: '8px', borderRadius: '4px', border: '1px solid var(--accent)' }}>
                                    <span className="card-expand-label" style={{ color: 'var(--accent)' }}> Design Doc</span>
                                    <span className="card-expand-value" style={{ color: 'var(--accent)' }}>
                                        Required for feature/architecture WOs
                                    </span>
                                </div>
                            )}
                            {workOrder.acceptance_criteria && (
                                <div className="card-expand-row">
                                    <span className="card-expand-label">Criteria</span>
                                    <span className="card-expand-value">{workOrder.acceptance_criteria}</span>
                                </div>
                            )}

                            {/* QA Results Panel */}
                            {(workOrder.status === 'review' || workOrder.status === 'done' || workOrder.status === 'in_progress') && (
                                <div className="card-expand-row" style={{ display: 'block', marginTop: '12px' }}>
                                    <QAResultsPanel workOrderId={workOrder.id} />
                                </div>
                            )}

                            <div className="card-actions">
                                {COLUMNS.filter(c => c.id !== workOrder.status).slice(0, 3).map(col => (
                                    <button
                                        key={col.id}
                                        className="card-action-btn"
                                        onClick={() => onStatusChange(workOrder.id, col.id)}
                                    >
                                         {col.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const KanbanColumn = ({ column, workOrders, agents, onDrop, onStatusChange, onExpand, onApprove, onAccept, onReject, onRollback, onWatch, onCancel, onRetry, expanded, actionLoading, staleThreshold }) => {
            const [isDragOver, setIsDragOver] = useState(false);

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };

            const handleDragLeave = () => {
                setIsDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                const workOrderId = e.dataTransfer.getData('text/plain');
                onDrop(workOrderId, column.id);
            };

            return (
                <div className="column">
                    <div className="column-header">
                        <div className="column-title">
                            <span className={`column-dot ${column.color}`}></span>
                            <span className="column-name">{column.name}</span>
                        </div>
                        <span className="column-count">{workOrders.length}</span>
                    </div>
                    <div 
                        className={`column-cards ${isDragOver ? 'drag-over' : ''}`}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                    >
                        {workOrders.length === 0 ? (
                            <div className="empty-state">
                                <span className="empty-state-icon"></span>
                                <span className="empty-state-text">Drop items here</span>
                            </div>
                        ) : (
                            workOrders.map(wo => (
                                <WorkOrderCard
                                    key={wo.id}
                                    workOrder={wo}
                                    agents={agents}
                                    onStatusChange={onStatusChange}
                                    onExpand={onExpand}
                                    onApprove={onApprove}
                                    onAccept={onAccept}
                                    onReject={onReject}
                                    onRollback={onRollback}
                                    onWatch={onWatch}
                                    onCancel={onCancel}
                                    onRetry={onRetry}
                                    expanded={expanded}
                                    actionLoading={actionLoading}
                                    staleThreshold={staleThreshold}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const EventItem = ({ event, agents }) => {
            const agent = agents.find(a => a.id === event.agent_id);
            const icons = {
                claimed: '', completed: '', blocked: '', message: '',
                needs_review: '', approved: '', rejected: '', handoff: '',
            };

            return (
                <div className="feed-event">
                    <div className="feed-event-icon">{icons[event.event_type] || ''}</div>
                    <div className="feed-event-content">
                        <div className="feed-event-text">
                            <strong>{agent?.name || 'Unknown'}</strong>
                            {' '}{event.event_type.replace('_', ' ')}
                            {event.work_order?.name && (
                                <> on "{event.work_order.name.slice(0, 30)}..."</>
                            )}
                        </div>
                        <div className="feed-event-meta">{timeAgo(event.created_at)}</div>
                    </div>
                </div>
            );
        };

        const CreateModal = ({ isOpen, onClose, onCreate, agents }) => {
            const [form, setForm] = useState({
                name: '', objective: '', priority: 'p2_medium', assigned_to: '', acceptance_criteria: ''
            });
            const [submitting, setSubmitting] = useState(false);

            // AC7: ESC key handler for modal dismissal
            useEffect(() => {
                if (!isOpen) return;
                const handleEsc = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [isOpen, onClose]);

            if (!isOpen) return null;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);
                try {
                    await onCreate(form);
                    setForm({ name: '', objective: '', priority: 'p2_medium', assigned_to: '', acceptance_criteria: '' });
                    onClose();
                } catch (err) {
                    console.error(err);
                }
                setSubmitting(false);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Create Work Order</h2>
                            <button className="modal-close" onClick={onClose}></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label className="form-label">Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={form.name}
                                        onChange={(e) => setForm({ ...form, name: e.target.value })}
                                        placeholder="What needs to be done?"
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Objective *</label>
                                    <textarea
                                        className="form-textarea"
                                        value={form.objective}
                                        onChange={(e) => setForm({ ...form, objective: e.target.value })}
                                        placeholder="What is the goal? What should be achieved?"
                                        required
                                    />
                                </div>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Priority</label>
                                        <select
                                            className="form-select"
                                            value={form.priority}
                                            onChange={(e) => setForm({ ...form, priority: e.target.value })}
                                        >
                                            <option value="p0_critical">P0 - Critical</option>
                                            <option value="p1_high">P1 - High</option>
                                            <option value="p2_medium">P2 - Medium</option>
                                            <option value="p3_low">P3 - Low</option>
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Assign To</label>
                                        <select
                                            className="form-select"
                                            value={form.assigned_to}
                                            onChange={(e) => setForm({ ...form, assigned_to: e.target.value })}
                                        >
                                            <option value="">Unassigned</option>
                                            {agents.filter(a => a.agent_type === 'executor').map(a => (
                                                <option key={a.id} value={a.id}>{a.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Acceptance Criteria</label>
                                    <textarea
                                        className="form-textarea"
                                        value={form.acceptance_criteria}
                                        onChange={(e) => setForm({ ...form, acceptance_criteria: e.target.value })}
                                        placeholder="What defines done?"
                                    />
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary" disabled={submitting || !form.name || !form.objective}>
                                    {submitting ? 'Creating...' : 'Create'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const DuplicateWarningModal = ({ isOpen, onClose, onApproveAnyway, workOrderId, workOrderName, duplicates, onRefresh, addToast }) => {
            const [submitting, setSubmitting] = useState(false);
            const [consolidating, setConsolidating] = useState(false);
            const [consolidationResult, setConsolidationResult] = useState(null);
            const [editedName, setEditedName] = useState('');
            const [editedObjective, setEditedObjective] = useState('');

            // AC7: ESC key handler for modal dismissal
            useEffect(() => {
                if (!isOpen) return;
                const handleEsc = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [isOpen, onClose]);

            if (!isOpen) return null;

            const highMatches = (duplicates || []).filter(d => d.relevance > 0.3 || (d.recommendation && (d.recommendation.includes('EXISTS') || d.recommendation.includes('COMPLETED') || d.recommendation.includes('IN PROGRESS'))));

            const handleApprove = async () => {
                setSubmitting(true);
                await onApproveAnyway();
                setSubmitting(false);
                onClose();
            };

            const handleConsolidate = async () => {
                setConsolidating(true);
                try {
                    const res = await api('/functions/v1/work-order-executor/consolidate', {
                        method: 'POST',
                        body: JSON.stringify({ work_order_id: workOrderId, duplicates }),
                    });
                    setConsolidationResult(res);
                    setEditedName(res.refined?.name || '');
                    setEditedObjective(res.refined?.objective || '');
                } catch (err) {
                    console.error('Consolidation failed:', err);
                    addToast('Consolidation failed: ' + err.message, 'error');
                }
                setConsolidating(false);
            };

            const handleSaveAndApprove = async () => {
                setSubmitting(true);
                try {
                    // Save edited refinement
                    await api(`/rest/v1/work_orders?id=eq.${workOrderId}`, {
                        method: 'PATCH',
                        headers: { 'Prefer': 'return=minimal' },
                        body: JSON.stringify({
                            name: editedName,
                            objective: editedObjective,
                            duplicate_check: null,
                            updated_at: new Date().toISOString(),
                        }),
                    });
                    // Re-approve (fresh duplicate check with refined scope)
                    await onApproveAnyway();
                    if (onRefresh) onRefresh();
                } catch (err) {
                    console.error('Save and approve failed:', err);
                    addToast('Save failed: ' + err.message, 'error');
                }
                setSubmitting(false);
                onClose();
            };

            const handleCancelWO = async () => {
                setSubmitting(true);
                try {
                    await api(`/rest/v1/work_orders?id=eq.${workOrderId}`, {
                        method: 'PATCH',
                        headers: { 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ status: 'cancelled', updated_at: new Date().toISOString() }),
                    });
                    addToast('Work order cancelled', 'info');
                    if (onRefresh) onRefresh();
                } catch (err) {
                    addToast('Cancel failed: ' + err.message, 'error');
                }
                setSubmitting(false);
                onClose();
            };

            // Consolidation result view
            if (consolidationResult) {
                const cr = consolidationResult;
                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '600px' }}>
                            <div className="modal-header">
                                <h2 className="modal-title">
                                    {cr.fully_covered ? 'Already Covered' : 'Refined Work Order'}
                                </h2>
                                <button className="modal-close" onClick={onClose}>x</button>
                            </div>
                            <div className="modal-body">
                                {/* Gap Analysis */}
                                <div style={{ padding: '10px 12px', background: cr.fully_covered ? 'rgba(52,211,153,0.08)' : 'rgba(212,165,116,0.08)', borderRadius: '6px', marginBottom: '16px', fontSize: '13px', borderLeft: `3px solid ${cr.fully_covered ? '#34D399' : 'var(--accent)'}` }}>
                                    <strong style={{ color: cr.fully_covered ? '#34D399' : 'var(--accent)' }}>Gap Analysis:</strong>
                                    <div style={{ color: 'var(--text-secondary)', marginTop: '4px' }}>{cr.gap_analysis}</div>
                                </div>

                                {cr.fully_covered ? (
                                    <p style={{ color: 'var(--text-secondary)', marginBottom: '12px' }}>
                                        Existing components already cover this work order's objective. You can cancel it.
                                    </p>
                                ) : (
                                    <>
                                        {/* Original vs Refined */}
                                        <div style={{ marginBottom: '12px' }}>
                                            <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '4px' }}>Original</div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-muted)', textDecoration: 'line-through', padding: '6px 8px', background: 'var(--bg-primary)', borderRadius: '4px' }}>
                                                {cr.original?.name}
                                            </div>
                                        </div>
                                        <div className="form-group" style={{ marginBottom: '12px' }}>
                                            <label className="form-label">Refined Name</label>
                                            <input
                                                className="form-input"
                                                value={editedName}
                                                onChange={e => setEditedName(e.target.value)}
                                            />
                                        </div>
                                        <div className="form-group" style={{ marginBottom: '12px' }}>
                                            <label className="form-label">Refined Objective</label>
                                            <textarea
                                                className="form-textarea"
                                                value={editedObjective}
                                                onChange={e => setEditedObjective(e.target.value)}
                                                rows={4}
                                                style={{ fontSize: '13px' }}
                                            />
                                        </div>
                                    </>
                                )}
                            </div>
                            <div className="modal-footer" style={{ gap: '8px' }}>
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Close</button>
                                {cr.fully_covered ? (
                                    <button type="button" className="btn" style={{ background: 'var(--status-blocked)', color: '#fff' }} disabled={submitting} onClick={handleCancelWO}>
                                        {submitting ? 'Cancelling...' : 'Cancel Work Order'}
                                    </button>
                                ) : (
                                    <button type="button" className="btn btn-primary" disabled={submitting || !editedName.trim()} onClick={handleSaveAndApprove}>
                                        {submitting ? 'Saving...' : 'Save & Approve'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Initial duplicate warning view
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '560px' }}>
                        <div className="modal-header">
                            <h2 className="modal-title">Potential Duplicates Found</h2>
                            <button className="modal-close" onClick={onClose}>x</button>
                        </div>
                        <div className="modal-body">
                            <p style={{ marginBottom: '12px', color: 'var(--text-secondary)' }}>
                                <strong>{workOrderName}</strong> may overlap with existing components:
                            </p>
                            <div style={{ maxHeight: '220px', overflowY: 'auto', marginBottom: '16px' }}>
                                {highMatches.map((d, i) => (
                                    <div key={i} style={{ padding: '8px 10px', marginBottom: '4px', background: 'var(--bg-primary)', borderRadius: '4px', fontSize: '13px' }}>
                                        <strong>{d.name}</strong> <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>({d.component_type || d.type || d.source})</span>
                                        <div style={{ color: 'var(--text-secondary)', marginTop: '2px', fontSize: '12px' }}>{d.recommendation}</div>
                                    </div>
                                ))}
                            </div>
                            <p style={{ color: 'var(--text-secondary)', fontSize: '13px', lineHeight: 1.5 }}>
                                <strong>Consolidate</strong> uses AI to refine this WO to only address what's actually missing.
                                <br /><strong>Approve Anyway</strong> proceeds without changes.
                            </p>
                        </div>
                        <div className="modal-footer" style={{ gap: '8px' }}>
                            <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                            <button type="button" className="btn" style={{ background: 'var(--accent)', color: 'var(--text-inverse)' }} disabled={consolidating} onClick={handleConsolidate}>
                                {consolidating ? 'Analyzing...' : 'Consolidate'}
                            </button>
                            <button type="button" className="btn btn-primary" disabled={submitting} onClick={handleApprove}>
                                {submitting ? 'Approving...' : 'Approve Anyway'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const RejectModal = ({ isOpen, onClose, onReject, workOrderName }) => {
            const [reason, setReason] = useState('');
            const [submitting, setSubmitting] = useState(false);

            // AC7: ESC key handler for modal dismissal
            useEffect(() => {
                if (!isOpen) return;
                const handleEsc = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [isOpen, onClose]);

            if (!isOpen) return null;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);
                await onReject(reason);
                setReason('');
                setSubmitting(false);
                onClose();
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '400px' }}>
                        <div className="modal-header">
                            <h2 className="modal-title">Reject Work Order</h2>
                            <button className="modal-close" onClick={onClose}></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                <p style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>
                                    Rejecting: <strong>{workOrderName}</strong>
                                </p>
                                <div className="form-group">
                                    <label className="form-label">Reason (optional)</label>
                                    <textarea
                                        className="form-textarea"
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        placeholder="Why is this being rejected?"
                                        rows={3}
                                    />
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary" disabled={submitting} style={{ background: 'var(--status-blocked)' }}>
                                    {submitting ? 'Rejecting...' : 'Reject'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const RollbackModal = ({ isOpen, onClose, onRollback, workOrderName }) => {
            const [reason, setReason] = useState('');
            const [submitting, setSubmitting] = useState(false);

            // AC7: ESC key handler for modal dismissal
            useEffect(() => {
                if (!isOpen) return;
                const handleEsc = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [isOpen, onClose]);

            if (!isOpen) return null;

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!reason.trim()) {
                    alert('Cancellation reason is required for administrative rollback');
                    return;
                }
                setSubmitting(true);
                await onRollback(reason);
                setReason('');
                setSubmitting(false);
                onClose();
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                        <div className="modal-header">
                            <h2 className="modal-title"> Administrative Rollback</h2>
                            <button className="modal-close" onClick={onClose}></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="modal-body">
                                <p style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>
                                    Rolling back completed work order: <strong>{workOrderName}</strong>
                                </p>
                                <p style={{ marginBottom: '16px', color: 'var(--status-blocked)', fontSize: '13px' }}>
                                    This will transition the work order from <strong>done  cancelled</strong>.
                                    The original completion data will be preserved and an audit log entry will be created.
                                </p>
                                <div className="form-group">
                                    <label className="form-label">Cancellation Reason (required) *</label>
                                    <textarea
                                        className="form-textarea"
                                        value={reason}
                                        onChange={(e) => setReason(e.target.value)}
                                        placeholder="Why is this completion being rolled back? (e.g., built without PRD, phantom completion, validation failure)"
                                        rows={4}
                                        required
                                    />
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn btn-primary" disabled={submitting || !reason.trim()} style={{ background: 'var(--status-blocked)' }}>
                                    {submitting ? 'Rolling back...' : 'Confirm Rollback'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Error Boundary for graceful error handling
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            height: '100vh',
                            background: 'var(--bg-primary)',
                            color: 'var(--text-primary)',
                            padding: '20px',
                            textAlign: 'center'
                        }}>
                            <h1 style={{ marginBottom: '16px', color: 'var(--status-blocked)' }}>Something went wrong</h1>
                            <p style={{ marginBottom: '24px', color: 'var(--text-secondary)' }}>
                                {this.state.error?.message || 'An unexpected error occurred'}
                            </p>
                            <button
                                className="btn btn-primary"
                                onClick={() => window.location.reload()}
                            >
                                Reload Page
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // ============================================
        // Main App
        // ============================================
        // ============================================
        // Projects View Component
        // ============================================
        const ProjectCard = ({ project, workOrders, onApproveAll }) => {
            const projectWOs = workOrders
                .filter(wo => wo.project_brief_id === project.id)
                .sort((a, b) => {
                    const seqA = a.client_info?.decomposition_sequence || 999;
                    const seqB = b.client_info?.decomposition_sequence || 999;
                    return seqA - seqB;
                });

            const completed = projectWOs.filter(wo => wo.status === 'done').length;
            const total = projectWOs.length;
            const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
            const drafts = projectWOs.filter(wo => wo.status === 'draft');

            return (
                <div className="project-card">
                    <div className="project-card-header">
                        <div className="project-card-title">{project.name}</div>
                        <div className="project-card-code">{project.code}</div>
                    </div>

                    {project.description && (
                        <div className="project-card-desc">{project.description}</div>
                    )}

                    {project.repo_url && (
                        <a href={project.repo_url.replace('.git', '').replace('git@github.com:', 'https://github.com/')}
                           target="_blank" rel="noopener" className="project-repo-link">
                             {project.repo_url.split('/').slice(-2).join('/').replace('.git', '')}
                        </a>
                    )}

                    {total > 0 && (
                        <div className="project-progress">
                            <div className="project-progress-bar">
                                <div className="project-progress-fill" style={{width: `${pct}%`}}></div>
                            </div>
                            <div className="project-progress-text">
                                <span>{completed}/{total} work orders complete</span>
                                <span>{pct}%</span>
                            </div>
                        </div>
                    )}

                    {projectWOs.length > 0 && (
                        <div className="project-wo-list">
                            {projectWOs.map(wo => {
                                const delivery = wo.client_info?.delivery;
                                const commitUrl = delivery?.commit_sha && project.repo_url
                                    ? `${project.repo_url.replace('.git', '').replace('git@github.com:', 'https://github.com/')}/commit/${delivery.commit_sha}`
                                    : null;

                                return (
                                    <div key={wo.id} className="project-wo-item">
                                        <div className={`project-wo-status ${wo.status}`}></div>
                                        <span className="project-wo-name" title={wo.name}>
                                            {wo.slug}: {wo.name}
                                        </span>
                                        {commitUrl && (
                                            <a href={commitUrl} target="_blank" rel="noopener" className="project-wo-commit">
                                                {delivery.commit_sha.slice(0, 7)}
                                            </a>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {drafts.length > 0 && (
                        <div className="project-actions">
                            <button
                                className="btn btn-primary"
                                onClick={() => onApproveAll(drafts)}
                                style={{fontSize: '12px', padding: '6px 12px'}}
                            >
                                Approve All ({drafts.length})
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const ProjectsView = ({ workOrders, onApproveAll, addToast }) => {
            const [projects, setProjects] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchProjects = async () => {
                    try {
                        const res = await api('/rest/v1/project_briefs?select=*&order=created_at.desc');
                        setProjects(res || []);
                    } catch (err) {
                        addToast('Failed to load projects', 'error');
                    } finally {
                        setLoading(false);
                    }
                };
                fetchProjects();
                const interval = setInterval(fetchProjects, 30000);
                return () => clearInterval(interval);
            }, []);

            if (loading) {
                return (
                    <div className="projects-container">
                        <div className="loading"><div className="spinner"></div></div>
                    </div>
                );
            }

            if (projects.length === 0) {
                return (
                    <div className="projects-container">
                        <div className="projects-empty">
                            <div className="projects-empty-title">No projects yet</div>
                            <div>Tell METIS to "build me something" in Chat to start a project.</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="projects-container">
                    <div className="projects-grid">
                        {projects.map(project => (
                            <ProjectCard
                                key={project.id}
                                project={project}
                                workOrders={workOrders}
                                onApproveAll={onApproveAll}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const [workOrders, setWorkOrders] = useState([]);
            const [agents, setAgents] = useState([]);
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [rejectModal, setRejectModal] = useState({ open: false, workOrderId: null, workOrderName: '' });
            const [rollbackModal, setRollbackModal] = useState({ open: false, workOrderId: null, workOrderName: '' });
            const [duplicateModal, setDuplicateModal] = useState({ open: false, workOrderId: null, workOrderName: '', duplicates: [] });
            const [expanded, setExpanded] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [actionLoading, setActionLoading] = useState({});
            const [activeView, setActiveView] = useState('kanban');
            const [watchingWO, setWatchingWO] = useState(null);
            const [showArchived, setShowArchived] = useState(false);
            const [staleThreshold, setStaleThreshold] = useState(30);
            const [searchTerm, setSearchTerm] = useState('');

            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            const fetchData = useCallback(async () => {
                // Retry helper with exponential backoff
                const retryWithBackoff = async (fn, resourceName, maxRetries = 3) => {
                    for (let attempt = 1; attempt <= maxRetries; attempt++) {
                        try {
                            return await fn();
                        } catch (err) {
                            const isLastAttempt = attempt === maxRetries;
                            const isTransient = err.message?.includes('503') ||
                                              err.message?.includes('timeout') ||
                                              err.message?.includes('FetchError') ||
                                              err.status === 503;

                            if (isLastAttempt || !isTransient) {
                                const errorCode = err.code || err.status || 'UNKNOWN';
                                const errorMsg = err.message || 'Network error';
                                throw new Error(`${errorCode}: ${errorMsg}`);
                            }

                            // Exponential backoff: 500ms, 1s, 2s
                            const delay = 500 * Math.pow(2, attempt - 1);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                };

                try {
                    // Fetch stale threshold preference (non-critical, fail silently)
                    const prefRes = await api('/rest/v1/user_preferences?select=value&key=eq.stale_wo_threshold_days').catch(() => []);
                    const threshold = prefRes?.[0]?.value || 30;
                    setStaleThreshold(threshold);

                    // Fetch each resource individually with retry logic
                    const [woResult, agentsResult, eventsResult] = await Promise.allSettled([
                        retryWithBackoff(
                            () => api('/rest/v1/work_orders?select=*&order=created_at.desc'),
                            'work orders'
                        ),
                        retryWithBackoff(
                            () => api('/rest/v1/agents?select=*&order=name.asc'),
                            'agents'
                        ),
                        retryWithBackoff(
                            () => workspaceApi('get_events', { limit: 30 }),
                            'events'
                        )
                    ]);

                    // Process work orders
                    if (woResult.status === 'fulfilled') {
                        const woRes = woResult.value;
                        const staleDate = new Date();
                        staleDate.setDate(staleDate.getDate() - threshold);

                        let filteredWOs = woRes;
                        if (!showArchived) {
                            filteredWOs = woRes.filter(wo => {
                                const updatedAt = new Date(wo.updated_at || wo.created_at);
                                return updatedAt >= staleDate || wo.status === 'in_progress';
                            });

                            // Log audit event for stale filter
                            if (woRes.length !== filteredWOs.length) {
                                await api('/rest/v1/audit_log', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        action: 'workspace_stale_filter',
                                        event_type: 'workspace_stale_filter',
                                        actor_type: 'system',
                                        payload: {
                                            threshold_days: threshold,
                                            filtered_count: woRes.length - filteredWOs.length
                                        }
                                    })
                                }).catch(() => {});
                            }
                        }
                        setWorkOrders(filteredWOs);
                    } else {
                        addToast(`Failed to load work orders: ${woResult.reason.message}`, 'error');
                        setWorkOrders([]); // Show empty instead of leaving stale data
                    }

                    // Process agents
                    if (agentsResult.status === 'fulfilled') {
                        setAgents(agentsResult.value);
                    } else {
                        addToast(`Failed to load agents: ${agentsResult.reason.message}`, 'error');
                        setAgents([]); // Show empty instead of leaving stale data
                    }

                    // Process events
                    if (eventsResult.status === 'fulfilled') {
                        setEvents(eventsResult.value.events || []);
                    } else {
                        addToast(`Failed to load events: ${eventsResult.reason.message}`, 'error');
                        setEvents([]); // Show empty instead of leaving stale data
                    }

                } catch (err) {
                    // This should only catch unexpected errors, not the specific fetch failures above
                    addToast(`Unexpected error: ${err.message || 'Unknown error'}`, 'error');
                } finally {
                    setLoading(false);
                }
            }, [showArchived]);

            useEffect(() => {
                fetchData();
                const dataInterval = setInterval(fetchData, 30000);
                const timeInterval = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => {
                    clearInterval(dataInterval);
                    clearInterval(timeInterval);
                };
            }, [fetchData]);

            // Mobile detection - show info toast
            useEffect(() => {
                const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                const isMobile = window.innerWidth <= 768;
                if (isTouchDevice && isMobile) {
                    addToast('Drag-drop requires a mouse. Use action buttons to move items.', 'info');
                }
            }, []);

            const handleDrop = async (workOrderId, newStatus) => {
                const wo = workOrders.find(w => w.id === workOrderId);
                if (!wo || wo.status === newStatus) return;

                // Route draftready through approve endpoint (duplicate check, auto-assign)
                if (wo.status === 'draft' && newStatus === 'ready') {
                    handleApprove(workOrderId);
                    return;
                }

                // Route reviewdone through accept endpoint
                if (wo.status === 'review' && newStatus === 'done') {
                    handleAccept(workOrderId);
                    return;
                }

                // Optimistic update
                setWorkOrders(prev => prev.map(w =>
                    w.id === workOrderId ? { ...w, status: newStatus } : w
                ));

                try {
                    // Route through enforcement RPC  never bypass state machine
                    const params = { p_work_order_id: workOrderId, p_status: newStatus };
                    if (newStatus === 'done') params.p_completed_at = new Date().toISOString();
                    if (newStatus === 'in_progress') params.p_started_at = new Date().toISOString();

                    const result = await api('/rest/v1/rpc/update_work_order_state', {
                        method: 'POST',
                        body: JSON.stringify(params),
                    });
                    if (result && result.error) {
                        throw new Error(Array.isArray(result.errors) ? result.errors.join(', ') : 'Transition rejected by state machine');
                    }
                    addToast(`Moved to ${COLUMNS.find(c => c.id === newStatus)?.name}`, 'success');
                } catch (err) {
                    // Rollback
                    setWorkOrders(prev => prev.map(w =>
                        w.id === workOrderId ? wo : w
                    ));
                    addToast(`Move failed: ${err.message || 'Invalid transition'}`, 'error');
                }
            };

            const handleApprove = async (workOrderId, acknowledgeDuplicates = false) => {
                if (actionLoading[workOrderId]) return;
                setActionLoading(prev => ({ ...prev, [workOrderId]: 'approve' }));
                try {
                    const res = await fetch(`${SUPABASE_URL}/functions/v1/work-order-executor/approve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        },
                        body: JSON.stringify({ work_order_id: workOrderId, approved_by: 'user', acknowledge_duplicates: acknowledgeDuplicates }),
                    });
                    const data = await res.json();
                    if (res.status === 409 && data.blocked_by === 'duplicate_check') {
                        const wo = workOrders.find(w => w.id === workOrderId);
                        setDuplicateModal({ open: true, workOrderId, workOrderName: wo?.name || 'Unknown', duplicates: data.duplicates || [] });
                        return;
                    }
                    if (!res.ok) {
                        // AC6: Display structured error codes
                        const errorMsg = data.error_code
                            ? `[${data.error_code}] ${data.error || data.message || 'Approval failed'}`
                            : (data.error || `Approval failed (${res.status})`);
                        addToast(errorMsg, 'error');
                        return;
                    }
                    if (data.approved) {
                        setWorkOrders(prev => prev.map(w =>
                            w.id === workOrderId ? { ...w, status: 'ready', approved_at: new Date().toISOString() } : w
                        ));
                        addToast('Work order approved - ready for execution', 'success');
                    } else {
                        // AC6: Display structured error codes
                        const errorMsg = data.error_code
                            ? `[${data.error_code}] ${data.error || data.message || 'Approval failed'}`
                            : (data.error || data.message || 'Approval failed');
                        addToast(errorMsg, 'error');
                    }
                } catch (err) {
                    addToast('Failed to approve: ' + err.message, 'error');
                } finally {
                    setActionLoading(prev => ({ ...prev, [workOrderId]: null }));
                }
            };

            const handleAccept = async (workOrderId) => {
                if (actionLoading[workOrderId]) return;
                setActionLoading(prev => ({ ...prev, [workOrderId]: 'accept' }));
                try {
                    const res = await fetch(`${SUPABASE_URL}/functions/v1/work-order-executor/accept`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        },
                        body: JSON.stringify({ work_order_id: workOrderId }),
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        // AC6: Display structured error codes
                        const errorMsg = data.error_code
                            ? `[${data.error_code}] ${data.error || data.message || 'Accept failed'}`
                            : (data.error || `Accept failed (${res.status})`);
                        addToast(errorMsg, 'error');
                        return;
                    }
                    if (data.accepted) {
                        setWorkOrders(prev => prev.map(w =>
                            w.id === workOrderId ? { ...w, status: 'done' } : w
                        ));
                        addToast(data.already_done ? 'Already accepted' : 'Work accepted - marked as done', 'success');
                    } else {
                        // AC6: Display structured error codes
                        const errorMsg = data.error_code
                            ? `[${data.error_code}] ${data.error || data.message || 'Accept failed'}`
                            : (data.error || 'Accept failed');
                        addToast(errorMsg, 'error');
                    }
                } catch (err) {
                    addToast('Failed to accept: ' + err.message, 'error');
                } finally {
                    setActionLoading(prev => ({ ...prev, [workOrderId]: null }));
                }
            };

            const openRejectModal = (workOrderId) => {
                const wo = workOrders.find(w => w.id === workOrderId);
                setRejectModal({ open: true, workOrderId, workOrderName: wo?.name || 'Unknown' });
            };

            const handleReject = async (reason) => {
                const workOrderId = rejectModal.workOrderId;
                setActionLoading(prev => ({ ...prev, [workOrderId]: 'reject' }));
                try {
                    const res = await fetch(`${SUPABASE_URL}/functions/v1/work-order-executor/reject`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        },
                        body: JSON.stringify({ work_order_id: workOrderId, reason }),
                    });
                    const data = await res.json();
                    if (data.rejected) {
                        setWorkOrders(prev => prev.map(w =>
                            w.id === workOrderId ? { ...w, status: 'draft', approved_at: null } : w
                        ));
                        addToast('Work rejected - back to draft', 'warning');
                    } else {
                        addToast(data.error || 'Reject failed', 'error');
                    }
                } catch (err) {
                    addToast('Failed to reject: ' + err.message, 'error');
                } finally {
                    setActionLoading(prev => ({ ...prev, [workOrderId]: null }));
                }
            };

            const openRollbackModal = (workOrderId) => {
                const wo = workOrders.find(w => w.id === workOrderId);
                setRollbackModal({ open: true, workOrderId, workOrderName: wo?.name || 'Unknown' });
            };

            const handleCancel = async (workOrderId) => {
                const wo = workOrders.find(w => w.id === workOrderId);
                if (!confirm(`Cancel work order "${wo?.name}"? This action cannot be undone.`)) {
                    return;
                }

                setActionLoading(prev => ({ ...prev, [workOrderId]: 'cancel' }));
                try {
                    const result = await api('/rest/v1/rpc/update_work_order_state', {
                        method: 'POST',
                        body: JSON.stringify({
                            p_work_order_id: workOrderId,
                            p_status: 'cancelled'
                        }),
                    });

                    if (result && result.error) {
                        throw new Error(result.error);
                    }

                    // Update local state
                    setWorkOrders(prev => prev.map(w =>
                        w.id === workOrderId ? { ...w, status: 'cancelled' } : w
                    ));
                    addToast('Work order cancelled', 'success');
                    fetchData(); // Refresh to apply filter if needed
                } catch (err) {
                    addToast('Failed to cancel: ' + err.message, 'error');
                } finally {
                    setActionLoading(prev => ({ ...prev, [workOrderId]: null }));
                }
            };

            const handleRetry = async (workOrderId) => {
                const wo = workOrders.find(w => w.id === workOrderId);
                if (!confirm(`Retry "${wo?.name}"? This will reset it to draft for re-approval and re-execution.`)) {
                    return;
                }

                setActionLoading(prev => ({ ...prev, [workOrderId]: 'retry' }));
                try {
                    // Use RPC to transition failed  draft (valid in state machine, sets bypass)
                    await api('/rest/v1/rpc/update_work_order_state', {
                        method: 'POST',
                        body: JSON.stringify({
                            p_work_order_id: workOrderId,
                            p_status: 'draft',
                            p_summary: 'Retry requested from portal  reset to draft for re-execution'
                        }),
                    });

                    // Clean up escalation tags + reset metadata (non-protected columns)
                    await api('/rest/v1/work_orders?id=eq.' + workOrderId, {
                        method: 'PATCH',
                        headers: { 'Prefer': 'return=minimal' },
                        body: JSON.stringify({
                            tags: (wo?.tags || []).filter(t => t !== 'escalation:ilmarinen' && t !== 'circuit-breaker-tripped'),
                            verification_status: 'unverified',
                            qa_checklist: null
                        }),
                    });

                    setWorkOrders(prev => prev.map(w =>
                        w.id === workOrderId ? { ...w, status: 'draft', tags: (w.tags || []).filter(t => t !== 'escalation:ilmarinen') } : w
                    ));
                    addToast('Work order reset to draft  approve to re-execute', 'success');
                    fetchData();
                } catch (err) {
                    addToast('Failed to retry: ' + err.message, 'error');
                } finally {
                    setActionLoading(prev => ({ ...prev, [workOrderId]: null }));
                }
            };

            const handleRollback = async (reason) => {
                const workOrderId = rollbackModal.workOrderId;
                setActionLoading(prev => ({ ...prev, [workOrderId]: 'rollback' }));
                try {
                    const res = await fetch(`${SUPABASE_URL}/functions/v1/work-order-executor/rollback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        },
                        body: JSON.stringify({ work_order_id: workOrderId, reason }),
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        addToast(data.error || `Rollback failed (${res.status})`, 'error');
                        return;
                    }
                    if (data.rolled_back) {
                        setWorkOrders(prev => prev.map(w =>
                            w.id === workOrderId ? { ...w, status: 'cancelled' } : w
                        ));
                        addToast('Work order rolled back - done  cancelled', 'success');
                    } else {
                        addToast(data.error || 'Rollback failed', 'error');
                    }
                } catch (err) {
                    addToast('Failed to rollback: ' + err.message, 'error');
                } finally {
                    setActionLoading(prev => ({ ...prev, [workOrderId]: null }));
                }
            };

            const handleCreate = async (form) => {
                if (!form.name || !form.objective) {
                    addToast('Name and objective are required', 'error');
                    return;
                }
                
                const slug = `WO-${Date.now().toString(36).toUpperCase()}`;
                const data = {
                    slug,
                    name: form.name,
                    objective: form.objective,
                    priority: form.priority || 'p2_medium',
                    assigned_to: form.assigned_to || null,
                    acceptance_criteria: form.acceptance_criteria || null,
                    status: 'draft',
                    created_by: 'metis',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                };

                try {
                    await api('/rest/v1/work_orders', {
                        method: 'POST',
                        headers: { 'Prefer': 'return=minimal' },
                        body: JSON.stringify(data),
                    });
                    addToast('Work order created', 'success');
                    fetchData();
                } catch (err) {
                    console.error('Create error:', err);
                    addToast('Failed to create work order: ' + err.message, 'error');
                }
            };

            const handleApproveAll = async (drafts) => {
                let approved = 0;
                for (const wo of drafts) {
                    try {
                        await api('/rest/v1/rpc/update_work_order_state', {
                            method: 'POST',
                            body: JSON.stringify({
                                p_work_order_id: wo.id,
                                p_new_status: 'ready',
                                p_actor: 'metis',
                                p_reason: 'Batch approved from Projects view'
                            }),
                        });
                        approved++;
                    } catch (err) {
                        console.error(`Failed to approve ${wo.slug}:`, err);
                    }
                }
                addToast(`Approved ${approved}/${drafts.length} work orders`, approved === drafts.length ? 'success' : 'warning');
                fetchData();
            };

            const workOrdersByStatus = useMemo(() => {
                const statusPriority = { 'in_progress': 1, 'ready': 2, 'draft': 3, 'review': 4, 'failed': 5, 'done': 6, 'cancelled': 7 };

                // Filter by search term
                const searchFiltered = searchTerm.trim() === ''
                    ? workOrders
                    : workOrders.filter(wo => {
                        const term = searchTerm.toLowerCase();
                        return (
                            wo.slug?.toLowerCase().includes(term) ||
                            wo.name?.toLowerCase().includes(term) ||
                            wo.summary?.toLowerCase().includes(term)
                        );
                    });

                // Filter archived WOs unless showArchived is enabled
                const archivedFiltered = showArchived
                    ? searchFiltered
                    : searchFiltered.filter(wo => {
                        // Keep if not a terminal status
                        if (!['done', 'cancelled', 'failed'].includes(wo.status)) return true;

                        // For failed WOs, keep only if escalated
                        if (wo.status === 'failed') {
                            const hasEscalationTag = wo.tags?.some(tag => tag.startsWith('escalation:'));
                            return hasEscalationTag;
                        }

                        // Hide done and cancelled
                        return false;
                    });

                return COLUMNS.reduce((acc, col) => {
                    const filtered = archivedFiltered.filter(wo => wo.status === col.id);
                    // Sort by created_at DESC (newest first)
                    acc[col.id] = filtered.sort((a, b) => {
                        const aDate = new Date(a.created_at);
                        const bDate = new Date(b.created_at);
                        return bDate - aDate;
                    });
                    return acc;
                }, {});
            }, [workOrders, searchTerm, showArchived]);

            const activeAgents = agents.filter(a => a.status === 'active').length;
            const totalTasks = workOrders.length;

            if (loading) {
                return (
                    <div className="app">
                        <div className="loading">
                            <div className="spinner"></div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app">
                    {/* Header */}
                    <header className="header">
                        <div className="header-left">
                            <div className="logo">
                                <div className="logo-icon">E</div>
                                <span>Endgame Workspace</span>
                            </div>
                            <div className="stats">
                                <div className="stat">
                                    <div className="stat-value">{activeAgents}</div>
                                    <div className="stat-label">Agents Active</div>
                                </div>
                                <div className="stat">
                                    <div className="stat-value">{totalTasks}</div>
                                    <div className="stat-label">Tasks in Queue</div>
                                </div>
                            </div>
                        </div>
                        <div className="header-right">
                            <div className="header-time">
                                <div className="header-time-value">{formatTime(currentTime)}</div>
                                <div className="header-time-date">{formatDate(currentTime)}</div>
                            </div>
                            <div className="status-badge">
                                <span className="status-dot"></span>
                                Online
                            </div>
                        </div>
                    </header>

                    <main className="main">
                        {/* Agents Sidebar */}
                        <aside className="sidebar">
                            <div className="sidebar-header">
                                <span className="sidebar-title">Agents</span>
                                <span className="sidebar-count">{agents.length}</span>
                            </div>
                            <div className="agents-list">
                                {agents.map(agent => (
                                    <AgentItem key={agent.id} agent={agent} />
                                ))}
                            </div>
                        </aside>

                        {/* Main Content Area */}
                        <section className="board-container">
                            <div className="board-header">
                                <div style={{display:'flex',alignItems:'center',gap:'16px'}}>
                                    <span className="board-title">{activeView === 'kanban' ? 'Mission Queue' : 'Projects'}</span>
                                    <div className="view-toggle">
                                        <button className={`view-toggle-btn ${activeView === 'kanban' ? 'active' : ''}`}
                                                onClick={() => setActiveView('kanban')}>Kanban</button>
                                        <button className={`view-toggle-btn ${activeView === 'projects' ? 'active' : ''}`}
                                                onClick={() => setActiveView('projects')}>Projects</button>
                                    </div>
                                    <input
                                        type="text"
                                        placeholder="Search WOs (slug, name, summary)..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        style={{
                                            padding: '8px 12px',
                                            borderRadius: '6px',
                                            border: '1px solid var(--border-default)',
                                            background: 'var(--bg-surface)',
                                            color: 'var(--text-primary)',
                                            fontSize: '13px',
                                            width: '280px',
                                            fontFamily: 'inherit'
                                        }}
                                    />
                                </div>
                                <div className="board-actions">
                                    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 12px', cursor: 'pointer', borderRadius: '6px', background: 'var(--bg-surface)', marginRight: '8px' }}>
                                        <input
                                            type="checkbox"
                                            checked={showArchived}
                                            onChange={(e) => setShowArchived(e.target.checked)}
                                            style={{ cursor: 'pointer' }}
                                        />
                                        <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                                            Show archived (done/cancelled)
                                        </span>
                                    </label>
                                    <button className="btn btn-secondary" onClick={fetchData}>
                                         Refresh
                                    </button>
                                    {activeView === 'kanban' && (
                                        <button className="btn btn-primary" onClick={() => setShowModal(true)}>
                                            + New Task
                                        </button>
                                    )}
                                </div>
                            </div>

                            {activeView === 'kanban' ? (
                                <div className="board">
                                    {COLUMNS.map(column => (
                                        <KanbanColumn
                                            key={column.id}
                                            column={column}
                                            workOrders={workOrdersByStatus[column.id] || []}
                                            agents={agents}
                                            onDrop={handleDrop}
                                            onStatusChange={handleDrop}
                                            onExpand={setExpanded}
                                            onApprove={handleApprove}
                                            onAccept={handleAccept}
                                            onReject={openRejectModal}
                                            onRollback={openRollbackModal}
                                            onWatch={setWatchingWO}
                                            onCancel={handleCancel}
                                            onRetry={handleRetry}
                                            expanded={expanded}
                                            actionLoading={actionLoading}
                                            staleThreshold={staleThreshold}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <ProjectsView
                                    workOrders={workOrders}
                                    onApproveAll={handleApproveAll}
                                    addToast={addToast}
                                />
                            )}
                        </section>

                        {/* Live Feed Sidebar */}
                        <aside className="feed-sidebar">
                            <div className="feed-header">
                                <div className="feed-title">Live Feed</div>
                            </div>
                            <div className="feed-content">
                                <div className="feed-section">
                                    <div className="feed-section-title">All Agents</div>
                                    <div className="agent-chips">
                                        {agents.map(agent => {
                                            const count = workOrders.filter(wo => wo.assigned_to === agent.id).length;
                                            return (
                                                <div key={agent.id} className="agent-chip">
                                                    <div className={`agent-chip-avatar ${agent.name}`}>
                                                        {getInitials(agent.name)}
                                                    </div>
                                                    <span>{agent.name}</span>
                                                    <span className="agent-chip-count">{count}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="feed-events">
                                    {events.length === 0 ? (
                                        <div className="empty-state">
                                            <span className="empty-state-text">No recent activity</span>
                                        </div>
                                    ) : (
                                        events.map(event => (
                                            <EventItem key={event.id} event={event} agents={agents} />
                                        ))
                                    )}
                                </div>
                            </div>
                        </aside>
                    </main>

                    {/* Create Modal */}
                    <CreateModal
                        isOpen={showModal}
                        onClose={() => setShowModal(false)}
                        onCreate={handleCreate}
                        agents={agents}
                    />

                    {/* Duplicate Warning Modal */}
                    <DuplicateWarningModal
                        isOpen={duplicateModal.open}
                        onClose={() => setDuplicateModal({ open: false, workOrderId: null, workOrderName: '', duplicates: [] })}
                        onApproveAnyway={() => handleApprove(duplicateModal.workOrderId, true)}
                        workOrderId={duplicateModal.workOrderId}
                        workOrderName={duplicateModal.workOrderName}
                        duplicates={duplicateModal.duplicates}
                        onRefresh={fetchData}
                        addToast={addToast}
                    />

                    {/* Reject Modal */}
                    <RejectModal
                        isOpen={rejectModal.open}
                        onClose={() => setRejectModal({ open: false, workOrderId: null, workOrderName: '' })}
                        onReject={handleReject}
                        workOrderName={rejectModal.workOrderName}
                    />

                    {/* Rollback Modal */}
                    <RollbackModal
                        isOpen={rollbackModal.open}
                        onClose={() => setRollbackModal({ open: false, workOrderId: null, workOrderName: '' })}
                        onRollback={handleRollback}
                        workOrderName={rollbackModal.workOrderName}
                    />

                    {/* Toasts */}
                    <div className="toast-container">
                        {toasts.map(toast => (
                            <Toast
                                key={toast.id}
                                message={toast.message}
                                type={toast.type}
                                onClose={() => removeToast(toast.id)}
                            />
                        ))}
                    </div>

                    {watchingWO && (
                        <LiveLogPanel
                            workOrder={watchingWO}
                            onClose={() => setWatchingWO(null)}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
