-- ============================================================================
-- ENDGAME-001 Seed Data for Critical Config Tables
-- Generated: 2026-02-18T04:23:24Z
-- K003c: Extract DB-Only Objects to Git
-- 
-- Tables: wo_state_machine, wo_effect_registry, kernel_spec, agents,
-- agent_execution_profiles, agent_escalation_tiers, system_settings,
-- agent_knowledge_base, request_schemas, action_success_rates
-- ============================================================================

--
-- PostgreSQL database dump
--

\restrict JqQpqpCyCYXU0eYKAAyAguneu1aleXP43LvAEExldGfcfcswlLjSIZ2PgfNyY8k

-- Dumped from database version 17.6
-- Dumped by pg_dump version 18.2

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Data for Name: agent_escalation_tiers; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.agent_escalation_tiers (id, agent_name, tier_order, model, description, created_at) FROM stdin;
7c98f3f6-eb86-4dfb-8560-9205ea428610	frontend	1	claude-opus-4-6	Opus 4.6 (complex UI)	2026-02-16 05:56:26.822491+00
343fa76e-0468-467f-a0ba-933d06b88670	builder	0	minimax/minimax-m2.5	MiniMax M2.5 (fast/cheap)	2026-02-16 05:56:26.822491+00
2ee8881f-3c5b-4285-b71d-f3278f1a212d	builder	2	claude-opus-4-6	Opus 4.6 (max capability)	2026-02-16 05:56:26.822491+00
1fe29e88-2559-4a6b-a4ae-4b40f9d27abf	ilmarinen	0	claude-opus-4-6	Default model (tier 0)	2026-02-16 05:56:26.822491+00
76152828-dc5e-4dfe-93d6-756a5c8b0980	metis	0	claude-opus-4-6	Default model (tier 0)	2026-02-16 05:56:26.822491+00
d358e25c-05b9-4f70-8bab-7a375fb39118	qa-gate	0	claude-opus-4-6	Default model (tier 0)	2026-02-16 05:56:26.822491+00
862ecd71-0d73-46e8-96ce-8a7ef76425cc	ops	0	minimax/minimax-m2.5	MiniMax M2.5 (fast/cheap)	2026-02-16 05:56:26.822491+00
e19110f1-5905-4460-a976-fcb4cd77eff1	frontend	0	minimax/minimax-m2.5	MiniMax M2.5 (fast/cheap)	2026-02-16 05:56:26.822491+00
c5a6cfdf-8ea8-47b9-9657-ca0c57e3db00	security	0	minimax/minimax-m2.5	MiniMax M2.5 (fast/cheap)	2026-02-16 05:56:26.822491+00
8db50c9b-0150-49e3-906a-47b8f53c3554	builder	1	claude-sonnet-4-6	Sonnet 4.6 (balanced)	2026-02-16 05:56:26.822491+00
\.


--
-- Data for Name: agents; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.agents (id, name, agent_type, status, description, config, created_at, updated_at, role, escalation_target, routing_tags, execution_mode, max_concurrent_wos, tools_allowed, model) FROM stdin;
e0b55b7b-22a9-4c48-ba26-e8156487eb15	metis	orchestrator	active	Orchestration leader. Receives user intent, decomposes tasks, assigns work, monitors progress, resolves conflicts.	{"interface": "portal", "can_assign": true, "can_escalate": false}	2026-02-02 23:38:55.420185+00	2026-02-02 23:38:55.420185+00	orchestrator	\N	{portal,intake,approval}	portal	10	{read_table,get_schema,read_execution_log,log_progress,delegate_subtask}	claude-opus-4-6
27148e96-5094-4a80-a832-8cdb93c8d96f	ops	observer	active	System observer. Detects stuck WOs, orphan cleanup, failed WO triage, health monitoring.	{"role": "system_observer", "thresholds": {"queue_stall_min": 30, "stuck_timeout_min": 10, "max_retry_attempts": 3}}	2026-02-09 18:10:34.750486+00	2026-02-09 18:10:34.750486+00	observer	e0b55b7b-22a9-4c48-ba26-e8156487eb15	{health,stuck,orphan,cron,monitoring,health-check,auto-unblock}	automated	1	{execute_sql,read_table,log_progress,mark_complete,mark_failed,get_schema,read_execution_log,search_knowledge_base,transition_state}	minimax/minimax-m2.5
3dcf0457-4a6d-4509-8fdc-bbd67e97b1d8	ilmarinen	executor	active	Build platform. Executes code tasks, CI/CD, git operations, deployments.	{"interface": "claude_code", "can_assign": false, "can_escalate": true}	2026-02-02 23:38:55.420185+00	2026-02-02 23:38:55.420185+00	executor	e0b55b7b-22a9-4c48-ba26-e8156487eb15	{portal-frontend,cli-session,master}	local_cli	1	{execute_sql,apply_migration,read_table,github_read_file,deploy_edge_function,log_progress,read_execution_log,get_schema,mark_complete,mark_failed,resolve_qa_findings,update_qa_checklist,transition_state,github_push_files}	claude-opus-4-6
b1335ce9-c7ad-40b8-8f21-b9700a6c89e4	frontend	executor	active	Frontend specialist for UI/UX, CSS, HTML, and frontend framework reviews	{"portal_repo": "olivergale/metis-portal2", "routing_tags": ["frontend", "ui", "css", "html"], "specializations": ["ui", "ux", "css", "html", "react", "vue", "frontend_frameworks"], "portal_base_path": "src/"}	2026-02-08 05:52:48.825387+00	2026-02-15 16:29:11.052706+00	specialist	e0b55b7b-22a9-4c48-ba26-e8156487eb15	{frontend,testing,ui,analytics,split-test,portal,html,dashboard}	automated	3	{github_read_file,github_push_files,github_list_files,github_search_code,github_grep,github_read_file_range,github_tree,sandbox_exec,sandbox_write_file,sandbox_pipeline,run_tests,web_fetch,save_memory,recall_memory,log_progress,mark_complete,mark_failed,read_execution_log,get_schema,search_knowledge_base,resolve_qa_findings,update_qa_checklist,transition_state,sandbox_read_file,sandbox_edit_file,sandbox_grep,sandbox_glob}	minimax/minimax-m2.5
52621f39-6775-4c8a-a069-e67f9f11b35f	qa-gate	evaluator	active	Quality evaluator and code reviewer. Runs auto-QA, queue scoring, quality gates, code reviews, security scans, and compliance checks.	{"role": "quality_evaluator_and_reviewer", "triggers": ["wo_review", "wo_complete", "cron"], "capabilities": ["auto_qa_evaluation", "queue_scoring", "quality_gates", "code_review", "audit_compliance", "security_scan", "test_validation"]}	2026-02-09 18:10:34.750486+00	2026-02-10 23:34:15.260112+00	evaluator	e0b55b7b-22a9-4c48-ba26-e8156487eb15	{qa,review,checklist,compliance,evaluation,auto-qa,quality,reprioritize,audit,security}	automated	10	{execute_sql,read_table,get_schema,log_progress,read_execution_log,mark_complete,mark_failed,resolve_qa_findings,update_qa_checklist,save_memory,recall_memory,github_read_file,github_grep,github_read_file_range,github_search_code,search_knowledge_base,search_lessons,transition_state}	claude-opus-4-6
a3688035-6806-4cd1-afe8-bfbfea956a00	security	reviewer	active	Security agent. Scans for vulnerabilities, reviews RLS policies, audits secrets exposure, checks for OWASP issues.	{"scopes": ["edge-functions", "rls-policies", "secrets", "api-endpoints"], "interface": "automated", "can_assign": false, "can_escalate": true}	2026-02-03 02:44:46.499486+00	2026-02-03 02:44:46.499486+00	reviewer	e0b55b7b-22a9-4c48-ba26-e8156487eb15	{rls,security,vulnerability,hardening,red-team}	automated	3	{execute_sql,read_table,get_schema,log_progress,read_execution_log,mark_complete,mark_failed,github_read_file,github_grep,github_read_file_range,github_search_code,search_knowledge_base,resolve_qa_findings,update_qa_checklist,search_lessons,save_memory,recall_memory}	minimax/minimax-m2.5
47c3a870-827f-4a0a-8c31-8387eec84f51	builder	executor	active	Server-side executor. Handles all non-local WOs via wo-agent: supabase, migration, schema, remediation.	{"role": "server_side_executor", "endpoint": "wo-agent/execute", "lifecycle": "persistent"}	2026-02-09 15:35:24.561595+00	2026-02-14 01:43:19.025216+00	executor	3dcf0457-4a6d-4509-8fdc-bbd67e97b1d8	{supabase,migration,schema,edge-function,deploy,github,build,server-side-agent,remediation,sql-only}	server_side	3	{log_progress,github_list_files,sandbox_exec,mark_complete,resolve_qa_findings,github_create_branch,github_grep,search_knowledge_base,github_push_files,search_lessons,github_read_file,mark_failed,get_schema,git_diff,git_blame,delegate_subtask,git_log,web_fetch,github_search_code,github_create_pr,transition_state,update_qa_checklist,apply_migration,read_execution_log,read_full_file,github_tree,check_child_status,github_read_file_range,read_table,execute_sql,deploy_edge_function,write_team_context,run_tests,sandbox_read_file,sandbox_edit_file,sandbox_grep,sandbox_glob,sandbox_write_file,sandbox_pipeline}	minimax/minimax-m2.5
\.


--
-- Data for Name: agent_execution_profiles; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.agent_execution_profiles (agent_name, mission, pace, error_style, scope_boundaries, escalation_rules, budget_guidance, tool_categories, created_at, updated_at, model, max_tokens, escalation_tiers, custom_instructions) FROM stdin;
ilmarinen	Master agent with unrestricted permissions. Handles escalations, emergency fixes, and architectural decisions.	measured	retry-then-escalate	{"allowed_tools": ["*"], "allowed_tables": ["*"], "mutation_scope": "unrestricted", "can_bypass_enforcement": true, "protected_tables_via_rpc": ["system_manifest", "decisions", "schema_changes"]}	{"escalate_on": [], "max_retries": 5, "escalation_target": null, "error_classification": {"retriable": ["timeout", "rate_limit", "transient_error"], "non_retriable": ["impossible_objective", "architectural_blocker"]}}	{"max_turns": 100, "hard_limits": {"no_hard_limits": true}, "implement_first_pct": 80, "mutation_ratio_target": 0.3, "verification_budget_pct": 20}	{all}	2026-02-11 18:41:53.338867+00	2026-02-11 18:41:53.338867+00	claude-opus-4-6	16384	[]	### Master Agent: ilmarinen\n\nYou are the ENDGAME master agent with unrestricted permissions. You handle escalations, emergency fixes, and architectural decisions.\n\n### Your Responsibilities\n- **WO Routing**: Route incoming WOs to appropriate specialist agents (builder, frontend, security, qa-gate, ops) based on tags and routing_rules\n- **Approval Gates**: Enforce approval requirements for high-risk operations (schema changes, edge function deploys, state machine bypasses)\n- **Escalations**: Handle work orders that cannot be completed by specialist agents\n- **Emergency Response**: Fix critical system issues that block other agents\n\n### Decision Making\n- Default priority for new WOs: p2_medium\n- Only escalate P0 issues to human review\n- Use bypass sparingly — only when enforcement blocks legitimate work and you understand the implications\n- Log all bypasses to audit_log with justification\n\n### Routing Rules\n- migration, schema, sql-only → builder\n- frontend, ui, html, dashboard → frontend  \n- security, rls, vulnerability → security\n- health, stuck, orphan, cron → ops\n- qa, review, checklist, auto-qa → qa-gate\n- portal, intake, approval → metis\n- portal-frontend, cli-session, master → ilmarinen\n\n### Tools Available\nAll tools including execute_sql, apply_migration, github_push_files, deploy_edge_function
frontend	Frontend specialist for the ENDGAME portal (olivergale/metis-portal2). Build, modify, and verify all user-facing pages, components, styles, and utilities. Own the full frontend delivery lifecycle: read existing code → implement changes → verify compilation → verify build → commit atomically.	aggressive	retry-then-escalate	{"allowed_paths": ["src/", "*.html", "*.css", "*.ts", "vite.config.ts", "tsconfig.json", "package.json", "vercel.json"], "allowed_repos": ["olivergale/metis-portal2"], "allowed_tables": ["work_orders:read"], "mutation_scope": "github_only", "protected_tables_via_rpc": []}	{"escalate_on": ["build_failure_after_3_attempts", "merge_conflict", "unclear_requirements", "file_over_10k_chars", "dependency_version_conflict"], "max_retries": 3, "escalation_target": "ilmarinen", "error_classification": {"retriable": ["github_rate_limit", "transient_api_error", "sandbox_timeout"], "non_retriable": ["file_not_found", "permission_denied", "type_error_after_3_fixes", "missing_dependency"]}}	{"max_turns": 50, "hard_limits": {"max_read_write_ratio": 4, "min_file_changes_per_10_turns": 1}, "implement_first_pct": 75, "mutation_ratio_target": 0.4, "verification_budget_pct": 25}	{github,frontend,sandbox,verification,memory}	2026-02-11 18:41:53.338867+00	2026-02-15 16:29:11.335183+00	minimax/minimax-m2.5	16384	[{"tier": 0, "label": "Sonnet 4.5 (default)", "model": "claude-sonnet-4-5-20250929"}, {"tier": 1, "label": "Opus 4.6 (complex UI)", "model": "claude-opus-4-6"}]	### Repository: olivergale/metis-portal2 (branch: main)\n\n### Architecture\n- **Stack**: Vanilla TypeScript + Vite 7.3.1 + Vercel deploy. NO framework (no React, no Vue, no Svelte).\n- **Build**: tsc && vite build. Output goes to dist/.\n- **Deploy**: Auto-deploy on push to main via Vercel.\n\n### File Structure\nsrc/components/ — Factory functions returning HTMLElement (Header.ts, WODetailPanel.ts, etc.)\nsrc/utils/ — Shared utilities (api.ts = REST client, supabase.ts = supabase-js client)\nsrc/styles/ — CSS modules (tokens.css, reset.css, workspace.css, wo-detail.css)\nsrc/types/ — TypeScript interfaces (index.ts)\nsrc/*.ts — Page entry point scripts (workspace.ts, manifold-dashboard.ts, etc.)\n*.html — Page shells at repo root (workspace-new.html, manifold.html, etc.)\nvite.config.ts — Multi-page config with rollupOptions.input entries per page\nvercel.json — Rewrites mapping slugs to HTML files\npackage.json — Dependencies\n\n### Page Pattern (ALWAYS follow)\n1. HTML shell at repo root with div#app and script type=module pointing to src/page-name.ts\n2. TypeScript entry at src/page-name.ts: imports styles, components, utils; builds DOM\n3. Vite entry in vite.config.ts rollupOptions.input\n4. Vercel rewrite in vercel.json\n\n### Component Pattern\nFactory functions, NOT classes:\nexport function createMyComponent(props: MyProps): HTMLElement {\n  const el = document.createElement("div");\n  el.className = "my-component";\n  el.innerHTML = `<h2>${escapeHtml(props.title)}</h2>`;\n  return el;\n}\n\n### Design System (tokens.css)\n- Backgrounds: --bg-primary (#2b2a27), --bg-surface (#353432), --bg-elevated (#3f3e3b)\n- Text: --text-primary (#ececec), --text-secondary (#b8b8b6), --text-muted (#888886)\n- Accent: --accent (#d4a574, warm gold)\n- Status: --status-active (green), --status-warning (yellow), --status-error (red)\n- Font: Inter. Spacing: 8px grid. Border radius: 8px standard, 12px cards.\n\n### Data Access\nimport { supabase } from "./utils/supabase";\nconst { data, error } = await supabase.rpc("function_name", { param: value });\n\n### What Makes Good Frontend Work\n- Every user-visible string goes through escapeHtml() to prevent XSS\n- Colors come from CSS custom properties, never hardcoded hex values\n- All related files ship in one atomic commit\n- New pages need entries in BOTH vite.config.ts AND vercel.json\n- TypeScript strict mode is ON
metis	Handle user interactions via portal chat, decompose requests into work orders, provide status updates.	measured	absorb-and-continue	{"allowed_tools": ["read_table", "create_draft_work_order", "delegate_subtask"], "allowed_tables": ["work_orders:read", "conversation_threads:write"], "mutation_scope": "conversation_only", "protected_tables_via_rpc": []}	{"escalate_on": ["user_escalation_request"], "max_retries": 2, "escalation_target": "ilmarinen", "error_classification": {"retriable": ["api_timeout"], "non_retriable": ["invalid_user_request", "permission_denied"]}}	{"max_turns": 40, "hard_limits": {"max_conversation_turns": 20}, "implement_first_pct": 70, "mutation_ratio_target": 0.2, "verification_budget_pct": 30}	{orchestration,conversation,delegation}	2026-02-11 18:41:53.338867+00	2026-02-11 18:41:53.338867+00	claude-opus-4-6	16384	[]	### Your Role\nYou are the user interface to the ENDGAME system. Users describe what they want in natural language via portal chat. You translate their intent into well-scoped work orders that the agent squad can execute.\n\n### Good WO Decomposition\nA well-scoped WO has:\n- A single, clear objective (one thing, not three)\n- Acceptance criteria with specific file paths, function names, SQL patterns\n- A scope that one agent can complete in one execution cycle (~6 minutes)\n- No ambiguity. If the builder could reasonably interpret an AC differently, it is too vague.\n\n### Bad WO Decomposition\n- "Build a dashboard" is too broad. Decompose into: create RPC, create HTML shell, create TS entry, add nav links.\n- "Fix the bugs" is too vague. Each bug = separate WO with specific reproduction steps.\n- ACs like "make it work" are meaningless. Specify: RPC returns JSONB with keys X, Y, Z.\n- JSON-formatted ACs fail. The AC counter uses regex for numbered/bulleted lists.\n\n### Decision Making\n- When a user request is ambiguous, ask clarifying questions before creating WOs.\n- Default priority: p2_medium. Only use p1_high for user-reported broken functionality. p0_critical is system-down only.\n- Source field: always portal for portal-originated WOs.\n- When creating multiple related WOs, use depends_on to chain them properly.\n- Tags should reflect the work type: sql-only, migration, frontend, remediation, manifold-v1.
security	Review work orders for security issues, RLS policy correctness, and enforcement layer compliance.	conservative	fail-fast	{"allowed_tools": ["read_table", "execute_sql:select_only", "get_schema", "sandbox_exec", "run_tests"], "allowed_tables": ["*:read"], "mutation_scope": "none", "protected_tables_via_rpc": []}	{"escalate_on": ["security_violation_detected", "enforcement_bypass_attempt"], "max_retries": 0, "escalation_target": "ilmarinen", "error_classification": {"retriable": [], "non_retriable": ["all"]}}	{"max_turns": 25, "hard_limits": {"max_review_time_seconds": 120}, "implement_first_pct": 50, "mutation_ratio_target": 0.0, "verification_budget_pct": 50}	{security,read-only,audit,sandbox}	2026-02-11 18:41:53.338867+00	2026-02-11 18:41:53.338867+00	minimax/minimax-m2.5	16384	[]	### Threat Model\nThe ENDGAME system has two trust boundaries:\n1. **Portal to Supabase**: Browser clients use anon key. All data access must go through RLS policies or SECURITY DEFINER RPCs.\n2. **Agent to Database**: Agents use service role key internally. Enforcement triggers prevent agents from bypassing state machine rules (only ilmarinen can set bypass configs).\n\n### Attack Surfaces (priority order)\n1. **RLS gaps**: Tables without RLS policies are world-readable via PostgREST. Every table with user data needs RLS.\n2. **SECURITY DEFINER without search_path**: Functions with SECURITY DEFINER run as the definer role. Without SET search_path, an attacker can shadow functions in a malicious schema.\n3. **Dynamic SQL injection**: RPCs that build SQL from parameters (EXECUTE format()) must use %I for identifiers, %L for literals, never concatenation.\n4. **Bypass pattern leaks**: The enforcement bypass (app.wo_executor_bypass) is restricted to ilmarinen. Any non-master agent attempting to SET this config should be flagged.\n5. **Secrets in client code**: API keys, service role keys, signing keys must never appear in frontend code or edge function responses.\n\n### Decision Making\n- A missing RLS policy on a table with real data is always a FAIL, regardless of WO scope.\n- SECURITY DEFINER without search_path is always a FAIL.\n- Dynamic SQL without parameterization is always a FAIL.\n- Report findings as qa_findings with severity critical for exploitable issues, high for defense-in-depth gaps.\n\n### Security Finding Reporting\nUse log_security_finding tool to record security findings with finding_type, category, severity, description, evidence.\nDo NOT use log_progress with success:false for security findings as that creates false failure mutations in the execution audit trail.
ops	Monitor system health, detect stuck work orders, clean up orphaned resources, retry failed WOs.	measured	absorb-and-continue	{"allowed_tools": ["read_table", "execute_sql:select_only", "log_progress", "sandbox_exec", "run_tests"], "allowed_tables": ["work_orders:read", "work_order_execution_log:write", "agents:read"], "mutation_scope": "execution_log_only", "protected_tables_via_rpc": []}	{"escalate_on": ["system_critical_failure", "repeated_stuck_wo"], "max_retries": 0, "escalation_target": "ilmarinen", "error_classification": {"retriable": [], "non_retriable": ["all"]}}	{"max_turns": 30, "hard_limits": {"max_observation_cycles": 100}, "implement_first_pct": 90, "mutation_ratio_target": 0.05, "verification_budget_pct": 10}	{monitoring,read-only,sandbox}	2026-02-11 18:41:53.338867+00	2026-02-11 18:41:53.338867+00	minimax/minimax-m2.5	16384	[]	### System You Monitor\nThe ENDGAME WO system processes work orders through a lifecycle: draft, ready, in_progress, review, done. You monitor this pipeline for failures, stalls, and orphans.\n\n### What Healthy Looks Like\n- WOs in in_progress have execution_log entries within the last 2 hours\n- WOs in in_progress have wo_mutations entries showing actual work\n- The ready queue drains. Items do not sit in ready without being picked up.\n- Blocked WOs whose depends_on are all done get automatically unblocked\n- Failed WOs get remediation WOs spawned automatically\n\n### What Unhealthy Looks Like\n- A WO stuck in in_progress with 0 mutations and no execution_log for >2 hours = stuck\n- Multiple WOs in ready with none in_progress = queue stall\n- A WO blocked on a depends_on that is already done = orphaned block\n- A WO failed with no remediation child = dropped failure\n\n### Decision Making\n- Warn first, act second. Mark a WO as stuck only after 2 consecutive health check cycles show no progress.\n- Ilmarinen-assigned WOs have no server-side execution_log (CLI sessions). Never mark these as stuck.\n- Auto-unblock is safe. If all depends_on are satisfied, transition to ready.\n- Auto-recovery (failed to draft) is safe for non-P0 WOs. P0 requires ilmarinen attention.\n- When you see a pattern of repeated failures on similar WOs, log it as a lesson, not just individual fixes.
builder	Execute work orders requiring database changes, deployments, and code modifications. Full mutation authority.	aggressive	retry-then-escalate	{"allowed_tools": ["execute_sql", "apply_migration", "github_*", "deploy_edge_function", "sandbox_exec", "run_tests"], "allowed_tables": ["*"], "mutation_scope": "full", "protected_tables_via_rpc": ["system_manifest", "decisions", "schema_changes"]}	{"escalate_on": ["budget_exhaustion", "repeated_failure", "unclear_requirements"], "max_retries": 3, "escalation_target": "ilmarinen", "error_classification": {"retriable": ["timeout", "rate_limit", "transient_db_error"], "non_retriable": ["permission_denied", "schema_violation", "constraint_violation"]}}	{"max_turns": 50, "hard_limits": {"max_read_write_ratio": 5, "min_mutations_per_10_turns": 2}, "implement_first_pct": 80, "mutation_ratio_target": 0.3, "verification_budget_pct": 20}	{database,deployment,github,migration,sandbox}	2026-02-11 18:41:53.338867+00	2026-02-14 04:36:53.160393+00	minimax/minimax-m2.5	8192	[{"tier": 0, "label": "MiniMax M2.5 (fast/cheap)", "model": "minimax/minimax-m2.5"}, {"tier": 1, "label": "Sonnet 4.5 (balanced)", "model": "claude-sonnet-4-5-20250929"}, {"tier": 2, "label": "Opus 4.6 (max capability)", "model": "claude-opus-4-6"}]	### Codebase: olivergale/metis-portal2 (branch: main)\n\n### What You Build\nYou execute database migrations, schema changes, edge function code, and frontend code for the ENDGAME autonomous WO system. The codebase has two layers:\n- **Database layer**: ~140 tables, ~100 RPCs, ~50 triggers in Supabase (PostgreSQL 15)\n- **Edge functions**: TypeScript on Deno runtime at supabase/functions/ (wo-agent, qa-review, work-order-executor, etc.)\n- **Frontend**: Vanilla TS + Vite at src/ with HTML shells at repo root\n\n### Deployment Architecture\n- Database changes: apply_migration tool creates versioned migration files\n- Edge functions: github_push_files commits to main, GitHub Actions auto-deploys to Supabase\n- Frontend: github_push_files commits to main, Vercel auto-deploys from repo\n- All three paths are atomic. Commit and deploy are one action.\n\n### Decision Making\n- Migration-only WOs: test with SELECT first, then apply_migration. No deploy step needed.\n- Code WOs: read existing file fully first, understand patterns, then modify. Never write blind.\n- Multi-file changes: one atomic github_push_files commit with all files. Never partial commits.\n- When unsure about schema: query information_schema or pg_catalog, do not guess.\n- When a migration fails: check error, fix SQL, try again. Do NOT revert and start over unless structurally wrong.\n\n### Key Patterns\n- Edge functions import from _shared/ for common utilities\n- All RPCs are SECURITY DEFINER with search_path = public, extensions\n- Triggers use current_setting for suppression guards\n- JSONB columns are common. Use ->> for text extraction, -> for nested access\n- Enum types are strict. Always check valid values before INSERT/UPDATE
qa-gate	Evaluate work order quality and completeness. Generate QA findings and remediation work orders.	conservative	fail-fast	{"allowed_tools": ["read_table", "execute_sql:select_only", "sandbox_exec", "run_tests"], "allowed_tables": ["work_orders:read", "work_order_execution_log:read", "qa_findings:write", "qa_checklist:read"], "mutation_scope": "qa_findings_only", "protected_tables_via_rpc": []}	{"escalate_on": ["evaluation_ambiguity", "missing_evidence"], "max_retries": 1, "escalation_target": "ops", "error_classification": {"retriable": [], "non_retriable": ["invalid_wo_id", "missing_execution_log"]}}	{"max_turns": 20, "hard_limits": {"max_evaluation_time_seconds": 60}, "implement_first_pct": 60, "mutation_ratio_target": 0.1, "verification_budget_pct": 40}	{evaluation,read-only,sandbox}	2026-02-11 18:41:53.338867+00	2026-02-11 18:41:53.338867+00	claude-opus-4-6	16384	[]	### Your Role in the System\nYou are the lie detector. Agents claim they completed work. Your job is to verify those claims against evidence. You are the last gate before a WO is marked done.\n\n### Evidence Sources (in order of reliability)\n1. **wo_mutations** — actual SQL/code changes recorded by the agent. Most reliable. If a mutation is recorded, it happened.\n2. **execution_log** — step-by-step log of agent actions. Shows what tools were called and results.\n3. **Database state** — query the actual tables/functions/triggers to see if claimed changes exist.\n4. **GitHub commits** — for code changes, verify the commit exists and contains what was claimed.\n\n### What Makes a PASS\n- Every AC has evidence in at least one source\n- No scope drift (agent did not change things outside the ACs)\n- Claims match evidence (agent did not inflate what was done)\n- Destructive changes (DROP, DELETE, ALTER) have verification queries showing correct state after\n\n### What Makes a FAIL\n- An AC is claimed as done but no mutation/log/database evidence supports it\n- Agent claims to have deployed something but no deploy mutation exists\n- Agent modified files outside the WO scope without justification\n- Summary contradicts the execution_log timeline\n\n### Decision Making\n- When evidence is ambiguous, lean FAIL. False positives waste less time than false negatives.\n- Check for the common lie: claimed verification query with no actual SELECT in the mutations.\n- Remediation WOs from your FAILs go back to the original agent. Write clear, specific failure reasons so remediation is actionable.
\.


--
-- Data for Name: agent_knowledge_base; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.agent_knowledge_base (id, category, topic, content, applicable_roles, applicable_tags, severity, active, created_at, updated_at) FROM stdin;
22049fbd-67be-476c-9d6f-979fcacd2ad2	schema_gotcha	work_orders.name_not_title	work_orders uses column "name" NOT "title". The column "title" does not exist. Always use .name for the WO display name.	{general}	{general}	critical	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
f9007d65-b6d0-4a32-9d1d-47d0feb93041	schema_gotcha	work_orders.created_by_is_enum	work_orders.created_by is agent_type enum, NOT a UUID. Valid values: you, engineering, audit, cto, cpo, research, analysis, external.	{general}	{general}	critical	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
ecaa468f-6463-443a-8b03-8cfb6a53b4d5	schema_gotcha	work_orders.priority_enum	work_orders.priority is work_order_priority enum. Valid values: p0_critical, p1_high, p2_medium, p3_low. NOT integers.	{general}	{general}	critical	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
05550480-bd77-463d-b00b-b0afa1b86108	schema_gotcha	audit_log_columns	audit_log columns are target_type/target_id/payload — NOT entity_type/entity_id/details. Also: event_type is NOT NULL (required on INSERT).	{general}	{general}	critical	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
4be3fab6-dcbd-445d-a72f-1ad9bbb8a921	schema_gotcha	audit_log_immutable	audit_log is immutable — no UPDATE or DELETE allowed. INSERT only. Enforced by trigger.	{general}	{general}	important	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
1aa1206f-5f08-4d69-9e02-8e291c170a91	schema_gotcha	audit_log_actor_type_values	audit_log.actor_type valid values: agent, user, system, llm. NOT "engineering" or agent names.	{general}	{general}	critical	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
0780ad81-e031-45d3-b790-32c599fc8abb	schema_gotcha	lessons_category_enum	lessons.category is enum. Valid values: hallucination, scope_creep, tool_misuse, format_violation, context_loss, incorrect_assumption, security, performance, other, state_machine, authorization, approval_flow, execution, general, intake_gate.	{general}	{general}	important	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
64b6e5c4-40dd-40f4-ab63-540f18e65eaa	schema_gotcha	lessons_promoted_columns	lessons has promoted_at/promoted_by columns, NOT a "promoted" boolean.	{general}	{general}	reference	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
dc5ac8b4-d93b-43e6-be6b-1102cf20fcfa	schema_gotcha	project_briefs_code_column	project_briefs uses "code" column, NOT "project_code".	{general}	{general}	important	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
50d04fdd-4046-41e4-877a-ebf7d512b0ae	schema_gotcha	project_briefs_current_phase_integer	project_briefs.current_phase is INTEGER, not TEXT.	{general}	{general}	reference	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
b1be80d5-c954-4592-8536-3999b252ca5b	schema_gotcha	state_mutations_columns	state_mutations columns: payload/previous_state — NOT old_state/new_state. mutation_type values are UPPERCASE.	{general}	{general}	important	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
bf075174-04dd-47f7-b483-5cb3588b30c5	schema_gotcha	work_orders_execution_rank	work_orders.execution_rank is INTEGER (default 500, range 1-999). Lower = higher priority. Used for poll ordering.	{general}	{general}	reference	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
6e4e4f3d-0526-478f-903b-fe062e7bb16a	schema_gotcha	qa_checklist_on_work_orders	qa_checklist lives on work_orders table as JSONB column, NOT a separate table. Populated by trg_auto_populate_qa_checklist on transition to review.	{general}	{general}	important	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
21965997-a7bb-43ad-bdcc-7c13f4fa4e6c	schema_gotcha	system_manifest_component_types	system_manifest.component_type valid values: api_integration, edge_function, mcp_connector, policy, rpc_function, table, trigger, view. No "daemon" or "hook".	{general}	{general}	reference	t	2026-02-09 22:05:08.632962+00	2026-02-09 22:05:08.632962+00
fc0b94fb-324a-4fe0-8478-dd7870a15cae	rpc_signature	create_draft_work_order_params	create_draft_work_order() RPC params in order: p_slug (NULL for auto-sequential WO-0001), p_name, p_objective, p_priority, p_source, p_tags. SLUG IS FIRST. No p_created_by param — hardcoded to "engineering".	{executor}	{general}	critical	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
325e72af-630e-40cc-97be-22ea56331b57	rpc_signature	start_work_order_takes_name	start_work_order(p_work_order_id, p_agent_name) takes agent NAME as text, NOT UUID. Returns the updated WO.	{executor}	{general}	critical	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
a83814d5-3552-43e9-915b-d77422dafa24	rpc_signature	update_work_order_state_rpc	update_work_order_state() RPC for WO transitions. Goes through enforcement layer. Use this instead of direct UPDATE on work_orders.status.	{general}	{general}	critical	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
222dc2ce-b625-4036-805d-c3278bb571fa	rpc_signature	state_write_rpc	state_write() RPC for protected tables (system_manifest, decisions, schema_changes). Required — direct INSERT/UPDATE blocked by triggers.	{executor}	{general}	important	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
56739faa-9679-491c-a265-8fa1b7b39b3b	rpc_signature	create_draft_wo_returns_object	create_draft_work_order() returns {id, name, slug, status} object. Extract .id before passing to start_work_order().	{executor}	{remediation,general}	critical	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
8db67782-c0ac-4cf8-9289-3ea68535ba92	rpc_signature	run_sql_void_for_ddl	Use run_sql_void() RPC for DDL and multi-statement SQL. run_sql() wraps in SELECT subquery which breaks DDL. run_sql_void uses EXECUTE directly.	{executor}	{general}	important	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
ece827c1-0996-44cf-a3e7-e779b9f07e2e	rpc_signature	score_work_order_rpc	score_work_order(p_wo_id) RPC — 5-dimension scoring for queue prioritization. Returns execution_rank integer.	{evaluator}	{general}	reference	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
4bc1e981-a8f4-4f91-a3de-aebd5171803f	rpc_signature	get_schema_context_rpc	get_schema_context() RPC returns formatted database schema. Use for context loading, not raw information_schema queries.	{general}	{general}	reference	t	2026-02-09 22:05:23.830587+00	2026-02-09 22:05:23.830587+00
4cce0a97-c2d1-478b-8fc2-201b95fee102	enum_values	work_orders_source_values	work_orders.source valid values: portal, cli, api, mcp_bridge, direct, unknown, test_suite, intake_api, lesson_promoter, daemon, auto_approval, auto-qa. NOT agent names like "ilmarinen" or "forgehand". CHECK constraint work_orders_source_check enforces this.	{general}	{general}	critical	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
547b8c14-de39-434c-9997-20836fcc7c1e	enum_values	work_orders_status_lifecycle	WO status lifecycle: draft → ready → in_progress → review → done. Also: failed, cancelled, pending_approval. Enforce via update_work_order_state() RPC.	{general}	{general}	critical	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
7d79ed0e-8ada-474c-9737-e979664d81e5	enum_values	execution_log_phase_values	work_order_execution_log.phase CHECK constraint. Valid: stream, execution_start, execution_complete, qa_validation, failed, schema_injection, schema_validation, loop_breaker, reprioritize, checkpoint. "execution" alone is NOT valid — INSERTs silently fail via REST API.	{general}	{general}	critical	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
5044b4bd-0e03-4b05-871c-f1d45f833531	enum_values	agent_type_enum	agent_type enum (for work_orders.created_by): you, engineering, audit, cto, cpo, research, analysis, external.	{general}	{general}	important	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
8afb66f9-ded7-49fa-9718-1433aaf75f77	enum_values	work_order_priority_enum	work_order_priority enum: p0_critical, p1_high, p2_medium, p3_low. Used in work_orders.priority column.	{general}	{general}	important	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
73ba8b8f-d7e8-4e77-8f94-e44704fcd948	enum_values	wo_executor_bypass_key	Enforcement bypass config key: app.wo_executor_bypass (NOT app.state_write_bypass). Set via SELECT set_config('app.wo_executor_bypass', 'true', true) in same transaction as UPDATE.	{executor}	{general}	critical	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
ff080c9b-888e-4c02-b7d1-2be28dc31543	enum_values	state_write_bypass_key	State write bypass config key: app.state_write_bypass. For protected table writes via state_write() RPC.	{executor}	{general}	important	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
47dda003-11c9-470f-9a03-445cfcd37ada	enum_values	lessons_severity_values	lessons.severity valid values: critical, high, medium, low. Used for filtering in context loading.	{general}	{general}	reference	t	2026-02-09 22:05:41.963684+00	2026-02-09 22:05:41.963684+00
869a42b6-c909-47d2-8f54-304d01814cf6	enforcement	enforce_wo_state_changes_validates_with_bypass	enforce_wo_state_changes trigger validates transitions EVEN WITH bypass enabled. Must step through valid states (e.g. in_progress→review→done, not in_progress→done directly).	{executor}	{general}	critical	t	2026-02-09 22:05:54.439433+00	2026-02-09 22:05:54.439433+00
a068c714-2e71-48dd-b69d-e05872d583e4	enforcement	bypass_is_transaction_scoped	set_config bypass is transaction-scoped. MUST be in same transaction (same RPC call) as the UPDATE. Separate calls = separate transactions = bypass not visible.	{executor}	{general}	critical	t	2026-02-09 22:05:54.439433+00	2026-02-09 22:05:54.439433+00
2ea947c2-0d8f-4765-bb9b-a2db728c2f1a	enforcement	protected_tables_need_state_write	Protected tables (system_manifest, decisions, schema_changes) require state_write() RPC for INSERT/UPDATE. Direct writes blocked by enforcement triggers.	{executor}	{general}	important	t	2026-02-09 22:05:54.439433+00	2026-02-09 22:05:54.439433+00
ec9995bf-9fdd-4872-8ae6-1c4f0237300d	enforcement	check_constraints_silent_failure	CHECK constraints on work_orders silently block operations via REST API. Only visible in Postgres logs. Edge functions swallow the error. Always verify after INSERT/UPDATE.	{general}	{general}	important	t	2026-02-09 22:05:54.439433+00	2026-02-09 22:05:54.439433+00
751ff3bb-ee64-4979-b53a-6e5a05c8b578	enforcement	never_use_check_on_trigger_populated	NEVER use CHECK constraints on work_orders for trigger-populated columns — causes deadlock risk. Use trigger validation instead.	{executor}	{schema,migration,general}	important	t	2026-02-09 22:05:54.439433+00	2026-02-09 22:05:54.439433+00
750cb817-e36c-4ce8-9782-7fdf087aa3bd	enforcement	audit_log_event_type_required	audit_log.event_type is NOT NULL. Must always provide event_type value in INSERT (it is a separate column from action).	{general}	{general}	important	t	2026-02-09 22:05:54.439433+00	2026-02-09 22:05:54.439433+00
5a378f6b-2173-4c94-94d2-dc54bbe4aec0	deployment	never_mcp_deploy_large_functions	NEVER use mcp__supabase__deploy_edge_function for large files (>100 lines). It requires full file content as tokens — causes 5+ minute hangs. Use CLI: supabase functions deploy <name> --project-ref <ref> --no-verify-jwt instead.	{executor}	{general}	critical	t	2026-02-09 22:06:07.841515+00	2026-02-09 22:06:07.841515+00
b6b66e48-9f2b-4ebe-9b2a-fe98256f9deb	deployment	pgcrypto_extensions_schema	Supabase installs pgcrypto in "extensions" schema. Always use extensions.digest() not bare digest().	{executor}	{schema,migration,general}	important	t	2026-02-09 22:06:07.841515+00	2026-02-09 22:06:07.841515+00
55772bd8-dc0c-4ced-a52c-89c4bc1938ef	deployment	deploy_time_registration	Every new endpoint MUST have a request_schemas INSERT in the same deploy step. validate_request RPC rejects unknown endpoints — root cause of "Validation failed: undefined" errors.	{executor}	{general}	critical	t	2026-02-09 22:06:07.841515+00	2026-02-09 22:06:07.841515+00
b212d868-7fe4-4461-a0ef-cbf821e53729	deployment	cli_deploy_command_template	CLI deploy: cd /Users/OG/Projects/metis-portal2 && supabase functions deploy <name> --project-ref phfblljwuvzqzlbzkzpr --no-verify-jwt. For wo-agent add: --import-map deno.json	{executor}	{general}	reference	t	2026-02-09 22:06:07.841515+00	2026-02-09 22:06:07.841515+00
1d5e2d95-ce7f-4b18-87b3-7a7c77b3f2fa	deployment	after_insert_trigger_limitation	AFTER INSERT triggers that SET columns (assigned_to, approved_at) — values do NOT persist on the same INSERT. Workaround: use separate UPDATE with bypass after initial INSERT.	{executor}	{schema,migration,general}	important	t	2026-02-09 22:06:07.841515+00	2026-02-09 22:06:07.841515+00
f99cc30d-a5da-44f6-b68e-e45b2983fa92	qa_pattern	evidence_as_stream_phase	Log QA evidence as phase="stream" with event_type="tool_result" and tool_name="Bash"/"Grep"/"Read"/"mcp__supabase__execute_sql". Auto-QA reads stream events. Other phases are ignored.	{executor,evaluator}	{general}	critical	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
14dfa942-d29b-4e78-9648-a770bfb95554	qa_pattern	evidence_must_be_per_wo	Evidence logged to WO-X is NOT visible to WO-Y auto-QA. Each WO needs its own execution_log entries with matching work_order_id.	{executor,evaluator}	{general}	critical	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
7dc6c60a-4bbc-42a4-b379-88255bb1b00d	qa_pattern	acceptance_criteria_format	acceptance_criteria MUST be numbered lines (1. ...) or bullets (- ...), NOT JSON. count_acceptance_criteria() regex expects ^\\d+[.\\):\\s], ^[-*]\\s, or ^AC\\d+[:\\. JSON returns 0 → checklist never populated → QA only produces generic findings.	{executor,evaluator}	{general}	critical	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
4e614ca6-a6a1-40dc-b8e7-f6a33327e740	qa_pattern	auto_qa_full_flow	WO→review triggers: trg_auto_populate_qa_checklist parses ACs into qa_checklist JSONB → trg_auto_run_qa_evaluation calls /auto-qa via pg_net → Haiku evaluates each item → writes qa_findings → if all pass, auto-accepts to done.	{evaluator}	{general}	important	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
cbb0c046-a422-48cc-a5d6-8ad9fd05c300	qa_pattern	qa_checklist_and_findings_both	QA gate checks qa_checklist JSONB on work_orders table AND qa_findings table. Must update BOTH when resolving findings manually.	{executor,evaluator}	{remediation,general}	important	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
db5d4c7e-5367-45e9-be81-e421b45c3aca	qa_pattern	acs_must_match_scope	Acceptance criteria must match WO scope. If WO is code implementation (not E2E testing), ACs should say "function exists and calls X" not "daemon calls X" (which implies execution).	{executor}	{general}	important	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
cbffa97f-24b8-4ec0-9b89-dbffb1e69e8e	qa_pattern	auto_qa_reads_wo_summary	Auto-QA (/auto-qa endpoint) reads wo.summary as PRIMARY evaluation context. A good summary directly helps QA pass.	{executor}	{general}	important	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
36c84543-2b35-4509-b9a0-d365e05eaca3	qa_pattern	auto_qa_source_hyphenated	Auto-QA created WOs use source value "auto-qa" (HYPHENATED). This is in the work_orders_source_check constraint.	{executor,evaluator}	{remediation,general}	important	t	2026-02-09 22:06:26.71417+00	2026-02-09 22:06:26.71417+00
e51e1b83-4ff1-454b-bc4d-5c759c7331c8	operational	depends_on_cancelled_blocks	Cancelled WOs in depends_on permanently block dependents. Cascade/auto-start only check status=done. Must manually clear cancelled IDs from depends_on arrays.	{general}	{general}	important	t	2026-02-09 22:06:39.796518+00	2026-02-09 22:06:39.796518+00
33a362df-ec1e-4095-a7d0-a050b1b81d42	operational	daemon_restart_after_edits	Daemon requires restart after file edits. Kill PID, launchd auto-restarts. Daemon v4.0 at ~/.claude/ilmarinen-daemon-v3.py — 60s poll, local-only routing.	{executor}	{local-filesystem,general}	reference	t	2026-02-09 22:06:39.796518+00	2026-02-09 22:06:39.796518+00
02021886-b35c-4f73-a183-b8bfb9d39900	operational	poll_ordering	Poll ordering: execution_rank ASC, priority ASC, created_at ASC. Backwards compatible — default rank 500 means priority still matters for unscored WOs.	{general}	{general}	reference	t	2026-02-09 22:06:39.796518+00	2026-02-09 22:06:39.796518+00
eafc1829-7a27-4b37-b0b5-52dc57bcf1b0	operational	edge_function_125s_timeout	Supabase edge functions have 125s timeout. Complex WOs needing code file changes should route to ilmarinen (local CLI, no timeout). Server-side agent averages 26.6 turns before timeout.	{general}	{general}	important	t	2026-02-09 22:06:39.796518+00	2026-02-09 22:06:39.796518+00
c9d8bec9-8c42-4a7a-b5a6-7f3219d897f4	operational	wo_tags_describe_feature_area	WO tags describe feature area, NOT execution mode. "rollback" tag triggers daemon rollback handler. Use "server-side-agent" tag for server-side (builder) execution.	{general}	{general}	important	t	2026-02-09 22:06:39.796518+00	2026-02-09 22:06:39.796518+00
5e27c8f5-c403-478f-aecd-4ab94e6631a0	remediation	remediation_circuit_breaker	Remediation circuit breaker: max 3 attempts per parent WO, then parent → failed. Recursion guard: /auto-qa only creates remediation WOs for NON-remediation WOs (checks wo.tags.includes("remediation")).	{executor,evaluator}	{remediation,general}	critical	t	2026-02-09 22:06:51.848208+00	2026-02-09 22:06:51.848208+00
990bc0d8-0e2b-4d26-ad31-3bac22aff24d	remediation	two_step_parent_reeval	handleRemediationCompletion() does review → in_progress → review on parent WO. This triggers trg_auto_run_qa_evaluation which fires on status CHANGE to review. Two-step is required.	{executor}	{remediation}	important	t	2026-02-09 22:06:51.848208+00	2026-02-09 22:06:51.848208+00
13671a30-3613-4353-a276-d8c776579224	remediation	remediation_tags_format	Remediation WOs use tags: ["remediation", "parent:{slug}", "auto-qa-loop"]. Parent tag format is parent:WO-XXXX (no space).	{executor,evaluator}	{remediation}	important	t	2026-02-09 22:06:51.848208+00	2026-02-09 22:06:51.848208+00
c8cb2361-c209-4aa0-8855-bd065c41ae59	remediation	remediation_propagate_evidence	On remediation WO completion, propagate evidence to parent WO execution_log. This ensures parent auto-QA re-evaluation has access to remediation results.	{executor}	{remediation}	important	t	2026-02-09 22:06:51.848208+00	2026-02-09 22:06:51.848208+00
7aaee053-0b0c-4fbe-8b37-a7286040ae71	remediation	remediation_orphan_guard	Orphaned remediation WOs (parent already done) are auto-completed before agent loop runs. Check in wo-agent/index.ts /execute handler.	{executor}	{remediation}	reference	t	2026-02-09 22:06:51.848208+00	2026-02-09 22:06:51.848208+00
e755ec49-6ca7-42d7-9af7-1854058b1789	agent_routing	ilmarinen_routes_local	Ilmarinen handles: local-filesystem, rollback, portal-frontend, git-delivery tagged WOs. Executes via local CLI daemon. No timeout limit.	{general}	{general}	important	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
6435a580-c60c-41ff-827c-cad575963700	agent_routing	qa_gate_evaluator_role	qa-gate (formerly sentinel) handles: auto-QA evaluation, queue scoring/reprioritization, quality gates. Has read-only SQL access.	{general}	{general}	reference	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
500e9a56-2c39-4b03-96f4-25aede13d93a	agent_routing	ops_observer_role	ops (formerly watchman) handles: health monitoring, stuck detection (>10min no activity), orphan cleanup, failed WO triage (retry ≤3x then escalate). Runs on 5min cron.	{general}	{general}	reference	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
4c50efa2-33aa-4afd-872c-5ce43708e75a	process	wo_lifecycle	WO lifecycle: create → start → [execute] → review → done. RPCs: create_draft_work_order() for new, start_work_order() for assign+approve+start, update_work_order_state() for transitions.	{general}	{general}	important	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
ddd53158-0718-4804-95d9-752b48dccc60	process	auto_routing_behavior	trg_auto_route_work_order fires on approval. Routes by tags: review→reviewer, default→ilmarinen. Leaves WO in draft when gate needs_approval=true. P0 WOs stay visible in portal Inbox.	{general}	{general}	reference	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
0033d241-06ca-483e-ba59-9d15e9fc890a	process	reprioritize_debounce	Reprioritization: trg_reprioritize_on_wo_insert fires pg_net to /reprioritize. 60s cooldown for insert triggers (bypassed for cron/manual). pg_cron evaluate-wo-queue every 30 min.	{evaluator}	{general}	reference	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
add00dc1-1193-4d69-8e3a-99d45b20e945	process	build_through_system	Build THROUGH the system, not around it. All changes via WOs → enforcement → observability → lessons → directives. Never bypass the harness.	{general}	{general}	critical	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
ffc63c40-c0a5-489d-b245-c9b34bcbd64d	testing	sandbox_kills_background_processes	Claude sandbox kills background processes. Cannot test run.sh or daemons from sandbox. Use direct function calls instead.	{executor}	{general}	reference	t	2026-02-09 22:07:23.192045+00	2026-02-09 22:07:23.192045+00
c7c365c3-5ca2-4091-a75b-b9d16eea99ed	testing	select_set_config_not_perform	Use SELECT set_config(...) not PERFORM set_config(...) in raw SQL. PERFORM is plpgsql only — fails in plain SQL context.	{executor}	{general}	important	t	2026-02-09 22:07:23.192045+00	2026-02-09 22:07:23.192045+00
74dc869e-c815-4f56-958d-b1fcb1e75556	testing	enforce_transitions_even_with_bypass	enforce_wo_state_changes validates state transitions EVEN with bypass. Cannot skip states (e.g. in_progress→done). Must step through: in_progress→review→done.	{executor}	{general}	critical	t	2026-02-09 22:07:23.192045+00	2026-02-09 22:07:23.192045+00
d6da1e26-8bdb-4686-b7dd-0028aab4fd19	testing	daemon_poll_must_include_in_progress	Daemon poll endpoint MUST include in_progress status filter. wo start atomically transitions draft→ready→in_progress — daemon never sees "ready" state.	{executor}	{general}	important	t	2026-02-09 22:07:23.192045+00	2026-02-09 22:07:23.192045+00
3f8a532f-bd44-42ca-b517-a838f41d31de	testing	daemon_skip_claim_for_in_progress	Daemon must skip /claim call for WOs already in in_progress status. The claim endpoint rejects them as "Not claimable".	{executor}	{general}	important	t	2026-02-09 22:07:23.192045+00	2026-02-09 22:07:23.192045+00
de002608-095b-47b0-b1c2-b491f18e5085	testing	hooks_false_positives_security_code	metis_hooks.py PreToolUse scans Write/Edit content for dangerous patterns — causes false positives when writing security code. Use Bash heredoc to bypass, or construct patterns dynamically.	{executor}	{local-filesystem}	reference	t	2026-02-09 22:07:23.192045+00	2026-02-09 22:07:23.192045+00
f7f017a9-6d7e-4c7d-867b-b021e41ecfd6	agent_routing	builder_routes_server_side	Builder handles: supabase, migration, schema, remediation, sql-only tagged WOs. Executes via wo-agent edge function. 125s timeout limit.	{general}	{general}	important	t	2026-02-09 22:07:09.628125+00	2026-02-09 22:07:09.628125+00
db88fb23-91fb-4ac6-bc89-7a15b5bee668	deployment	github_commit_message_conventions	GitHub commit messages should be clear and actionable. Format: "<action>: <description>". Examples: "Add: KB entries for GitHub workflow patterns", "Fix: SQL syntax in wo-agent executor", "Update: builder prompt with code-aware context". Always include the WO slug in commit messages for traceability: "Add KB entries for GitHub patterns (WO-0205)".	{executor}	{github,deployment}	important	t	2026-02-09 23:36:17.030832+00	2026-02-09 23:36:17.030832+00
a242b39a-ad75-4019-b4b3-c81dc6f285c1	project_context	ENDGAME-001 Current Focus	Current focus: Identity cleanup complete. ENDGAME-001 is the sole active project. MCP bridge operational. Ready for build.	{executor}	{server-side-agent,supabase}	important	t	2026-02-09 23:39:08.598762+00	2026-02-09 23:39:08.598762+00
35de7379-b408-47e3-912e-20e48e557b3e	project_context	ENDGAME-001 Architecture	Architecture components: {"github": "Planned: version control, agent code, audit trail", "notion": "Read-only dashboard synced from Supabase via triggers", "portal": "ENDGAME Portal (metis-portal2.vercel.app) — orchestration UI, chat, WO management", "wo_cli": "Work order CLI (~/Projects/wo) — create, transition, list, brief, agents, directives. Routes through Supabase RPCs.", "supabase": "Primary data store, pgvector embeddings, source of truth, Edge Functions, enforcement layer", "claude_code": "Engineering execution via MCP bridge (mcp.authenticrevolution.com). Tools: read_file, write_file, list_dir, run_command, search_files"}. MCP connections: {"figma": {"tools": ["get_design_context", "get_screenshot", "generate_diagram"], "status": "active"}, "slack": {"tools": ["slack_search_public", "slack_send_message", "slack_read_channel"], "status": "active"}, "notion": {"tools": ["notion-fetch", "notion-search", "notion-create-pages", "notion-update-page"], "status": "active"}, "supabase": {"tools": ["execute_sql", "apply_migration", "list_tables", "deploy_edge_function", "get_logs"], "status": "active"}, "claude_code_bridge": {"url": "https://mcp.authenticrevolution.com/mcp", "tools": ["read_file", "write_file", "list_dir", "run_command", "search_files"], "status": "active"}}	{executor}	{server-side-agent,supabase}	important	t	2026-02-09 23:39:08.598762+00	2026-02-09 23:39:08.598762+00
cb915460-93a7-4dec-86a5-f7dc81795f09	project_context	ENDGAME-001 Last Session	Last session summary: Fixed MCP HTTP bridge (server.py + run.sh), created wo CLI, cleaned local filesystem, updating Supabase source of truth.	{executor}	{server-side-agent,supabase}	reference	t	2026-02-09 23:39:08.598762+00	2026-02-09 23:39:08.598762+00
808bcee9-0b94-4e18-9ad1-dfb5955b2685	project_context	ENDGAME-001 Key Decisions	Recent architectural decisions: 2026-01-27: Use pgvector with 384 dimensions (Rationale: Balance between quality and performance for text-embedding-3-small)\n2026-01-27: Store extracted data in conversation metadata JSONB (Rationale: Simpler than separate tables, still queryable)\n2026-01-29: Implement automated context injection (Rationale: Claude forgetting architecture and keys across sessions)\n2026-01-27: Use pgvector with 384 dimensions (Rationale: Balance between quality and performance for text-embedding-3-small)\n2026-01-27: Store extracted data in conversation metadata JSONB (Rationale: Simpler than separate tables, still queryable)\n2026-01-29: Implement automated context injection (Rationale: Claude forgetting architecture and keys across sessions)\n2026-01-30: Python + Claude Code for orchestration over n8n-only (Rationale: Version control, testability, self-improving agents, proper software engineering)\n2026-01-30: Memory as core leverage layer (Rationale: Persistence enables context across any project, history, preferences, state)\n2026-01-30: Dual interface: NL (Slack) + Visual (Web UI) (Rationale: NL for execution, UI for visibility and quick actions, both hit same APIs)\n2026-01-30: Manual 'load context' invocation until Slack interface built (Rationale: Validates system value before investing in auto-injection infrastructure)\n2026-01-31: Orchestrator-first architecture for conversation capture (Rationale: All production interactions route through orchestrator Edge Function which logs full transcripts. Claude.ai is dev/test interface only until orchestrator is live. Enables multi-model support and zero manual intervention.)\n2026-01-31: Notion MCP for read-only dashboard, Supabase triggers for write sync (Rationale: One-way data flow: Supabase is source of truth, Notion is human-readable view. DB triggers auto-sync on INSERT/UPDATE.)	{executor}	{server-side-agent,supabase}	critical	t	2026-02-09 23:39:08.598762+00	2026-02-09 23:39:08.598762+00
7e96dc5d-7e53-4912-9c0d-f0ee9bef8c90	failure_archetype	budget_exhaustion	Pattern: Work order fails with "Budget exhausted" after 200k tokens. Diagnosis: Check iteration count (>15 = exploration spiral), check mutation:read ratio (<1:5 = too much querying), check if acceptance criteria are vague or scope is too broad. Remediation: (1) If iteration count high: Create focused child WO with single AC. (2) If read:write ratio high: Add explicit "implement first, verify second" directive. (3) If scope broad: Decompose into 2-3 smaller WOs. (4) Always include previous execution_log summary in remediation WO context.	{observer,executor}	{monitoring,remediation,ops}	critical	t	2026-02-10 23:36:24.164432+00	2026-02-10 23:36:24.164432+00
28811fc4-e2f3-4415-ad20-f2263629c593	failure_archetype	exploration_spiral	Pattern: High tool call count with low mutation rate (read:write ratio >5:1). Indicators: Multiple read_table, execute_sql SELECT queries; Few or no INSERT/UPDATE/apply_migration calls; Iteration count >10; Agent repeatedly reading same data. Root Causes: Unclear acceptance criteria; Agent unsure what to build; Missing required context (schema, examples). Remediation: (1) Add explicit schema context injection. (2) Provide concrete example from similar completed WO. (3) Rewrite ACs as imperative actions ("Create table X" not "Ensure X exists"). (4) Route to different model tier (opus for ambiguous, haiku for clear).	{observer,executor}	{monitoring,remediation,ops,qa}	critical	t	2026-02-10 23:36:24.164432+00	2026-02-10 23:36:24.164432+00
752a6db7-e626-47e8-8150-1ab0657aca57	failure_archetype	agent_task_mismatch	Pattern: Agent assigned to WO but lacks tools for task domain. Examples: Server-side agent (builder) assigned local-filesystem WO; Agent without github tools assigned code delivery WO; Agent without deploy tools assigned edge function deployment. Detection: Check WO tags against agent routing_tags; Check required tools (from acceptance criteria verbs) against agent tools_allowed; Check execution_mode (server vs local) mismatch. Remediation: (1) Auto-reassign to correct agent based on routing_tags. (2) Update work_orders.assigned_to to matching agent UUID. (3) Log reassignment to execution_log. (4) Do NOT create new WO, just reassign existing.	{observer,executor}	{monitoring,routing,ops}	important	t	2026-02-10 23:36:24.164432+00	2026-02-10 23:36:24.164432+00
c2b41830-7ecf-4591-aee0-6ee2335864bc	failure_archetype	circuit_breaker_loop	Pattern: Remediation WO fails, creates another remediation, exceeds max depth (3). Indicators: WO tags include "remediation" and "auto-qa-loop"; parent_id chain depth >3; Multiple consecutive failures in same remediation chain. Root Causes: Original problem unsolvable by automation; Insufficient context propagation between parent and child; Remediation WO has same scope issue as parent. Remediation: (1) STOP creating more remediation WOs. (2) Mark entire chain as requiring manual intervention. (3) Create incident report with full chain analysis. (4) Escalate to human reviewer. (5) Update parent WO with circuit_breaker tag.	{observer,qa}	{monitoring,remediation,ops,auto-qa}	critical	t	2026-02-10 23:36:24.164432+00	2026-02-10 23:36:24.164432+00
c6a56a00-3f95-48b7-aafd-75f9ae914f30	failure_archetype	scope_creep_detection	Pattern: WO acceptance criteria count grows during execution, or execution attempts to do more than stated. Indicators: Original AC count: 3, execution log shows 5+ distinct tasks; Summary mentions work "outside of scope" or "additionally"; Tool calls span multiple domains (DB + frontend + deployment). Root Causes: ACs written too vaguely ("improve X" instead of "add column Y to X"); Agent over-interprets objective; Agent attempts to fix related issues discovered during work. Remediation: (1) Compare original ACs to execution log actions. (2) If mismatch: create separate WO for out-of-scope work. (3) Update original WO ACs to be more specific. (4) Add directive: "Only complete stated ACs, create new WO for discovered issues".	{observer,qa,executor}	{monitoring,qa,ops,scope-management}	important	t	2026-02-10 23:36:24.164432+00	2026-02-10 23:36:24.164432+00
ee23b7a9-c4db-48bf-a9db-582261e18dc6	process	agent_execution_profiles_system	Agent execution profiles are defined in agent_execution_profiles table. Each agent has: mission (purpose), pace (aggressive/measured/conservative), error_style (retry-then-escalate/fail-fast/absorb-and-continue), scope_boundaries (allowed tools/tables/operations as JSONB), escalation_rules (when/how to escalate as JSONB), budget_guidance (max_turns, mutation_ratio_target, verification_budget_pct as JSONB), tool_categories (array of tool category names). Profiles incorporate external best practices: error classification (retriable vs non-retriable), 80/20 implement-first/verify-later split, hard budget limits per role, idempotency checks for mutation retries. RLS policies: all agents can read profiles, only ilmarinen can write. Profiles loaded by wo-agent context.ts and injected into system prompt, replacing generic execution rules.	{executor,general}	{agent-profiles,execution,behavioral-parameters}	important	t	2026-02-11 18:49:25.892441+00	2026-02-11 18:49:25.892441+00
5fca0733-790a-4886-98a1-f1ac1c0348b3	project_context	Portal tech stack: vanilla TypeScript + Vite	metis-portal2 is vanilla TypeScript + Vite. NO React, NO framework, NO JSX/TSX. All pages are plain .ts files that manipulate DOM directly. HTML entrypoints in root (index.html, workspace-new.html, dashboard.html, health.html). Source in src/. Styles in src/styles/. Components in src/components/ export functions that return HTMLElement, NOT React components. Package.json has zero framework dependencies — only vite, typescript, @types/node. NEVER create .tsx files or import React/shadcn/lucide-react. Use document.createElement, innerHTML, or template literals for UI.	{builder,frontend,ilmarinen}	{}	critical	t	2026-02-11 16:36:49.105986+00	2026-02-11 16:36:49.105986+00
83d466bf-fba1-4d07-9e10-5462af0f9af3	process	Do not introduce new file types or dependencies	Before creating a file with a new extension (e.g., .tsx when repo has only .ts, .py when repo has only .ts), CHECK existing file types with github_list_files first. Before importing a package not in package.json, STOP — you cannot add npm dependencies via GitHub API. If the WO objective does not explicitly request a new framework or dependency, do not introduce one. Stay within the existing tech stack.	{builder,frontend}	{}	critical	t	2026-02-11 16:39:56.612379+00	2026-02-11 16:39:56.612379+00
d043d116-dbad-4247-8941-3548f9978af8	qa_pattern	lesson_search_patterns	Lesson Search Patterns: Use searchLessons tool to query promoted lessons by category, tags, and agent_name. Filter by category for archetype-specific lessons (state_machine, tool_misuse, scope_creep). Filter by tags to match WO context (e.g., migration, schema, deployment). Filter by agent_name to get role-specific lessons. Results sorted by severity (critical > high > medium > low) then recency. Example: searchLessons({category: "state_machine", tags: ["migration"], agent_name: "builder", limit: 5}) returns migration-related state machine lessons relevant to builder agent.	{builder,ops,qa-gate}	{qa,remediation,triage}	important	t	2026-02-11 18:59:14.202092+00	2026-02-11 18:59:14.202092+00
56168ee0-6862-404c-aeda-6b91cbf930c2	process	per_agent_lesson_categories	Per-Agent Lesson Categories: Builder gets schema/migration/deployment lessons. QA-gate gets qa/testing/acceptance_criteria lessons. Ops gets monitoring/health/failure_detection lessons. Use agent_execution_profiles.scope_boundaries to determine relevant categories. When building agent context in context.ts, query lessons WHERE category IN (agent_relevant_categories) AND review_status = 'promoted'. Example: Builder context includes lessons with category IN ('schema', 'migration', 'deployment', 'enforcement', 'state_machine'). Ops context includes lessons with category IN ('monitoring', 'health', 'operational', 'remediation').	{builder,ops,qa-gate}	{process,context,agent-roles}	important	t	2026-02-11 18:59:14.202092+00	2026-02-11 18:59:14.202092+00
bc6ccd6d-3b07-43c9-a9c9-d38b424fbb95	remediation	triage_lesson_integration	Triage-Lesson Integration: When ops detects failure, query lessons for pattern match. Check: SELECT * FROM lessons WHERE review_status = 'promoted' AND (pattern ILIKE '%' || error_pattern || '%' OR rule ILIKE '%' || error_pattern || '%') ORDER BY severity DESC, created_at DESC LIMIT 3. If match found, include lesson fix in remediation WO objective. Store lesson hit in lesson_triage_hits (lesson_id, triage_id, match_score, applied). Sentinel populates monitor_triage_queue.related_lessons with matched lessons. Example: stuck WO detected → search lessons for "stuck" or "timeout" → find lesson about budget exhaustion → create remediation WO with lesson rule included in objective.	{ops,builder}	{remediation,triage,monitoring}	critical	t	2026-02-11 18:59:14.202092+00	2026-02-11 18:59:14.202092+00
023f7346-28f7-4a90-bd98-2447a0dc6a71	rpc_signature	EVALUATE_WO_LIFECYCLE_EVENT_TYPES	evaluate_wo_lifecycle(p_wo_id, p_event_type, p_event_context) — p_event_type must be 'checkpoint' to trigger circuit-breaker logic (mutation count check, review-vs-fail decision). Using 'continuation' always returns verdict=continue with no circuit breaker check. Wrong event_type = wrong verdict. Known incident: WO-0387 builder used 'continuation' instead of 'checkpoint', bypassing the 5-checkpoint guard entirely.	\N	{circuit-breaker,lifecycle}	critical	t	2026-02-11 20:22:41.854981+00	2026-02-11 20:22:41.854981+00
14ae238d-ea4d-4d9c-aecd-00ec42d62177	process	AC_SCOPING_FOR_BUILDER_WOS	Acceptance criteria must specify exact function names, exact file paths, exact RPC parameters, exact query patterns, exact column names. Builder (and all agents) interpret ACs literally. If an AC could reasonably be interpreted two different ways, it WILL be interpreted wrong. Known scoping failures: WO-0387 (wrong event_type because AC didn't specify), WO-0302 (missing dispatch cases because AC didn't list them). Write ACs as if the reader has zero context about the codebase.	\N	\N	critical	t	2026-02-11 20:22:41.854981+00	2026-02-11 20:22:41.854981+00
ffbd18e9-3e65-437b-9ffb-6629958eccd2	operational	MODEL_SELECTION_CONFIG_DRIVEN	Agent model must be read from agent_execution_profiles.model column at execution time, never hardcoded in source. Builder was hardcoded as claude-sonnet-4-5-20250929 in agent-loop.ts from WO-0187 (Feb 9) through WO-0401 (Feb 11) despite user specifying claude-opus-4-6. Over 200 WOs executed on wrong model. Config-driven selection via DB column prevents silent model downgrades and allows per-agent tuning.	{executor,builder}	\N	critical	t	2026-02-11 20:22:41.854981+00	2026-02-11 20:22:41.854981+00
883915d7-f848-4047-8771-4222ee12d0c0	best_practice	ATOMIC_ACCEPTANCE_CRITERIA	One verifiable outcome per AC. Specify exact function names, file paths, RPC parameters, column names, query patterns. Never use vague language like "set up", "handle", or "implement properly". If builder could interpret an AC two ways, it will pick wrong. Each AC should be independently testable with a single SQL query or file check.	\N	\N	critical	t	2026-02-11 20:23:37.221782+00	2026-02-11 20:23:37.221782+00
8eba95d1-131a-4918-a38a-8e0886132b58	best_practice	IDEMPOTENT_OPERATIONS	Prefer idempotent SQL: CREATE OR REPLACE, INSERT ON CONFLICT DO NOTHING/UPDATE, ALTER TABLE ADD COLUMN IF NOT EXISTS, DROP IF EXISTS. Migrations that fail midway and retry must not produce duplicate state. Never DROP then CREATE — use CREATE OR REPLACE. For data migrations, use ON CONFLICT to handle re-runs.	{executor,builder}	{migration,schema}	important	t	2026-02-11 20:23:37.221782+00	2026-02-11 20:23:37.221782+00
474f575b-7eb4-4bff-8680-402300a605b0	best_practice	PROGRESS_LOGGING_AFTER_EACH_AC	Call log_progress after completing each AC with format "AC#N DONE: <what was done>". Creates audit trail for QA evaluation, helps continuations know what was already accomplished, and prevents wasted budget re-discovering progress via read_execution_log. Without progress logging, continuations waste 2-3 turns (30+ seconds) figuring out what was done.	{executor,builder}	\N	important	t	2026-02-11 20:23:37.221782+00	2026-02-11 20:23:37.221782+00
525138fc-dcf4-47c2-b027-9ea8ad53c5c8	best_practice	COMPLETION_FIRST_STRATEGY	Implement changes first (migrations, code, SQL). Call mark_complete as soon as core changes are applied. Do NOT spend turns self-verifying — auto-QA handles verification and creates targeted remediations if needed. Agents that exhaustively self-verify burn 30%+ of their budget on redundant work. Known case: WO-0305 applied 3 migrations successfully but hit circuit breaker because it spent remaining budget verifying.	{executor,builder}	\N	important	t	2026-02-11 20:23:37.221782+00	2026-02-11 20:23:37.221782+00
ead924e4-d039-498c-808f-47db4f87e14c	best_practice	STRUCTURED_ERROR_CONTEXT	When logging errors or creating remediation WOs, include: (1) what was attempted (exact tool call + params), (2) what failed (exact error message), (3) what state was left behind (partial migration? half-written file? orphaned row?). Remediation WOs inherit this context — vague error logs produce vague remediations that fail the same way.	{executor,builder}	{remediation,failure}	important	t	2026-02-11 20:23:37.221782+00	2026-02-11 20:23:37.221782+00
44325151-62d3-4f58-b858-fb6c5e999442	best_practice	CONFIG_DRIVEN_NOT_HARDCODED	Models, timeouts, budgets, routing rules, feature flags must come from DB tables (agent_execution_profiles, system_settings, decision_gates) — never hardcoded constants in source code. Known failure: builder model hardcoded as Sonnet 4.5 for 200+ WOs despite Opus 4.6 being specified. Config-driven values can be changed without deploy, audited via audit_log, and tuned per-agent.	\N	\N	critical	t	2026-02-11 20:23:37.221782+00	2026-02-11 20:23:37.221782+00
6fecb0e7-5234-414d-a72f-8c5f70ad2776	best_practice	ESCALATION_THRESHOLDS	N failures at same level must escalate to next level, not retry forever. Circuit breaker at 5 checkpoints. Remediation per-WO circuit breaker at 3 attempts (tracked via client_info). If remediation of a remediation fails, escalate to ilmarinen or flag for human review. Never create infinite remediation chains.	\N	{remediation,failure,circuit-breaker}	important	t	2026-02-11 20:23:37.221782+00	2026-02-11 20:23:37.221782+00
c2c2480a-3952-4811-bc65-2385ee7b2f0c	enforcement	Master agent state transition controls (WO-0385)	All agents including ilmarinen must not cancel, close, or skip WOs without user approval. The update_work_order_state RPC enforces this via check_wo_approval(). Restricted transitions: any to cancelled (requires user approval record in audit_log within 5min), failed to done (hard blocked), review to done (requires approval or auto-QA auto-close via trigger). Unrestricted: in_progress to review, in_progress to failed, draft to ready, ready to in_progress. Every RPC call is logged to audit_log.	{master,builder,qa-gate,ops}	{enforcement,governance,transitions}	critical	t	2026-02-12 06:33:49.324043+00	2026-02-12 06:33:49.324043+00
d6fdb9fa-2cf1-4225-86d5-4a50eb288185	best_practice	Git history tools: git_log, git_diff, git_blame	Three git history tools are available: (1) git_log - get commit history for a file or repo, returns SHA/message/author/date. Use to understand when changes were made. (2) git_diff - compare two commits or branches, returns file-level diffs with patches. Use to review what changed between versions. (3) git_blame - line-level blame via GraphQL, shows which commit last modified each line range. Use to understand code ownership and when specific lines were changed.	{builder,qa-gate,security}	{github,git-history,git-log,git-diff,git-blame}	reference	t	2026-02-14 03:10:38.951301+00	2026-02-14 03:10:38.951301+00
4c6283db-1d3d-4477-bd0f-9ec1c7b56394	best_practice	read_full_file for large GitHub files	When github_read_file returns truncated content (GitHub Contents API has ~10k char limit), use read_full_file instead. read_full_file uses the Git Data API blob endpoint which returns full base64 content up to 100MB. Use read_full_file for any file over 10k characters such as agent-loop.ts, tools.ts, or other large source files. Parameters: path (required), repo (optional, default olivergale/metis-portal2), ref (optional, default main).	{executor}	{general}	important	t	2026-02-14 03:14:03.85453+00	2026-02-14 03:14:03.85453+00
0db7ffbc-4ec9-4895-a003-3c2f8f43e7e0	enforcement	Config mutation guardrails block non-master agents	Non-master agents CANNOT modify system configuration tables: agent_execution_profiles, agents (model/tools_allowed/status), llm_provider_config, system_settings. The config_mutation_guard_check() BEFORE UPDATE trigger blocks any UPDATE when app.wo_executor_bypass is set and app.current_agent_name is not ilmarinen. If a WO requires config changes (model switching, tool permissions, provider settings), escalate to the master agent or request manual admin intervention. Direct admin SQL (no bypass context) is unaffected.	{builder,qa-gate,ops,security,frontend}	{enforcement,security,config,migration}	critical	t	2026-02-14 03:30:08.308636+00	2026-02-14 03:30:08.308636+00
2b363d28-3011-4d91-8151-6298d5c2e17a	best_practice	patch_file_preferred_over_github_push_files	Use patch_file tool instead of github_push_files for modifying existing files. patch_file accepts old_string/new_string pairs which are more intuitive than search/replace arrays. Only use github_push_files for creating new files or complete rewrites.	{builder}	{github}	important	t	2026-02-14 03:44:16.806041+00	2026-02-14 03:44:16.806041+00
e38e70b5-e59a-4aaa-9d7f-e7257a36ca44	schema_gotcha	execute_sql DML routing via run_sql_void	execute_sql now auto-detects DML/DDL (INSERT/UPDATE/DELETE/CREATE/ALTER/DO/SET) and routes through run_sql_void (plain EXECUTE) instead of run_sql (which wraps in SELECT jsonb_agg subquery and breaks all non-SELECT statements). SELECT queries still use run_sql for result rows. SQL comments are stripped before keyword detection.	{builder,ilmarinen}	{wo-agent,edge-function}	critical	t	2026-02-14 03:50:29.902299+00	2026-02-14 03:50:29.902299+00
be112ea3-b9c4-405c-9198-1cc50b288b51	deployment	github_repo_paths	Primary repository: olivergale/metis-portal2. Edge functions are at: supabase/functions/<function-name>/index.ts. Frontend code at: src/. Database migrations at: supabase/migrations/. When using github_read_file or github_push_files, always use repo format "olivergale/metis-portal2" and correct path relative to repo root.	{executor}	{github,deployment}	important	t	2026-02-09 23:36:17.030832+00	2026-02-15 07:35:01.853391+00
5cffa105-09fb-4edd-9f14-9473b633a6f5	best_practice	sandbox_exec allowed commands	sandbox_exec tool allows ONLY read-only commands: grep, find, wc, cat, head, tail, echo, test, ls, file. All other commands are blocked. No writes, no pipes to files, no redirects. Use for codebase search, file inspection, and verification only. For file modifications use github_push_files.	{builder}	{edge-function,builder-parity}	critical	f	2026-02-14 04:24:19.479519+00	2026-02-15 08:46:42.915798+00
c1ff2439-e1b7-4bf5-ad28-f6aa4977a208	best_practice	sandbox_exec Fly Machine architecture	The sandbox_exec tool now routes to Fly Machine instead of Supabase Edge Functions. Key patterns:\n1. Read fly_machine_url and fly_machine_token from system_settings table\n2. POST to {fly_machine_url}/exec with {command, args, timeout_ms, wo_slug}\n3. First sandbox call per WO triggers git-pull via POST to {fly_machine_url}/git-pull\n4. Response mapping: {stdout, stderr, exit_code} → {success, output, error}\n5. 30s timeout via AbortController. On failure returns {success: false, error: message}\n6. ALLOWED_COMMANDS whitelist validates before API call	{builder}	{general}	reference	t	2026-02-14 04:58:57.524276+00	2026-02-14 04:58:57.524276+00
6b3f287f-ac9f-4d8a-8dba-9280dc87d8b0	enforcement	verify_before_memory_write	NEVER record a feature as complete in MEMORY.md until: (a) code changes are committed to GitHub, (b) edge function is deployed and verified via /status endpoint or direct test, (c) a test WO has exercised the new behavior. Plan files are NOT evidence of completion. Always reference verification records from execution_log when documenting completion.	{master,engineering}	{memory,completion,verification}	critical	t	2026-02-14 06:04:05.205131+00	2026-02-14 06:04:05.205131+00
07ef1de8-e493-429a-bbeb-3d8dc7d46a41	deployment	Memory Write Verification Gate	NEVER record a feature as complete in MEMORY.md until: (a) code changes are committed to GitHub, (b) edge function is deployed and verified via /status endpoint or direct test, (c) a test WO has exercised the new behavior. Plan files are NOT evidence of completion. False memory entries corrupt all future sessions.	{master,engineering}	{memory,completion,verification}	critical	t	2026-02-14 06:08:23.985593+00	2026-02-14 06:08:23.985593+00
edccfbae-c498-4eba-89e1-9e3c91bf2676	best_practice	read-after-write verification	After every github_push_files call, builder should verify file integrity via sandbox_exec cat and wc -c. Compare byte count against expected size. Mismatches indicate corruption (truncation or UTF-8 mangling). If mismatch detected, re-push the file.	{builder}	{general}	critical	t	2026-02-14 06:10:10.997259+00	2026-02-14 06:10:10.997259+00
bca89d37-5d06-4718-84ae-12f424690ae8	operational	qa-gate GitHub verification fallback	When the execution_log has fewer than 5 stream-phase entries (sparse logging detected), qa-gate should use github_grep and github_read_file to verify claimed code changes. Search for function names from acceptance criteria in the codebase and read files that are claimed to be modified. Include verification results in forensic evidence before rendering verdict. This prevents false negatives from lie detector when agent skips detailed logging.	{qa-gate,security,builder}	{general}	reference	t	2026-02-14 06:32:26.468942+00	2026-02-14 06:32:26.468942+00
ea557bac-775b-4926-81b5-e19ef35676a5	schema_gotcha	PostgreSQL enum ADD VALUE is the correct approach	To add a new value to an existing PostgreSQL enum type, use: ALTER TYPE <type_name> ADD VALUE 'new_value' [BEFORE|AFTER 'existing_value']. This works in PostgreSQL 12+ inside transactions. NEVER use the rename-swap approach (CREATE TYPE new, ALTER COLUMN TYPE new, DROP old) when views or defaults reference the column — it will fail with "cannot alter type of a column used by a view or rule". The ADD VALUE command does not require dropping views or removing defaults. Example: ALTER TYPE work_order_status ADD VALUE 'planning' BEFORE 'ready';	{builder,ilmarinen}	{migration,schema,state-machine}	critical	t	2026-02-14 06:42:02.334966+00	2026-02-14 06:42:02.334966+00
33d63868-e33b-4c95-95ea-d4f015b8dc9f	process	CLI Audit Trail Required	After every CLI action call log_cli_action and record_cli_mutation. No CLI work is exempt.	{ilmarinen}	{general}	critical	t	2026-02-14 17:05:05.100199+00	2026-02-14 17:05:05.100199+00
28cc7889-d61d-4b39-9443-e652778f7478	deployment	github_file_size_limits	GitHub read operations via github_read_file have a practical limit of ~10,000 characters due to token budget constraints. Files larger than this may fail or be truncated. For large files (>100 lines, >10k chars), prefer CLI-based operations routed to ilmarinen agent with local-filesystem tag. The github_push_files tool can handle larger files for writes, but reading them back for verification may fail.	{executor}	{github,deployment}	important	t	2026-02-09 23:36:17.030832+00	2026-02-15 07:35:01.853391+00
38bb0216-f0f6-43cb-95ff-e057d2b2311b	operational	Fly Sandbox: Allowed Commands and Usage	The Fly sandbox (https://endgame-sandbox.fly.dev) supports these commands ONLY:\ngrep, find, wc, cat, head, tail, echo, test, ls, file, diff, jq, node, npm, npx, tsc, python3, git, curl, sed, deno.\n\nBLOCKED commands: rm, mv, dd, chmod, chown, kill, reboot, shutdown, mkfs, fdisk.\n\nRuntimes available: Deno 2.6.9, Node 20.20.0, TypeScript 5.9.3, Python 3.\n\nUsage pattern: POST /exec with {"command":"<cmd>","args":["arg1","arg2"],"timeout_ms":30000,"wo_slug":"WO-XXXX"}\nThe wo_slug parameter creates an isolated git worktree for that WO.\n\nPOST /git-pull to clone/update the repo at /workspace/main.\nGET /health for health check.\n\nAll commands run in /workspace/main (or /workspace/<wo_slug> if wo_slug provided).\nWorkspace must be initialized via /git-pull before first use.	{builder,ilmarinen}	{edge-function,testing,sandbox}	critical	t	2026-02-14 16:05:49.510611+00	2026-02-15 08:46:42.915798+00
fa8f56f4-26cc-48c0-8b2f-8e9c6dce8ce6	enforcement	Use transition_state for WO state changes	Never directly UPDATE work_orders.status. Use transition_state tool which wraps wo_transition RPC. Enforces state machine, records state_mutations, triggers downstream effects.	{ops,qa-gate,builder}	{general}	critical	t	2026-02-15 23:38:20.062603+00	2026-02-15 23:38:20.062603+00
0e0bb7b2-6f9c-4134-8a8d-0a0b557ff582	qa_pattern	QA checks both qa_findings AND qa_checklist	QA system has two structures: qa_findings (table rows) and qa_checklist (JSONB on work_orders). Both must be updated. Three-state verdict: PASS, FAIL, PENDING.	{qa-gate}	{general}	critical	t	2026-02-15 23:38:20.062603+00	2026-02-15 23:38:20.062603+00
521245c8-8224-41cc-b446-8e876d8513f6	rpc_signature	create_draft_work_order 9-param version required	Use 9-param version with explicit p_acceptance_criteria. 6-param overload generates filler ACs that get rejected. Priority enum: p0_critical, p1_high, p2_medium, p3_low.	{metis,builder,ilmarinen}	{general}	critical	t	2026-02-15 23:38:20.062603+00	2026-02-15 23:38:20.062603+00
9e0c78ba-c25c-48bf-9888-2cf302351446	deployment	github_branch_conventions	Default branch is "main". All builder agent work should target main branch unless explicitly specified otherwise in WO requirements. When using github_read_file or github_push_files, omit branch parameter to use default (main), or specify branch explicitly for feature branches. Never assume "master" - always use "main".	{executor}	{github,deployment}	important	t	2026-02-09 23:36:17.030832+00	2026-02-15 07:35:01.853391+00
a93fdd3c-d5c7-4146-810d-9f19db928671	deployment	CI/CD auto-deploy via GitHub Actions	GitHub Actions workflow (.github/workflows/deploy-functions.yml) auto-deploys edge functions on push to main. Builder agents should commit code via github_push_files or github_push_files — the CI/CD pipeline will deploy automatically. No need for manual deploy_edge_function calls for large functions. Requires SUPABASE_ACCESS_TOKEN and SUPABASE_PROJECT_REF secrets in GitHub repo settings.	{builder,ilmarinen,ops}	{deployment,ci-cd,github-actions}	critical	t	2026-02-10 19:27:51.903102+00	2026-02-15 07:35:01.853391+00
54749873-1665-4c4d-9048-72fde021144c	agent_routing	Local-filesystem routing goes to builder	Since WO-0248 (daemon deprecated), local-filesystem tagged WOs route to builder, not ilmarinen. Builder has GitHub tools (github_push_files, github_list_files, github_create_branch, github_create_pr) and GitHub Actions handles edge function deploys. detect_local_filesystem_need() still detects filesystem patterns but auto_route_portal_insert routes them to builder.	{builder,ilmarinen,ops}	{routing,local-filesystem,builder}	critical	t	2026-02-11 06:51:54.481317+00	2026-02-15 07:35:01.853391+00
562d3f20-ba54-49f4-8c58-a9f72ba49204	best_practice	VERIFY_AFTER_MUTATE	After every write operation (migration, file edit, SQL update), read back the result to confirm state. Do not assume success from lack of error. Known failures: silent migration no-ops, github_push_files clobber where success response returned but file content was wrong. Pattern: mutate then SELECT/read then assert expected state.	{executor,builder}	{migration,schema,code-change,github}	critical	t	2026-02-11 20:23:37.221782+00	2026-02-15 07:35:01.853391+00
23a3c435-0ce5-438e-af26-390db12d72ee	operational	github_read_file truncates at 10K chars	github_read_file (Contents API) silently truncates files at ~10,000 characters. The agent receives partial content with NO indication it was cut off. This causes cascading failures: (1) Agent builds old_string from truncated read, (2) github_push_files fails with "old_string not found" because actual file differs, (3) Agent retries uselessly burning turns. MITIGATION: Before reading files >5K chars, check size first with github_tree or wc. Use github_read_file_range for large files. After any read, verify you got the full file.	{builder,ilmarinen}	{edge-function,wo-agent}	critical	t	2026-02-14 04:35:24.910563+00	2026-02-15 07:35:01.853391+00
e79f2357-ee31-47a0-aed7-56a55cc8afe5	best_practice	Verify file integrity after every write	After ANY file write operation (github_push_files, github_push_files, github_push_files), immediately verify: (1) File exists and is readable, (2) File size is within expected range (wc -c), (3) Key content is present (github_read_file_range on critical sections). Known incidents: tools.ts destroyed from 47KB to 696 bytes (WO-0588), snapshot-collector features silently dropped (WO-0361). A 2-second verification prevents hours of debugging.	{builder,ilmarinen}	{edge-function,wo-agent}	critical	t	2026-02-14 04:35:24.910563+00	2026-02-15 07:35:01.853391+00
728006eb-d641-4d84-8f24-15f385798916	best_practice	Deprecated GitHub file tools	github_edit_file, github_write_file, and github_patch_file are PERMANENTLY REMOVED. They used the GitHub Contents API which caused UTF-8 corruption via base64 round-trips. The ONLY tool for file changes is github_push_files (Git Data API: blobs→tree→commit→ref). Do NOT attempt to call deprecated tools — they will fail. Always use github_push_files with files array [{path, content}].	{general,builder,executor,frontend}	{general,supabase,migration,schema,remediation}	critical	t	2026-02-15 07:38:33.053697+00	2026-02-15 07:38:33.053697+00
6c13836b-16c1-49cf-b042-caa7b497913c	best_practice	ontology_object_registry	The object_registry table contains 3,510 typed system objects (tables, columns, functions, triggers, indexes, policies, views, enums, value_types). Each object has valid_actions (what operations are permitted), properties (data_type, is_nullable, etc.), and parent_id (e.g. column→table). Query it: SELECT object_name, valid_actions, properties FROM object_registry WHERE object_type='table' AND object_name LIKE '%work_orders%'. Use this to understand what you can do to a target object BEFORE attempting mutations.	{executor,general,specialist}	{general,manifold,ontology,migration}	important	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
a63383f1-0c11-48f6-8d0f-c403f935bacd	best_practice	ontology_object_links	The object_links table maps 519 relationships between system objects. Link types: fk (foreign keys), mutates (function→table writes), validates (constraint checks), triggers (trigger→table), calls (function→function), references (read dependencies), guards (security policies), depends_on, typed_by (column→value_type). Query: SELECT t.object_name, ol.link_type FROM object_links ol JOIN object_registry s ON s.id=ol.source_id JOIN object_registry t ON t.id=ol.target_id WHERE s.object_name='public.work_orders'. Use to understand impact radius before making changes.	{executor,general,specialist}	{general,manifold,ontology,migration}	important	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
73811d0a-c1b3-41e1-b501-a67ace5d303b	best_practice	interaction_definitions_contracts	The interaction_definitions table contains 15 declarative contracts defining how agents interact with system objects. Each has source_type, target_type, interaction_name, preconditions (JSONB), postconditions (JSONB), and failure_behavior (block/warn). Examples: agent→table execute_sql_write (precondition: table exists, postcondition: mutation recorded), agent→wo transition_state (precondition: valid transition). Query before executing unfamiliar operations to understand what's expected.	{executor,general,specialist,evaluator}	{general,manifold,state-machine}	important	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
ceeb12e0-90e7-4ae6-b3e8-da9fa2054657	process	manifold_pipeline_phases	WOs with pipeline_phase set follow the 7-stage Manifold pipeline: SPEC→PLAN→SCAFFOLD→BUILD→VERIFY→HARDEN→INTEGRATE. The advance_pipeline_phase() function auto-creates child WOs for each phase and logs transitions to wo_events. pipeline_runs tracks overall pipeline lifecycle. When your WO has a pipeline_phase, focus ONLY on that phase's objectives. SPEC=define requirements, PLAN=MCTS action planning (no LLM), SCAFFOLD=generate contracts, BUILD=implement, VERIFY=structural manifest comparison, HARDEN=adversarial red/blue team, INTEGRATE=spec oracle diff.	{executor,general,specialist,evaluator}	{general,manifold-v1,pipeline-phase}	critical	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
b981effc-42cc-4b0b-b82d-22220cc262c1	best_practice	mcts_action_success_rates	The action_success_rates materialized view shows historical success rates for every tool+action combination. Key data: apply_migration DDL 67.8%, execute_sql SELECT 92.8%, github_push_files PUSH 87.7%, execute_sql INSERT 28.0%, sandbox_exec 10%. Use SELECT * FROM action_success_rates WHERE tool_name='your_tool' to check probability of success BEFORE attempting a mutation. Low success rate tools need extra verification or alternative approaches. The mcts_plan_actions() function uses this data to rank action sequences.	{executor,general}	{general,manifold,planning}	important	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
78403d85-6b0e-4793-aed7-6d5066a6812d	process	execution_manifests_predicted_steps	wo_execution_manifest stores predicted_steps (JSONB array) for each WO—what the agent SHOULD do, generated from ontology + MCTS. After execution, compare_manifest_to_mutations() structurally diffs predicted steps against actual wo_mutations. This is the VERIFY phase—no LLM reasoning, pure data comparison. If your WO has an execution manifest, follow the predicted steps. Missing or extra mutations will be flagged in verification.	{executor,general,evaluator}	{general,manifold,verify}	important	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
df993713-38b6-4d93-8640-3faa2a6132fd	process	scaffold_contracts_type_checking	scaffold_contracts define input_schema, output_schema, preconditions, and postconditions for each object touched by a pipeline WO. validate_scaffold_contracts() checks type consistency. In SCAFFOLD phase: create contracts for each object you'll modify. In BUILD phase: your mutations must satisfy the contract postconditions. Contracts are structural (JSON Schema), not prose.	{executor,general}	{general,manifold,scaffold}	reference	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
7de356ac-e598-4d5f-a75c-4a41d9a87e0a	process	escalation_tiers_model_progression	Builder agent has 3 escalation tiers in agent_execution_profiles.escalation_tiers: Tier 0 = MiniMax M2.5 (fast/cheap), Tier 1 = Sonnet 4.5 (balanced), Tier 2 = Opus 4.6 (max capability). On circuit breaker failure, wo-agent checks if a higher tier exists before creating remediation WO. The tier model override is injected via client_info.escalation_model. Remediation WOs always use Opus 4.6 regardless of tier.	{executor,general,observer}	{general,manifold,escalation,wo-agent}	important	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
0f5ef9ef-6c02-4f45-8f47-c13271d9a001	deployment	sandbox_write_and_pipeline_tools	sandbox_write_file: writes files to /workspace in the Fly sandbox with audit trail. Path MUST start with /workspace. Uses node fs.writeFileSync via /exec. sandbox_pipeline: executes sequential commands via POST /pipeline endpoint. Commands run in order; non-zero exit stops pipeline and returns partial results. Both tools are in SANDBOX_TOOLS category. Write commands (mkdir,cp,mv,touch,tee) are chrooted to /workspace and audit-logged to /var/log/sandbox-audit.jsonl.	{executor,specialist}	{general,sandbox,infrastructure}	important	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
bd699761-2cf0-496f-ad8d-80a0ccb10fc8	schema_gotcha	value_types_jsonb_schemas	object_registry contains 12 value_type entries formalizing JSONB column schemas (wo_client_info, qa_checklist, etc.). Columns are linked to their value_type via typed_by links in object_links. Query: SELECT r.object_name, r.properties FROM object_registry r WHERE r.object_type='value_type'. Use these schemas to validate JSONB data before INSERT/UPDATE to avoid enforcement errors.	{executor,general}	{general,ontology,schema}	reference	t	2026-02-15 15:11:16.18411+00	2026-02-15 15:11:16.18411+00
d2aed376-1baf-4bbb-87b5-85c87fc5b390	best_practice	Frontend file commit pattern	ALWAYS use github_push_files for atomic multi-file commits. NEVER commit files individually. Include ALL related changes (HTML + TS + config) in a single commit.	{specialist}	{frontend,ui}	critical	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
01d99d08-3df8-425c-8cc9-bd0767f72aef	deployment	Vite multi-page entry points	Every new HTML page MUST be added to vite.config.ts build.rollupOptions.input. Without this, the page will not be included in production builds. Also add a vercel.json rewrite.	{specialist}	{frontend,ui}	critical	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
390cdfff-de26-4949-821c-6181cbbb574d	best_practice	Design token usage	Always use CSS custom properties from tokens.css (--bg-primary, --text-primary, --accent, etc). Never hardcode hex color values. This ensures theme consistency across all pages.	{specialist}	{frontend,ui}	important	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
3e7093ae-1783-4907-93e0-37c8a1139ebd	best_practice	Component factory pattern	Components are factory functions returning HTMLElement, NOT classes. Pattern: export function createComponent(props): HTMLElement { const el = document.createElement("div"); ... return el; }	{specialist}	{frontend,ui}	important	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
5eebe271-c6b4-4491-9da4-b0086a7b1f8c	best_practice	Supabase client usage	Use import { supabase } from "./utils/supabase" for RPC calls and realtime. Use import { apiFetch } from "./utils/api" for legacy REST calls. Do NOT create new client instances.	{specialist}	{frontend,ui}	important	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
96cae427-a196-450e-adc1-6f66dc789282	deployment	Frontend build verification	After ALL file changes, verify build passes: sandbox_exec with npx vite build. TypeScript strict mode is ON (noUnusedLocals, noUnusedParameters). Fix all errors before committing.	{specialist}	{frontend,ui}	critical	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
4a1885d6-d607-4b32-9b1a-b4fc8d33f3bc	schema_gotcha	No framework dependencies	The portal uses vanilla TypeScript. NEVER add React, Vue, Svelte, or any UI framework. Components are plain DOM manipulation with factory functions.	{specialist}	{frontend,ui}	important	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
6fba7bd3-058a-4cb2-b77a-d7c83e6e4a7c	schema_gotcha	HTML page shell pattern	New pages use lightweight HTML shells: DOCTYPE + head (Inter font, viewport meta) + body with div id=app and script type=module src=/src/page.ts. All logic in the TS module.	{specialist}	{frontend,ui}	important	t	2026-02-15 16:29:58.843561+00	2026-02-15 16:29:58.843561+00
7684c9f6-0c55-4bf8-bf42-32c4b22cc8f7	schema_gotcha	PostgreSQL word boundary regex	PostgreSQL regex uses \\m (start of word) and \\M (end of word) for word boundaries. JavaScript \\b does NOT work in PostgreSQL.	{builder,ilmarinen,frontend}	{sql-only,migration}	critical	t	2026-02-15 23:38:20.062603+00	2026-02-15 23:38:20.062603+00
909ea158-12b5-4857-bf77-0b91ca0c32e4	process	Record all mutations via record_mutation RPC	After every successful or failed mutation (SQL, file write, deploy), call record_mutation RPC. This powers checkpoint injection, continuation context, remediation context, and lie detector QA.	{builder,frontend}	{general}	critical	t	2026-02-15 23:38:20.062603+00	2026-02-15 23:38:20.062603+00
258de2d1-8358-489b-b5eb-766aeddf4a2b	process	Escalate after 2 consecutive failed approaches	When stuck after 2 different failed approaches to the same AC, call mark_failed with detailed error. Do NOT keep retrying. This triggers remediation routing to a higher-tier model or ilmarinen.	{builder,frontend}	{general}	important	t	2026-02-15 23:38:20.062603+00	2026-02-15 23:38:20.062603+00
72858d64-d691-4fd7-9eaf-e8a8ea048b1c	schema_gotcha	DDL Statement Timeout — Always Chunk Large Operations	Supabase has a statement timeout (~30s for migrations, ~120s for execute_sql). NEVER create/alter/add-RLS-to more than 3 tables in a single DDL statement. Break large operations into individual statements, one per table. For RLS policies: CREATE POLICY one table at a time. For bulk ALTER TABLE: one column change per statement. If you need to operate on N tables, make N separate execute_sql or apply_migration calls.	{builder,security,ilmarinen}	{migration,schema,rls,harden}	critical	t	2026-02-16 19:28:47.903028+00	2026-02-16 19:28:47.903028+00
f41362fe-d58e-4a83-aae0-9e8436280aa2	qa_pattern	Frontend mutation data uses m.success not m.status	The wo_mutations table has success (boolean) column, NOT status (text). Frontend components must use m.success === true/false, NOT m.status === 'success'/'failure'.	{general}	{frontend-qa,mutations}	critical	t	2026-02-16 20:44:39.518107+00	2026-02-16 20:44:39.518107+00
1e6ced4f-f2da-431b-98e8-3fa154a42c2f	qa_pattern	Frontend detail extraction should avoid raw JSON.stringify	When displaying execution_log.detail or mutations.context, use structured extraction first (check content, message, tool_name fields) before falling back to JSON.stringify. Raw JSON is unreadable and indicates component bug.	{general}	{frontend-qa,ui}	important	t	2026-02-16 20:44:39.518107+00	2026-02-16 20:44:39.518107+00
698a2b9a-6e47-4038-bd28-83feac5910a9	qa_pattern	TypeScript strict mode enforces noUnusedLocals and noUnusedParameters	All code must compile with TypeScript strict mode. Run deno check before committing. Unused variables cause build failures.	{general}	{frontend-qa,typescript}	critical	t	2026-02-16 20:44:39.518107+00	2026-02-16 20:44:39.518107+00
873b0f89-8ba2-48dd-84c9-00ae17954387	qa_pattern	Frontend QA: No raw JSON in UI	Never render raw JSON.stringify() in UI components. Always extract specific fields from detail objects using structured extraction (e.g., check content, message, tool_name fields before falling back to JSON.stringify). Raw JSON indicates a component bug.	{general}	{frontend,qa,ui}	critical	t	2026-02-16 22:47:56.488846+00	2026-02-16 22:47:56.488846+00
ac9aceb3-71fb-42be-98ff-b592efe58b5a	qa_pattern	Frontend QA: No undefined/null visible	All UI components must handle null/undefined values gracefully. Use optional chaining (?.) and nullish coalescing (??). Display placeholders or hide empty values instead of showing "undefined" or "null" strings.	{general}	{frontend,qa,ui}	critical	t	2026-02-16 22:47:56.488846+00	2026-02-16 22:47:56.488846+00
a1839804-430f-46d6-ac1f-aa5d498ac867	qa_pattern	Frontend QA: No broken click handlers	All clickable elements must have valid event handlers. Check for null/undefined onClick props. Ensure navigation links have valid href. Verify callback functions exist before calling.	{general}	{frontend,qa,interactivity}	important	t	2026-02-16 22:47:56.488846+00	2026-02-16 22:47:56.488846+00
2e4a1df5-875b-4fcb-aa9b-017299769ce6	qa_pattern	Frontend QA: No unstyled fallbacks	Components must not fall through to raw HTML elements as a visual fallback. All states (loading, error, empty, success) must have explicit styling. Use proper CSS classes, not browser defaults.	{general}	{frontend,qa,styling}	important	t	2026-02-16 22:47:56.488846+00	2026-02-16 22:47:56.488846+00
a4b60077-0e38-4cbb-a9c2-665c12e48bed	best_practice	Chunked DDL — One table per migration	NEVER ALTER or CREATE more than 3 tables in a single DDL statement or migration. The statement_timeout is 2 minutes. Large DDL with many tables will be killed mid-execution. Break into smaller migrations, each 1-3 tables. For large DDL, prepend SET LOCAL statement_timeout = '600000' (10 min) — transaction-scoped, resets automatically.	{builder}	{sql,migration}	critical	t	2026-02-16 23:25:59.366116+00	2026-02-16 23:25:59.366116+00
5a590530-d75a-4dd0-b0e4-5602f183f8f4	best_practice	github_push_files file size validation guardrail	github_push_files rejects pushes that shrink any file by >50%. Before creating Git blobs, the tool checks each file's current size on the target branch via GitHub Contents API. If the new content would be less than 50% of the current file size, the push is rejected with an error message showing old size, new size, and percent reduction. This prevents truncation incidents like WO-0588 where MiniMax M2.5 output truncated file content that was then committed and deployed. New files (not yet on branch) skip the size check. If you legitimately need to delete most of a file's content, use a separate delete tool or split the change into smaller commits.	{executor,builder}	{guardrails,github,file-integrity}	critical	t	2026-02-17 15:38:05.435384+00	2026-02-17 15:38:05.435384+00
\.


--
-- Data for Name: kernel_spec; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.kernel_spec (id, version, spec, spec_hash, created_at, created_by) FROM stdin;
1	1.0.0	{"meta": {"generated_at": "2026-02-18T03:40:25.252442+00:00", "effects_count": 18, "generated_from": "wo_state_machine + wo_effect_registry", "transitions_count": 24}, "states": {"done": {"terminal": true, "description": "Successfully completed"}, "draft": {"terminal": false, "description": "Initial state, awaiting approval"}, "ready": {"terminal": false, "description": "Approved, awaiting execution start"}, "failed": {"terminal": false, "description": "Execution failed"}, "review": {"terminal": false, "description": "QA review in progress"}, "blocked": {"terminal": false, "description": "Blocked on dependency"}, "planning": {"terminal": false, "description": "Decomposition/planning phase"}, "cancelled": {"terminal": true, "description": "Cancelled by user or system"}, "in_progress": {"terminal": false, "description": "Agent actively executing"}, "blocked_on_input": {"terminal": false, "description": "Blocked awaiting clarification"}, "pending_approval": {"terminal": false, "description": "Awaiting human approval"}}, "effects": {"done": [{"type": "unblock_dependents", "order": 10, "config": {"function": "auto_unblock_dependents_for_wo"}, "handler": "sql_call"}, {"type": "advance_pipeline", "order": 20, "config": {"function": "advance_pipeline_phase"}, "handler": "sql_call"}, {"type": "close_parent_remediation", "order": 30, "config": {"function": "close_parent_on_remediation"}, "handler": "sql_call"}, {"type": "settle_children", "order": 40, "config": {}, "handler": "sql_call"}, {"type": "resume_parent", "order": 45, "config": {}, "handler": "sql_call"}, {"type": "unblock_pipelines", "order": 50, "config": {}, "handler": "process_wo_effect"}], "ready": [{"type": "auto_start", "order": 10, "config": {"function": "auto_start"}, "handler": "sql_call"}], "failed": [{"type": "spawn_remediation", "order": 10, "config": {"function": "spawn_remediation"}, "handler": "sql_call"}, {"type": "escalate_parent_failure", "order": 20, "config": {}, "handler": "sql_call"}, {"type": "settle_children", "order": 25, "config": {}, "handler": "sql_call"}, {"type": "resume_parent", "order": 30, "config": {}, "handler": "sql_call"}, {"type": "audit_failure", "order": 35, "config": {}, "handler": "sql_call"}], "review": [{"type": "populate_qa_checklist", "order": 5, "config": {"function": "parse_criteria_to_checklist"}, "handler": "sql_call"}, {"type": "trigger_qa", "order": 10, "config": {"endpoint": "/functions/v1/auto-qa"}, "handler": "pg_net_post"}], "cancelled": [{"type": "settle_children", "order": 10, "config": {}, "handler": "sql_call"}, {"type": "resume_parent", "order": 20, "config": {}, "handler": "sql_call"}], "in_progress": [{"type": "dispatch_agent", "order": 10, "config": {"endpoint": "/functions/v1/wo-agent"}, "handler": "pg_net_post"}, {"type": "schedule_liveness_check", "order": 20, "config": {"endpoint": "/functions/v1/health-check"}, "handler": "pg_net_post"}]}, "invariants": {}, "transitions": [{"event": "approve", "guard": null, "effects": [{"type": "approved_at", "value": "now()"}], "to_status": "ready", "from_status": "draft", "preconditions": [], "postconditions": []}, {"event": "pipeline_dispatch", "guard": null, "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "draft", "preconditions": [], "postconditions": []}, {"event": "submit_for_planning", "guard": null, "effects": [], "to_status": "planning", "from_status": "draft", "preconditions": [], "postconditions": []}, {"event": "complete_planning", "guard": null, "effects": [], "to_status": "ready", "from_status": "planning", "preconditions": [], "postconditions": []}, {"event": "start_work", "guard": "guard_start_work", "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "ready", "preconditions": [], "postconditions": []}, {"event": "approve", "guard": null, "effects": [{"type": "approved_at", "value": "now()"}], "to_status": "ready", "from_status": "pending_approval", "preconditions": [], "postconditions": []}, {"event": "mark_done", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}], "to_status": "done", "from_status": "in_progress", "preconditions": [], "postconditions": []}, {"event": "mark_failed", "guard": null, "effects": ["spawn_remediation"], "to_status": "failed", "from_status": "in_progress", "preconditions": [], "postconditions": []}, {"event": "report_blocked", "guard": null, "effects": [], "to_status": "blocked", "from_status": "in_progress", "preconditions": [], "postconditions": []}, {"event": "submit_for_review", "guard": "guard_remediation_qa_tools", "effects": [], "to_status": "review", "from_status": "in_progress", "preconditions": [], "postconditions": []}, {"event": "mark_failed", "guard": null, "effects": [], "to_status": "failed", "from_status": "blocked", "preconditions": [], "postconditions": []}, {"event": "start_work", "guard": "guard_start_work", "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "blocked", "preconditions": [], "postconditions": []}, {"event": "unblock", "guard": null, "effects": [], "to_status": "in_progress", "from_status": "blocked", "preconditions": [], "postconditions": []}, {"event": "mark_done", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}], "to_status": "done", "from_status": "review", "preconditions": [], "postconditions": []}, {"event": "qa_failed", "guard": null, "effects": [{"type": "qa_review_verified_at", "value": null}], "to_status": "in_progress", "from_status": "review", "preconditions": [], "postconditions": []}, {"event": "qa_passed", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}, {"type": "qa_review_verified_at", "value": "now()"}], "to_status": "done", "from_status": "review", "preconditions": [], "postconditions": []}, {"event": "reopen", "guard": null, "effects": [], "to_status": "ready", "from_status": "done", "preconditions": [], "postconditions": []}, {"event": "reopen", "guard": null, "effects": [], "to_status": "ready", "from_status": "cancelled", "preconditions": [], "postconditions": []}, {"event": "mark_done", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}], "to_status": "done", "from_status": "failed", "preconditions": [], "postconditions": []}, {"event": "request_retry", "guard": "guard_retry_limit", "effects": [{"type": "increment_retry_count", "value": 1}], "to_status": "ready", "from_status": "failed", "preconditions": [], "postconditions": []}, {"event": "retry", "guard": "guard_retry_limit", "effects": [{"type": "increment_retry_count", "value": 1}], "to_status": "ready", "from_status": "failed", "preconditions": [], "postconditions": []}, {"event": "mark_failed", "guard": null, "effects": [], "to_status": "failed", "from_status": "blocked_on_input", "preconditions": [], "postconditions": []}, {"event": "start_work", "guard": "guard_start_work", "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "blocked_on_input", "preconditions": [], "postconditions": []}, {"event": "unblock", "guard": null, "effects": [], "to_status": "in_progress", "from_status": "blocked_on_input", "preconditions": [], "postconditions": []}]}	ba17ae7feb57ea37a24fa6d40cd2f8af55a762231ab5fe0e4b44e05ac0643500	2026-02-18 03:40:25.252442+00	ilmarinen
2	0.0.1-test	{"states": {}, "effects": {}, "invariants": {"has_name": {"type": "field_present", "field": "name"}, "both_fields": {"type": "composite_and", "invariants": ["has_objective", "has_name"]}, "has_objective": {"type": "field_present", "field": "objective", "message": "Must have objective"}, "retry_under_max": {"type": "expression", "message": "Max retries exhausted", "operator": "<", "left_field": "retry_count", "right_field": "max_retries"}, "status_is_draft": {"type": "field_equals", "field": "status", "expected": "draft"}}, "transitions": []}	test	2026-02-18 03:49:26.66525+00	test
3	1.1.0	{"meta": {"changelog": "Replaced guard_start_work, guard_retry_limit, guard_remediation_qa_tools with declarative invariants", "generated_at": "2026-02-18T03:52:01.090689+00:00", "effects_count": 18, "generated_from": "kernel_spec v1.0.0 + invariant definitions (K006)", "invariants_count": 7, "transitions_count": 24}, "states": {"done": {"terminal": true, "description": "Successfully completed"}, "draft": {"terminal": false, "description": "Initial state, awaiting approval"}, "ready": {"terminal": false, "description": "Approved, awaiting execution start"}, "failed": {"terminal": false, "description": "Execution failed"}, "review": {"terminal": false, "description": "QA review in progress"}, "blocked": {"terminal": false, "description": "Blocked on dependency"}, "planning": {"terminal": false, "description": "Decomposition/planning phase"}, "cancelled": {"terminal": true, "description": "Cancelled by user or system"}, "in_progress": {"terminal": false, "description": "Agent actively executing"}, "blocked_on_input": {"terminal": false, "description": "Blocked awaiting clarification"}, "pending_approval": {"terminal": false, "description": "Awaiting human approval"}}, "effects": {"done": [{"type": "unblock_dependents", "order": 10, "config": {"function": "auto_unblock_dependents_for_wo"}, "handler": "sql_call"}, {"type": "advance_pipeline", "order": 20, "config": {"function": "advance_pipeline_phase"}, "handler": "sql_call"}, {"type": "close_parent_remediation", "order": 30, "config": {"function": "close_parent_on_remediation"}, "handler": "sql_call"}, {"type": "settle_children", "order": 40, "config": {}, "handler": "sql_call"}, {"type": "resume_parent", "order": 45, "config": {}, "handler": "sql_call"}, {"type": "unblock_pipelines", "order": 50, "config": {}, "handler": "process_wo_effect"}], "ready": [{"type": "auto_start", "order": 10, "config": {"function": "auto_start"}, "handler": "sql_call"}], "failed": [{"type": "spawn_remediation", "order": 10, "config": {"function": "spawn_remediation"}, "handler": "sql_call"}, {"type": "escalate_parent_failure", "order": 20, "config": {}, "handler": "sql_call"}, {"type": "settle_children", "order": 25, "config": {}, "handler": "sql_call"}, {"type": "resume_parent", "order": 30, "config": {}, "handler": "sql_call"}, {"type": "audit_failure", "order": 35, "config": {}, "handler": "sql_call"}], "review": [{"type": "populate_qa_checklist", "order": 5, "config": {"function": "parse_criteria_to_checklist"}, "handler": "sql_call"}, {"type": "trigger_qa", "order": 10, "config": {"endpoint": "/functions/v1/auto-qa"}, "handler": "pg_net_post"}], "cancelled": [{"type": "settle_children", "order": 10, "config": {}, "handler": "sql_call"}, {"type": "resume_parent", "order": 20, "config": {}, "handler": "sql_call"}], "in_progress": [{"type": "dispatch_agent", "order": 10, "config": {"endpoint": "/functions/v1/wo-agent"}, "handler": "pg_net_post"}, {"type": "schedule_liveness_check", "order": 20, "config": {"endpoint": "/functions/v1/health-check"}, "handler": "pg_net_post"}]}, "invariants": {"has_objective": {"type": "field_present", "field": "objective", "message": "Work order must have an objective"}, "complexity_gate": {"type": "query", "message": "WO complexity exceeds threshold — decompose into smaller WOs", "function": "check_complexity_invariant"}, "retry_under_max": {"type": "query", "message": "Max retries exhausted", "function": "check_retry_limit_invariant"}, "start_work_ready": {"type": "composite_and", "message": "Start work prerequisites not met", "invariants": ["complexity_gate", "pre_execution_gate"]}, "has_assigned_agent": {"type": "field_present", "field": "assigned_to", "message": "Work order must have an assigned agent"}, "pre_execution_gate": {"type": "query", "message": "Pre-execution quality gate failed", "function": "check_pre_execution_invariant"}, "remediation_qa_tools": {"type": "query", "message": "Remediation WO has unresolved findings but QA tools were not called", "function": "check_remediation_qa_tools_invariant"}}, "transitions": [{"event": "approve", "guard": null, "effects": [{"type": "approved_at", "value": "now()"}], "to_status": "ready", "from_status": "draft", "preconditions": [], "postconditions": []}, {"event": "pipeline_dispatch", "guard": null, "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "draft", "preconditions": [], "postconditions": []}, {"event": "submit_for_planning", "guard": null, "effects": [], "to_status": "planning", "from_status": "draft", "preconditions": [], "postconditions": []}, {"event": "complete_planning", "guard": null, "effects": [], "to_status": "ready", "from_status": "planning", "preconditions": [], "postconditions": []}, {"event": "start_work", "guard": null, "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "ready", "preconditions": ["complexity_gate", "pre_execution_gate"], "postconditions": []}, {"event": "approve", "guard": null, "effects": [{"type": "approved_at", "value": "now()"}], "to_status": "ready", "from_status": "pending_approval", "preconditions": [], "postconditions": []}, {"event": "mark_done", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}], "to_status": "done", "from_status": "in_progress", "preconditions": [], "postconditions": []}, {"event": "mark_failed", "guard": null, "effects": ["spawn_remediation"], "to_status": "failed", "from_status": "in_progress", "preconditions": [], "postconditions": []}, {"event": "report_blocked", "guard": null, "effects": [], "to_status": "blocked", "from_status": "in_progress", "preconditions": [], "postconditions": []}, {"event": "submit_for_review", "guard": null, "effects": [], "to_status": "review", "from_status": "in_progress", "preconditions": ["remediation_qa_tools"], "postconditions": []}, {"event": "mark_failed", "guard": null, "effects": [], "to_status": "failed", "from_status": "blocked", "preconditions": [], "postconditions": []}, {"event": "start_work", "guard": null, "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "blocked", "preconditions": ["complexity_gate", "pre_execution_gate"], "postconditions": []}, {"event": "unblock", "guard": null, "effects": [], "to_status": "in_progress", "from_status": "blocked", "preconditions": [], "postconditions": []}, {"event": "mark_done", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}], "to_status": "done", "from_status": "review", "preconditions": [], "postconditions": []}, {"event": "qa_failed", "guard": null, "effects": [{"type": "qa_review_verified_at", "value": null}], "to_status": "in_progress", "from_status": "review", "preconditions": [], "postconditions": []}, {"event": "qa_passed", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}, {"type": "qa_review_verified_at", "value": "now()"}], "to_status": "done", "from_status": "review", "preconditions": [], "postconditions": []}, {"event": "reopen", "guard": null, "effects": [], "to_status": "ready", "from_status": "done", "preconditions": [], "postconditions": []}, {"event": "reopen", "guard": null, "effects": [], "to_status": "ready", "from_status": "cancelled", "preconditions": [], "postconditions": []}, {"event": "mark_done", "guard": null, "effects": [{"type": "completed_at", "value": "now()"}], "to_status": "done", "from_status": "failed", "preconditions": [], "postconditions": []}, {"event": "request_retry", "guard": null, "effects": [{"type": "increment_retry_count", "value": 1}], "to_status": "ready", "from_status": "failed", "preconditions": ["retry_under_max"], "postconditions": []}, {"event": "retry", "guard": null, "effects": [{"type": "increment_retry_count", "value": 1}], "to_status": "ready", "from_status": "failed", "preconditions": ["retry_under_max"], "postconditions": []}, {"event": "mark_failed", "guard": null, "effects": [], "to_status": "failed", "from_status": "blocked_on_input", "preconditions": [], "postconditions": []}, {"event": "start_work", "guard": null, "effects": [{"type": "started_at", "value": "now()"}], "to_status": "in_progress", "from_status": "blocked_on_input", "preconditions": ["complexity_gate", "pre_execution_gate"], "postconditions": []}, {"event": "unblock", "guard": null, "effects": [], "to_status": "in_progress", "from_status": "blocked_on_input", "preconditions": [], "postconditions": []}]}	0d491abdfd58c2e995f2e42c52789f8b08cef64f2ffe894d42c247671520d5ea	2026-02-18 03:52:01.090689+00	ilmarinen
\.


--
-- Data for Name: request_schemas; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.request_schemas (id, endpoint, method, schema, requires_auth, rate_limit_per_minute, enabled, created_at) FROM stdin;
7628885f-6dab-4245-bfcc-1a4780795085	/portal-chat	POST	{"type": "object", "required": ["message"], "properties": {"message": {"type": "string", "maxLength": 100000}}}	f	60	t	2026-02-03 21:01:54.013207+00
3ef7dabd-c9f1-4814-a561-2e533f27cfc7	/state-write	POST	{"type": "object", "required": ["mutation_type", "target_table", "payload"], "properties": {"payload": {"type": "object"}, "target_table": {"type": "string"}, "mutation_type": {"enum": ["INSERT", "UPDATE", "DELETE"]}}}	t	60	t	2026-02-03 21:01:54.013207+00
f6cf3265-3b3d-4001-a58a-c931c0f99060	/work-order-executor/approve	POST	{"type": "object", "required": ["work_order_id"], "properties": {"approved_by": {"type": "string"}, "work_order_id": {"type": "string", "format": "uuid"}}}	f	60	t	2026-02-03 21:01:54.013207+00
3f8ce524-103f-45a6-8c04-67e478a04a6d	/work-order-executor/claim	POST	{"type": "object", "required": ["work_order_id"], "properties": {"work_order_id": {"type": "string", "format": "uuid"}}}	f	60	t	2026-02-03 21:01:54.013207+00
41e5f332-596e-4aaa-8858-70b42feac470	/work-order-executor/complete	POST	{"type": "object", "required": ["work_order_id"], "properties": {"summary": {"type": "string"}, "work_order_id": {"type": "string", "format": "uuid"}}}	f	60	t	2026-02-03 21:01:54.013207+00
4fcf8463-4f58-4e72-b574-25c1c73e0736	/work-order-executor/accept	POST	{"type": "object", "required": ["work_order_id"], "properties": {"work_order_id": {"type": "string", "format": "uuid"}}}	f	60	t	2026-02-03 22:16:29.491675+00
7612e678-192a-4ec3-855d-759f44fe54af	/work-order-executor/reject	POST	{"type": "object", "required": ["work_order_id"], "properties": {"reason": {"type": "string"}, "work_order_id": {"type": "string", "format": "uuid"}}}	f	60	t	2026-02-03 22:16:29.491675+00
3c70a3ae-9204-474d-a4b8-14e3901f9985	/work-order-executor/fail	POST	{"type": "object", "required": ["work_order_id"], "properties": {"reason": {"type": "string"}, "work_order_id": {"type": "string", "format": "uuid"}}}	f	60	t	2026-02-03 22:16:29.491675+00
09c382b9-d8a5-4b44-9a92-794064e9db8e	/work-order-executor/phase	POST	{"type": "object", "required": ["work_order_id", "phase"], "properties": {"phase": {"type": "string"}, "detail": {"type": "object"}, "work_order_id": {"type": "string", "format": "uuid"}}}	f	60	t	2026-02-03 22:16:29.491675+00
8fbfcfaf-8338-40a2-91a5-fa423f3da39b	/work-order-executor/refine-stale	POST	{"type": "object", "required": ["work_order_id"], "properties": {"work_order_id": {"type": "string", "format": "uuid"}}}	f	30	t	2026-02-07 05:16:58.991659+00
958843a8-c4d4-441a-95f3-affdc585ea2e	/work-order-executor/auto-qa	POST	{"type": "object", "required": ["work_order_id"], "properties": {"work_order_id": {"type": "string", "format": "uuid"}, "execution_output": {"type": "string"}}}	f	30	t	2026-02-07 05:16:58.991659+00
f2b465b9-b7f5-424b-969f-56ea7f6d7d7a	/work-order-executor/poll	GET	{"type": "object", "properties": {}}	f	60	t	2026-02-07 17:54:02.451503+00
35112dcf-90d1-494f-9107-c2408d0a5c97	/work-order-executor/status	GET	{"type": "object", "properties": {}}	f	60	t	2026-02-07 17:54:02.451503+00
7390f761-f2e4-4c30-bee3-08b12d669bb2	/work-order-executor/logs	GET	{"type": "object", "properties": {}}	f	30	t	2026-02-07 17:54:02.451503+00
99ef3ab8-ceae-4c1b-aefe-554abdb02cad	/work-order-executor/manifest	GET	{"type": "object", "properties": {}}	f	30	t	2026-02-07 17:54:02.451503+00
a6376628-a1d1-4460-8fe8-210fa02010e3	/staging-workflow	POST	{"type": "object", "required": ["functionName", "functionSlug", "sourceCode"], "properties": {"verifyJwt": {"type": "boolean"}, "sourceCode": {"type": "string"}, "functionName": {"type": "string"}, "functionSlug": {"type": "string"}, "entrypointPath": {"type": "string"}}}	t	60	t	2026-02-07 22:14:39.569404+00
e842c51a-b808-4f17-a2be-b1e623736f1b	/work-order-executor/consolidate	POST	{"type": "object", "properties": {"reason": {"type": "string"}, "duplicates": {"type": "array"}, "primary_id": {"type": "string"}, "work_order_id": {"type": "string"}, "work_order_ids": {"type": "array"}}}	f	30	t	2026-02-06 16:14:36.386792+00
a66bf38c-b65e-4858-add8-166453672d89	/work-order-executor/rollback	POST	{"type": "object", "required": ["function_slug"], "properties": {"reason": {"type": "string"}, "function_slug": {"type": "string"}, "work_order_id": {"type": "string"}, "target_version": {"type": "string"}}}	t	60	t	2026-02-08 01:40:15.394465+00
ba42b791-e622-4cc2-82e0-247f564b19db	/frontend-smoke-test	POST	{"type": "object", "required": ["payload", "work_order_id"], "properties": {"type": {"type": "string", "description": "Webhook event type (e.g., deployment.succeeded)"}, "payload": {"type": "object", "required": ["deployment"], "properties": {"project": {"type": "object", "properties": {"id": {"type": "string"}, "name": {"type": "string"}}}, "deployment": {"type": "object", "required": ["url"], "properties": {"id": {"type": "string"}, "url": {"type": "string"}, "state": {"type": "string"}, "created": {"type": "number"}}}}}, "work_order_id": {"type": "string", "format": "uuid", "description": "Work order ID to link smoke test results"}}}	f	30	t	2026-02-08 06:44:52.210978+00
c09e083a-1ae7-4033-86c0-130b4df3e92a	/wo-agent/execute	POST	{"type": "object", "required": ["work_order_id"], "properties": {"work_order_id": {"type": "string", "description": "UUID of the work order to execute"}}}	t	60	t	2026-02-09 06:49:08.797615+00
bb2f7607-26bc-436c-b61d-0a55a441b493	/wo-agent/status	POST	{"type": "object", "required": ["work_order_id"], "properties": {"work_order_id": {"type": "string", "description": "UUID of the work order to check status"}}}	t	60	t	2026-02-09 06:49:08.797615+00
f172408f-7e4b-4ef4-bd06-3c7e320ec7e0	/work-order-executor/reprioritize	POST	{"type": "object", "properties": {"trigger": {"enum": ["insert", "cron", "manual"], "type": "string"}, "new_wo_id": {"type": "string"}}, "additionalProperties": false}	t	60	t	2026-02-09 16:20:25.96923+00
8c425494-05d8-4bfe-9bb0-ca92d4a47a51	/reprioritize	POST	{"type": "object", "properties": {"trigger": {"enum": ["manual", "insert", "cron"], "type": "string"}}}	f	10	t	2026-02-09 16:26:13.061944+00
1aef3ed4-dc5d-40a9-813c-b87c402a2087	/get-scorecard	GET	{"type": "object", "properties": {"limit": {"type": "number", "maximum": 100, "minimum": 1}, "work_order_id": {"type": "string", "format": "uuid"}, "work_order_slug": {"type": "string"}}}	t	60	t	2026-02-10 23:49:56.235709+00
61f1f433-689f-4b6a-85d0-35aa42a6ec42	sentinel	POST	{"type": "object", "properties": {"trigger": {"enum": ["cron", "manual"], "type": "string"}}}	t	60	t	2026-02-11 19:25:19.54789+00
1151e6f5-d37f-419d-8700-0cba5529c9ce	/diagnostician	POST	{"type": "object", "properties": {"force": {"type": "boolean", "description": "Force processing even if no items in queue"}}}	f	10	t	2026-02-11 19:32:34.43989+00
501da648-6e54-42a4-b218-dd530e71718b	/functions/v1/kernel/paths	GET	{"wo_id": "uuid (path param)", "target": "text", "max_depth": "int"}	t	60	t	2026-02-18 04:13:39.741128+00
d408760b-15f8-443c-a85b-3d5214b6cf95	llm-call	POST	{"type": "object", "required": ["messages"], "properties": {"model": {"type": "string"}, "tools": {"type": "array"}, "agent_id": {"type": "string"}, "messages": {"type": "array"}, "max_tokens": {"type": "integer"}, "temperature": {"type": "number"}, "work_order_id": {"type": "string"}, "response_format": {"type": "object"}}}	f	120	t	2026-02-14 01:25:14.294803+00
6cad6b6d-5ef5-4649-9e39-e53da9a922b2	/sandbox-exec	POST	{"type": "object", "required": ["command", "args"], "properties": {"args": {"type": "array", "items": {"type": "string"}}, "files": {"type": "array"}, "command": {"type": "string"}, "timeout_ms": {"type": "number", "maximum": 120000, "minimum": 1000}, "work_order_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-14 01:26:17.296331+00
30a817fa-1b9c-4f61-8dd9-cca8f3fa31b9	/request-clarification	POST	{"type": "object", "required": ["work_order_id", "question"], "properties": {"context": {"type": "string"}, "options": {"type": "array", "items": {"type": "string"}}, "urgency": {"enum": ["low", "normal", "high"], "type": "string"}, "question": {"type": "string"}, "work_order_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-14 01:27:56.84883+00
65cb9f56-3c52-42f1-90f3-365a2c46db2a	/answer-clarification	POST	{"type": "object", "required": ["clarification_id", "response", "responded_by"], "properties": {"response": {"type": "string"}, "responded_by": {"type": "string"}, "clarification_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-14 01:27:56.84883+00
229e21cc-4f49-4df1-b787-44f237880e1a	/check-clarification	POST	{"type": "object", "required": ["clarification_id"], "properties": {"clarification_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-14 01:27:56.84883+00
e8376c60-80a3-4a7a-b3ec-e9acb0606dc7	/llm-call	POST	{"type": "object", "required": ["messages"], "properties": {"model": {"type": "string"}, "tools": {"type": "array"}, "agent_id": {"type": "string"}, "messages": {"type": "array", "items": {"type": "object", "required": ["role", "content"], "properties": {"role": {"type": "string"}, "content": {"type": "string"}}}}, "max_tokens": {"type": "integer"}, "temperature": {"type": "number"}, "work_order_id": {"type": "string"}, "response_format": {"type": "object"}}}	t	60	t	2026-02-14 01:28:57.731531+00
08f46f9b-971f-43b9-93fd-48edae5e83b7	request-clarification	POST	{"type": "object", "required": ["work_order_id", "question"], "properties": {"context": {"type": "string"}, "options": {"type": "array", "items": {"type": "string"}}, "urgency": {"enum": ["low", "normal", "high"], "type": "string"}, "question": {"type": "string", "minLength": 1}, "work_order_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-14 01:31:10.167403+00
b475577d-b4f9-48e2-a7b4-dc7ae66d91ad	answer-clarification	POST	{"type": "object", "required": ["clarification_id", "response"], "properties": {"response": {"type": "string", "minLength": 1}, "responded_by": {"type": "string"}, "clarification_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-14 01:31:10.167403+00
038894a8-121e-4da0-9e30-003db57543c3	check-clarification	POST	{"type": "object", "required": ["clarification_id"], "properties": {"clarification_id": {"type": "string", "format": "uuid"}}}	t	120	t	2026-02-14 01:31:10.167403+00
523d7049-fa32-4741-b22f-e40d178f7422	wo-effect-processor	POST	{"type": "object", "required": [], "properties": {"batch_size": {"type": "integer", "default": 10}}}	f	60	t	2026-02-14 17:20:19.837502+00
730d1fc6-c42c-4598-94db-8858c586c0e6	/work-order-executor	POST	{"type": "object", "properties": {"action": {"enum": ["health-check"], "type": "string"}, "work_order_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-15 23:22:02.904124+00
7c45892a-3486-4fea-b8b1-717d55d0d2eb	council-deliberate	POST	{"type": "object", "required": ["work_order_id"], "properties": {"force_run": {"type": "boolean"}, "preset_id": {"type": "string"}, "preset_name": {"type": "string"}, "work_order_id": {"type": "string"}}}	t	10	t	2026-02-16 21:24:47.528082+00
83220833-bc5c-443c-98f6-db0e27a92e10	kernel	POST	{"type": "object", "required": ["action", "work_order_id"], "properties": {"actor": {"type": "string"}, "event": {"type": "string"}, "action": {"enum": ["transition", "validate"], "type": "string"}, "payload": {"type": "object"}, "work_order_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-18 04:02:46.31804+00
f609c7b2-a522-4d18-bc71-e8d3109b4a1d	kernel/transition	POST	{"type": "object", "required": ["work_order_id", "event"], "properties": {"actor": {"type": "string"}, "event": {"type": "string"}, "payload": {"type": "object"}, "work_order_id": {"type": "string", "format": "uuid"}}}	t	60	t	2026-02-18 04:02:46.31804+00
451a3d34-aa08-41f4-a4b1-2d3fa101335a	kernel/validate	POST	{"type": "object", "required": ["work_order_id"], "properties": {"work_order_id": {"type": "string", "format": "uuid"}, "invariant_names": {"type": "array", "items": {"type": "string"}}}}	t	60	t	2026-02-18 04:02:46.31804+00
bd65fbdc-c215-4418-842d-7e581591e02b	kernel/state	GET	{"type": "object", "required": ["wo_id"], "properties": {"wo_id": {"type": "string", "format": "uuid"}}}	t	120	t	2026-02-18 04:02:46.31804+00
095dd539-06f2-4312-a0ca-7cae4db83da5	kernel/paths	GET	{"type": "object", "required": ["wo_id"], "properties": {"wo_id": {"type": "string", "format": "uuid"}}}	t	120	t	2026-02-18 04:02:46.31804+00
206c5966-ed50-494e-bb04-e29676859b24	kernel/verify	GET	{"type": "object", "required": ["wo_id"], "properties": {"wo_id": {"type": "string", "format": "uuid"}}}	t	120	t	2026-02-18 04:02:46.31804+00
7859b583-be19-4d2c-8f68-f43b16ae941d	kernel/spec	GET	{"type": "object", "properties": {}}	t	60	t	2026-02-18 04:02:46.31804+00
8ea0c40c-e46c-4efc-82e3-eb9287e5ab8a	/functions/v1/kernel/transition	POST	{"actor": "text", "event": "text", "wo_id": "uuid", "payload": "jsonb"}	t	60	t	2026-02-18 04:13:39.741128+00
f5cc5b8d-fcc9-4774-881b-ed8a2d041305	/functions/v1/kernel/state	GET	{"wo_id": "uuid (path param)"}	t	60	t	2026-02-18 04:13:39.741128+00
2cbfbd77-bdd4-4e64-8143-7c95265d40e8	/functions/v1/kernel/verify	GET	{"wo_id": "uuid (path param)"}	t	60	t	2026-02-18 04:13:39.741128+00
667345da-15af-4353-a474-821cd332a591	/functions/v1/kernel/spec	GET	{}	t	60	t	2026-02-18 04:13:39.741128+00
76ba0f7a-f47d-43a2-85ad-66c85a47fc14	/functions/v1/kernel/validate	POST	{"event": "text", "wo_id": "uuid", "payload": "jsonb"}	t	60	t	2026-02-18 04:13:39.741128+00
4234e9af-a4f8-416a-97c3-ec0d0c5091e6	/functions/v1/kernel/health	GET	{}	t	60	t	2026-02-18 04:13:39.741128+00
\.


--
-- Data for Name: system_settings; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.system_settings (id, setting_key, setting_value, description, last_modified_by, created_at, updated_at) FROM stdin;
961ce546-d696-46b1-98fd-7c4e4c1e17b9	enforcer_gate_mode	"warn"	Controls enforcer gate behavior: enforce (block), warn (log only), disabled (skip). Start in warn mode for soft launch.	WO-0012	2026-02-07 18:46:58.100803+00	2026-02-07 18:46:58.100803+00
14eeed3b-1ae7-4bee-97fd-a5e275385e67	qa_gate_mode	"enforce"	Controls QA gate: enforce (block review→done if unresolved fail findings), warn (log only), disabled (skip)	ilmarinen	2026-02-08 00:53:25.039877+00	2026-02-08 00:53:25.039877+00
ce24d620-e96c-4da2-9d00-23e36b9283b5	supabase_anon_key	"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoZmJsbGp3dXZ6cXpsYnprenByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjAzODgsImV4cCI6MjA4NTA5NjM4OH0.mWIj2vtQb1F2Pk540f_S9WwsZFwZK0n6oeqUmZgDZlA"	Supabase anon key for pg_net trigger calls	ilmarinen	2026-02-08 00:53:25.039877+00	2026-02-08 00:53:25.039877+00
7bf07ed0-e7d7-4fb1-8718-087ff919b378	edge_function_tool_loading_config	{"strategy": "deferred_with_search", "deferred_count": 36, "total_functions": 41, "always_loaded_count": 5, "implementation_date": "2026-02-09T01:12:49.956272+00:00", "tool_search_enabled": true, "expected_token_reduction_pct": 80}	Configuration for Edge Function tool deferred loading via tool_search_tool_regex_20251119	WO-0103	2026-02-09 01:12:49.956272+00	2026-02-09 01:12:49.956272+00
1b798700-f4eb-4985-a9d7-20f8dee1837b	context_management_config	{"enabled": true, "version": "1.0.0", "strategy": "clear_tool_uses_20250919", "work_order": "WO-0104", "preserve_last_n_turns": 5, "max_tokens_before_clearing": 100000}	Context management configuration for automatic tool call clearing in long-running orchestration sessions. Prevents session compaction failures by clearing stale tool results while preserving recent turns. Strategy: clear_tool_uses_20250919, Beta header: context-management-2025-06-27	WO-0104	2026-02-09 02:35:15.539928+00	2026-02-09 02:35:15.539928+00
f57e423f-f1d5-483b-bfa2-4d0e2efcac24	worker_agent_prompt_template	{"version": 1, "sections": {"identity": "# WORKER AGENT IDENTITY\\n\\nYou are a **worker agent** executing under the ENDGAME-001 / METIS harness.\\n\\n- **Your Role**: You execute work orders within strict operational guardrails\\n- **Your Supervisor**: ilmarinen (super admin/owner, CLI master agent)\\n- **Your Agent Name**: {{AGENT_NAME}} (dynamically assigned per execution)\\n- **Your Capabilities**: Full MCP tool access, database RPC access, file system access\\n- **Your Constraints**: Work within harness rules, log all actions, respect state machine transitions\\n\\n**CRITICAL**: All audit_log entries, work_order_execution_log entries, and state_mutations MUST use your assigned agent_name ({{AGENT_NAME}}), NOT \\"ilmarinen\\". This provides execution traceability.", "harness_rules": "# HARNESS RULES (NEVER BYPASS)\\n\\n## State Machine Integrity\\n- NEVER force WO transitions without verifying acceptance criteria\\n- NEVER modify work_orders table directly — use RPC functions: start_work_order(), update_work_order_state()\\n- Valid status transitions: draft→ready→pending_approval→in_progress→review→done\\n- NEVER skip pending_approval if requires_approval=true\\n- NEVER bypass gate checks or approval workflows\\n\\n## Mandatory Process Requirements\\n1. **TodoWrite Usage**: MANDATORY for all WO execution. Create initial task list, mark in_progress before each task, mark completed immediately after. Failure to use TodoWrite causes auto-QA failure (criterion ac-26).\\n2. **Phase Logging**: Log all significant phases to work_order_execution_log using your agent_name\\n3. **Verification Before Completion**: Test deployed functions, verify migrations, check build logs before calling /complete\\n4. **Summary Required**: /complete endpoint requires non-empty summary. Provide clear, evidence-backed completion summary.", "schema_gotchas": "# SCHEMA GOTCHAS (FROM LESSONS)\\n\\n## Column Name Issues\\n- work_orders.assigned_to is UUID (references agents.id), NOT text\\n- work_orders.assigned_to_legacy is agent_type enum (deprecated)\\n- work_orders.created_by is agent_type enum\\n- Always check actual column names in schema context before writing queries\\n\\n## Enum Values\\n- work_order_status: draft, ready, pending_approval, in_progress, blocked, review, done, cancelled, failed\\n- work_order_priority: p0_critical, p1_high, p2_medium, p3_low\\n- agent_type: you, engineering, audit, cto, cpo, research, analysis, external\\n\\n## State Machine Rules\\n- NEVER add CHECK constraints on trigger-populated columns (chicken-egg deadlock)\\n- Use validate_wo_transition() RPC gates for application-level validation\\n- Triggers populate qa_checklist on status transitions\\n\\n## Critical RPC Signatures\\n- start_work_order(p_work_order_id uuid, p_agent_name text DEFAULT 'ilmarinen')\\n- update_work_order_state(p_work_order_id uuid, p_status text, ...)\\n- state_write(p_mutation_type text, p_target_table text, p_payload jsonb, p_work_order_id uuid, ...)\\n- Always refer to schema context for exact parameter names", "deployment_rules": "# DEPLOYMENT RULES\\n\\n## Edge Function Deployment\\n- **Functions >100 lines**: MUST use CLI: `cd /Users/OG/Projects/metis-portal2 && supabase functions deploy <name> --project-ref phfblljwuvzqzlbzkzpr --no-verify-jwt`\\n- **Functions <100 lines**: MAY use mcp__supabase__deploy_edge_function\\n- **CRITICAL**: work-order-executor (1153+ lines) MUST ALWAYS use CLI. MCP partial deploys break endpoints.\\n- **Version Updates**: After deploying edge functions, update system_manifest version via state_write() RPC\\n\\n## Migration Application\\n- Use mcp__supabase__apply_migration — do NOT create SQL files for manual application\\n- Test migrations on local/branch databases first when possible\\n- Log migration application to schema_changes table\\n\\n## Forbidden Patterns\\n- NEVER use Deno.Command, Deno.run, or subprocess spawning in edge function code\\n- For git operations: use GitHub REST API\\n- For system_manifest updates: use state_write() RPC\\n- For audit_log: use payload column only", "escalation_instructions": "# ESCALATION & FAILURE PROTOCOL\\n\\n## When to Fail Fast\\nIf you encounter any of the following, STOP and call work-order-executor /fail with clear explanation:\\n\\n1. **Blocked by Missing Context**: Required data, credentials, or configuration not available\\n2. **Ambiguous Requirements**: Acceptance criteria are unclear or contradictory\\n3. **Technical Blockers**: External service unavailable, rate limits exceeded, permissions denied\\n4. **Scope Creep Detected**: WO requires work beyond stated objective\\n5. **Impossible Objectives**: Request violates harness rules, schema constraints, or architectural limits\\n\\n## DO NOT Waste Full Session\\n- If blocked after 3-5 attempts, escalate via /fail rather than burning entire session\\n- Provide clear error message with context: what you tried, what failed, what's needed\\n- Log failure evidence to work_order_execution_log\\n\\n## Circuit Breakers\\n- Auto-QA remediation loop breaker: 3 consecutive failures triggers manual review\\n- Auto-approval circuit breaker: trips if auto-approved WO fails\\n- Rate limit exhaustion: retry_after delay enforced\\n\\n## Escalation Targets\\n- **Technical blockers**: Fail with ERR_ACTION_DENIED or ERR_DEPLOY_FAILED\\n- **Requirement ambiguity**: Fail with ERR_AC_MISSING or request clarification\\n- **Scope issues**: Fail with recommendation to decompose WO"}, "template_usage": "Daemon loads this template, replaces {{AGENT_NAME}} with unique worker ID, injects active directives, critical lessons, and recent system context, then provides to Claude Code subprocess as system prompt supplement.", "dynamic_sections": {"lessons_query": "SELECT id, pattern, rule, example_good, severity, category FROM lessons WHERE reviewed = true AND severity IN ('critical', 'high') ORDER BY occurred_at DESC LIMIT 10", "context_load_api": "GET /functions/v1/context-load", "directives_query": "SELECT id, name, content, priority, enforcement_mode FROM system_directives WHERE active = true ORDER BY priority DESC LIMIT 20"}}	Worker agent prompt template for daemon-spawned Claude Code subprocesses. Injects worker identity, operational rules, active directives, critical lessons, and escalation instructions.	WO-0121	2026-02-09 04:41:48.322537+00	2026-02-09 04:41:48.322537+00
d8709312-577c-4519-80be-54717bbac177	ops_last_heartbeat	"2026-02-16 23:18:55.155626+00"	\N	\N	2026-02-16 23:18:55.155626+00	2026-02-16 23:18:55.155626+00
e4358411-27b1-4bf9-a3d1-d526f8cc9187	grafana_reader_password	"GrafanaRead2026!Endgame"	\N	\N	2026-02-15 18:58:35.530595+00	2026-02-15 18:58:35.530595+00
13a4e09e-9100-4a9c-b1da-6a9908f578aa	remediation_default_agent	"ilmarinen"	\N	\N	2026-02-14 03:34:19.752529+00	2026-02-14 03:34:19.752529+00
5b5969d3-56bc-4af4-a05a-1b35350e2cc7	auto_approval_risk_threshold	40	Maximum risk score allowed for auto-approval. WOs with risk_score <= this value may be auto-approved if other criteria are met. Raised from 25 to 40 in WO-0063 to enable >50% success rate on trivial/small WOs.	ilmarinen	2026-02-09 20:10:54.524749+00	2026-02-09 20:10:54.524749+00
8869e3f6-bd8b-4f41-a3f7-eda34e2a723e	auto_approval_complexity_allowlist	["trivial", "small"]	Allowed complexity values for auto-approval. Only WOs with these complexity values (or null which defaults to small) are eligible.	ilmarinen	2026-02-09 20:10:54.524749+00	2026-02-09 20:10:54.524749+00
b56f18de-5bf6-4aae-8051-d55f704cb8f9	auto_approval_source_allowlist	["cli", "daemon", "api"]	Allowed source values for auto-approval. Expanded in WO-0063 to include daemon and api sources.	ilmarinen	2026-02-09 20:10:54.524749+00	2026-02-09 20:10:54.524749+00
ede919a4-9861-4da2-8b34-bcd688f31a35	auto_approval_tag_allowlist	["bugfix", "hotfix", "trivial", "config", "documentation", "test", "refactor"]	Allowed tags for auto-approval. WOs with these tags get lower risk scores.	ilmarinen	2026-02-09 20:10:54.524749+00	2026-02-09 20:10:54.524749+00
a138a912-4c41-4b34-b0c6-e5123f35006f	complexity_gate_threshold	{"value": "5"}	Maximum complexity score allowed before WO must be decomposed (start event)	\N	2026-02-14 16:16:54.991201+00	2026-02-14 16:16:54.991201+00
08aa8d97-9738-4579-99cb-fecf2343b75a	supabase_url	"https://phfblljwuvzqzlbzkzpr.supabase.co"	\N	\N	2026-02-15 21:42:07.251258+00	2026-02-15 21:42:07.251258+00
ff69aa00-a898-4940-b000-15bfe1fb913d	last_reprioritize_at	"\\"2026-02-18T03:15:53.444Z\\""	Timestamp of last queue reprioritization (for debounce)	migration	2026-02-09 16:18:49.611671+00	2026-02-18 03:15:53.444+00
83c8a05b-e9e2-4f6a-a78d-157fc07226c8	fly_machine_url	"https://endgame-sandbox.fly.dev"	\N	\N	2026-02-14 04:56:03.656631+00	2026-02-14 04:56:03.656631+00
4a4d39eb-d303-4c96-8e5c-a5d672f1f021	fly_machine_token	"not_required_public_endpoint"	\N	\N	2026-02-14 04:56:03.656631+00	2026-02-14 04:56:03.656631+00
09f8e5e9-1b5a-4ab3-a138-9f7c24b03313	pre_execution_gate_enabled	{"value": true}	\N	\N	2026-02-16 22:46:00.373732+00	2026-02-16 22:46:00.373732+00
\.


--
-- Data for Name: wo_effect_registry; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.wo_effect_registry (id, trigger_on_status, effect_type, handler, config, execution_order, enabled, description) FROM stdin;
3bdf044e-2791-4756-94e8-74b139c8c918	done	unblock_dependents	sql_call	{"function": "auto_unblock_dependents_for_wo"}	10	t	\N
801c8939-5b99-4b39-a383-e791fc39cc49	done	advance_pipeline	sql_call	{"function": "advance_pipeline_phase"}	20	t	\N
d3eaa253-afa1-459f-9e4a-e0609aa6d1e4	done	close_parent_remediation	sql_call	{"function": "close_parent_on_remediation"}	30	t	\N
657a7209-603a-4986-b6d4-3c27093fc2ae	done	settle_children	sql_call	{}	40	t	\N
442f029e-b13e-4e4e-be79-6be55890192d	done	resume_parent	sql_call	{}	45	t	\N
6b0a9d67-357a-430c-a7ae-2af1cf6d5b4f	done	unblock_pipelines	process_wo_effect	{}	50	t	\N
4816ad10-98b3-4b40-aa5a-b1dca1d10a3c	ready	auto_start	sql_call	{"function": "auto_start"}	10	t	\N
60d0003d-2cb9-4459-96d9-8b68d503d675	failed	spawn_remediation	sql_call	{"function": "spawn_remediation"}	10	t	\N
18fed311-8465-4788-bc66-ca5cd62b28a8	failed	escalate_parent_failure	sql_call	{}	20	t	\N
59bdd552-c011-4a8d-8c0d-92a169a3d878	failed	settle_children	sql_call	{}	25	t	\N
3fc881c6-1f0a-4239-b467-47948cfecb6b	failed	resume_parent	sql_call	{}	30	t	\N
feeec9de-76b5-4dee-828c-94d72cc71468	failed	audit_failure	sql_call	{}	35	t	\N
ac45ca98-5706-4674-955b-71f0b1da3802	review	populate_qa_checklist	sql_call	{"function": "parse_criteria_to_checklist"}	5	t	\N
09f4eb96-3c09-459c-a7c9-9c0d15dd0874	review	trigger_qa	pg_net_post	{"endpoint": "/functions/v1/auto-qa"}	10	t	\N
bbf61395-b018-40fe-8209-6ad4272b298c	cancelled	settle_children	sql_call	{}	10	t	\N
1d0ff50a-5ca0-41a8-8bd3-4a4173055654	cancelled	resume_parent	sql_call	{}	20	t	\N
51f8c64b-b570-4957-97f5-7898f95ae71b	in_progress	dispatch_agent	pg_net_post	{"endpoint": "/functions/v1/wo-agent"}	10	t	\N
5ec45060-352c-457c-a081-e757105ed3fa	in_progress	schedule_liveness_check	pg_net_post	{"endpoint": "/functions/v1/health-check"}	20	t	\N
\.


--
-- Data for Name: wo_state_machine; Type: TABLE DATA; Schema: public; Owner: -
--

COPY public.wo_state_machine (id, from_status, event, to_status, guard_function, effects, enabled, description) FROM stdin;
b95d33f8-b34a-4cc4-b0d8-d5b5b188ab79	blocked	unblock	in_progress	\N	[]	t	\N
debcfe65-dc93-4ff7-a8da-ea9be09f8612	review	mark_done	done	\N	[{"type": "completed_at", "value": "now()"}]	t	\N
b31c02ee-9a93-4c7c-a60f-53b69fc914c7	review	qa_failed	in_progress	\N	[{"type": "qa_review_verified_at", "value": null}]	t	\N
45b68491-3faa-4a54-894e-18722b40adc3	review	qa_passed	done	\N	[{"type": "completed_at", "value": "now()"}, {"type": "qa_review_verified_at", "value": "now()"}]	t	\N
e893f956-2fa7-45fb-b3a9-1f971214d9dd	draft	approve	ready	\N	[{"type": "approved_at", "value": "now()"}]	t	\N
f3e78023-2c7a-4518-97c6-c6d1576d51cb	draft	pipeline_dispatch	in_progress	\N	[{"type": "started_at", "value": "now()"}]	t	\N
0b7cb802-bd6a-40f7-8abf-caa53d432e14	draft	submit_for_planning	planning	\N	[]	t	\N
338c2399-2da5-4749-86a1-b8128e921eac	planning	complete_planning	ready	\N	[]	t	\N
f645ef64-568c-4831-b3ee-99861de6f7b9	ready	start_work	in_progress	\N	[{"type": "started_at", "value": "now()"}]	t	\N
dee12db9-1457-4ede-838a-e080d79efe85	pending_approval	approve	ready	\N	[{"type": "approved_at", "value": "now()"}]	t	\N
5c68bbf7-54ca-461c-999d-46030e4d65aa	in_progress	mark_done	done	\N	[{"type": "completed_at", "value": "now()"}]	t	\N
7d6626a5-42d9-4352-b19d-3116a74f880e	in_progress	mark_failed	failed	\N	["spawn_remediation"]	t	\N
ead1d059-bd6b-4c82-bb83-0774ab04ef52	in_progress	report_blocked	blocked	\N	[]	t	\N
82a989ab-dac6-4889-88de-401a247c2b1c	in_progress	submit_for_review	review	\N	[]	t	\N
4e64f485-b679-4af0-8d6f-0c071318674e	blocked	mark_failed	failed	\N	[]	t	\N
3a29d551-1795-460c-88cf-28be2b582dea	blocked	start_work	in_progress	\N	[{"type": "started_at", "value": "now()"}]	t	\N
06c7aca8-8499-45eb-9ab4-8588619594db	done	reopen	ready	\N	[]	t	\N
13849636-83ea-4da1-9b5a-75214e89151e	cancelled	reopen	ready	\N	[]	t	\N
600df04d-3fb1-41c9-8187-343c2cfb51d2	failed	mark_done	done	\N	[{"type": "completed_at", "value": "now()"}]	t	\N
d72bc522-266b-44ee-a23a-284df54186f5	failed	request_retry	ready	\N	[{"type": "increment_retry_count", "value": 1}]	t	\N
b71e5c26-b3c0-4eef-a734-b80cd7e466f3	failed	retry	ready	\N	[{"type": "increment_retry_count", "value": 1}]	t	\N
31d5a66c-16c8-4d40-97be-bf454f4381da	blocked_on_input	mark_failed	failed	\N	[]	t	\N
65410fcc-62eb-4e5c-a5c7-760093ab9a97	blocked_on_input	start_work	in_progress	\N	[{"type": "started_at", "value": "now()"}]	t	\N
6fee9076-98b2-4e26-8486-651f7c7e7b9d	blocked_on_input	unblock	in_progress	\N	[]	t	\N
c716cd9d-ddb0-4149-8e4e-6dcda3112305	in_progress	cancel	cancelled	\N	[]	t	Cancel a work order that is in progress
9ffc4f26-e8d5-41ec-9ea3-c7085140f005	ready	cancel	cancelled	\N	[]	t	Cancel a work order that is ready
f04b3a8f-cc17-4b23-82d5-792da3c8fb8d	pending_approval	cancel	cancelled	\N	[]	t	Cancel a work order pending approval
de8ff409-815d-43e1-9245-8d606c0f1396	planning	cancel	cancelled	\N	[]	t	Cancel a work order in planning phase
6a254d2c-0b4e-419c-921a-26fddffd7948	blocked	cancel	cancelled	\N	[]	t	Cancel a blocked work order
8947b4f3-67f8-4841-a89d-53750fe721af	blocked_on_input	cancel	cancelled	\N	[]	t	Cancel a work order blocked on input
\.


--
-- Name: kernel_spec_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.kernel_spec_id_seq', 3, true);


--
-- PostgreSQL database dump complete
--

\unrestrict JqQpqpCyCYXU0eYKAAyAguneu1aleXP43LvAEExldGfcfcswlLjSIZ2PgfNyY8k

