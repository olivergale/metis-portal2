export async function buildAgentContext(
  supabase: any,
  workOrder: WorkOrder
): Promise<WorkOrderContext> {
  // Look up agent from DB based on assignment, fallback to builder
  let agentName = "builder";
  let agentModel = "claude-opus-4-6";
  try {
    const { data: assignedAgent } = await supabase
      .from("agents")
      .select("name, model")
      .eq("id", workOrder.assigned_to || "")
      .single();
    if (assignedAgent?.name) agentName = assignedAgent.name;
    if (assignedAgent?.model) agentModel = assignedAgent.model;
  } catch {
    // Fallback to builder
  }

  // CTX-002 FIX: Load agent_execution_profiles BEFORE client_info.model check
  // This allows profile to serve as fallback, then client_info overrides take priority
  let agentProfile: any = null;
  try {
    const { data } = await supabase
      .from("agent_execution_profiles")
      .select("*")
      .eq("agent_name", agentName)
      .single();
    agentProfile = data;
    // Apply profile model as fallback - client_info checks will override this
    if (agentProfile?.model) {
      agentModel = agentProfile.model;
    }
  } catch {
    // Profile not found, continue with agent table defaults
  }

  // WO-0252: Allow WO-level model override via client_info.model (overrides profile)
  if (workOrder.client_info?.model) {
    agentModel = workOrder.client_info.model;
  }

  // WO-MF-P26: Escalation tier model override (takes highest priority)
  if (workOrder.client_info?.escalation_model) {
    agentModel = workOrder.client_info.escalation_model;
  }

  // Load schema context — P2: dynamic WO-aware schema extraction
  let schemaContext = "## Database Schema\nSchema loading failed";
  try {
    const { data } = await supabase.rpc("get_dynamic_schema_context", {
      p_work_order_id: workOrder.id,
    });
    if (data) schemaContext = data;
  } catch {
    // Dynamic schema load failed, try static fallback
    try {
      const { data } = await supabase.rpc("get_schema_context");
      if (data) schemaContext = data;
    } catch {
      // Schema load entirely, use fallback
    }
  }

  // Build base system prompt from worker template
  // WO-0164: Pass WO tags for tag-filtered directive loading
  const woTags = workOrder.tags || [];
  let systemPrompt: string;
  const template = await loadWorkerPromptTemplate(supabase);
  if (template) {
    systemPrompt = await buildWorkerPrompt(supabase, template, agentName, schemaContext, woTags);
  } else {
    // Fallback: build minimal prompt
    systemPrompt = await buildFallbackPrompt(supabase, agentName, schemaContext, woTags);
  }

  // CTX-005: Lost-in-the-Middle prompt ordering
  // U-shaped attention: BEGINNING and END get highest model attention.
  // Order: Identity+Profile → Tools+Rules → KB → Memories → Lessons (end)

  // ❯❯❯ BLOCK 1: Agent Identity & Profile (BEGINNING — highest attention) ❯❯❯
  // agentProfile already loaded above in CTX-002 fix
  // (moved before client_info checks to enable proper fallback priority)