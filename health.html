<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Health - ENDGAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #2b2a27;
            --bg-surface: #353432;
            --bg-elevated: #3f3e3b;
            --bg-hover: #4a4946;
            --text-primary: #ececec;
            --text-secondary: #b8b8b6;
            --text-muted: #888886;
            --border-default: #4a4946;
            --border-strong: #5a5956;
            --accent: #d4a574;
            --accent-hover: #e0b588;
            --accent-subtle: rgba(212, 165, 116, 0.15);
            --status-active: #34D399;
            --status-warning: #FBBF24;
            --status-error: #F87171;
            --status-muted: #9CA3AF;
            --status-blue: #60A5FA;
            --status-purple: #A78BFA;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* ── Nav ── */
        .top-nav {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 12px 32px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-default);
        }

        .top-nav .logo {
            font-weight: 700;
            font-size: 15px;
            color: var(--accent);
            letter-spacing: 0.5px;
        }

        .top-nav a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 0;
            transition: color 0.15s;
        }

        .top-nav a:hover { color: var(--text-primary); }
        .top-nav a.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        .nav-spacer { flex: 1; }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .connection-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--status-muted);
        }

        .connection-dot.connected { background: var(--status-active); }
        .connection-dot.error { background: var(--status-error); }

        /* ── Content ── */
        .content {
            flex: 1;
            padding: 32px;
            max-width: 1280px;
            margin: 0 auto;
            width: 100%;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
        }

        .page-header h1 {
            font-size: 22px;
            font-weight: 600;
        }

        .page-header .subtitle {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* ── Cards Grid ── */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            padding: 20px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-header h3 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .card-value {
            font-size: 36px;
            font-weight: 700;
            line-height: 1.1;
            color: var(--text-primary);
        }

        .card-value .unit {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .card-detail {
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .card-detail .label {
            color: var(--text-muted);
            margin-right: 6px;
        }

        /* ── Status Badges ── */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.active { background: rgba(52,211,153,0.15); color: #34D399; }
        .badge.warning { background: rgba(251,191,36,0.15); color: #FBBF24; }
        .badge.error { background: rgba(248,113,113,0.15); color: #F87171; }
        .badge.muted { background: rgba(156,163,175,0.15); color: #9CA3AF; }
        .badge.blue { background: rgba(96,165,250,0.15); color: #60A5FA; }
        .badge.purple { background: rgba(167,139,250,0.15); color: #A78BFA; }

        .badge-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ── WO Pipeline ── */
        .pipeline {
            display: flex;
            gap: 2px;
            margin-top: 8px;
        }

        .pipeline-segment {
            height: 6px;
            border-radius: 3px;
            flex: 1;
            transition: flex 0.3s;
        }

        /* ── Table ── */
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-default);
        }

        .wo-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .wo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border-radius: 8px;
            font-size: 13px;
        }

        .wo-item .slug {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            color: var(--accent);
            min-width: 100px;
        }

        .wo-item .name {
            flex: 1;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .wo-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .wo-status.in_progress { background: rgba(251,191,36,0.15); color: #FBBF24; }
        .wo-status.draft { background: rgba(156,163,175,0.15); color: #9CA3AF; }
        .wo-status.ready { background: rgba(96,165,250,0.15); color: #60A5FA; }
        .wo-status.review { background: rgba(167,139,250,0.15); color: #A78BFA; }
        .wo-status.done { background: rgba(52,211,153,0.15); color: #34D399; }
        .wo-status.blocked { background: rgba(248,113,113,0.15); color: #F87171; }

        /* ── State Integrity ── */
        .check-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .check-row:hover {
            background: var(--bg-hover);
        }

        .check-row .expand-icon {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .check-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .check-icon {
            width: 20px; height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .check-icon.pass { background: rgba(52,211,153,0.2); color: #34D399; }
        .check-icon.fail { background: rgba(248,113,113,0.2); color: #F87171; }
        .check-icon.warn { background: rgba(251,191,36,0.2); color: #FBBF24; }

        .check-label { flex: 1; color: var(--text-secondary); }
        .check-detail { font-size: 12px; color: var(--text-muted); }

        /* ── Drill-down panels ── */
        .drill-down {
            display: none;
            margin: 0 0 6px 0;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.7;
        }

        .drill-down.open {
            display: block;
        }

        .drill-down h4 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
            margin-top: 8px;
        }

        .drill-down h4:first-child { margin-top: 0; }

        .drill-down p {
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .drill-down pre {
            background: var(--bg-elevated);
            padding: 8px 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            margin: 4px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .drill-down .remediation {
            color: var(--accent);
            font-weight: 500;
        }

        /* ── Brain Sync Stoplight ── */
        .brain-sync-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        .sync-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border-radius: 8px;
            border-left: 3px solid var(--status-muted);
            transition: border-color 0.3s;
        }
        .sync-card.green { border-left-color: var(--status-active); }
        .sync-card.yellow { border-left-color: var(--status-warning); }
        .sync-card.red { border-left-color: var(--status-error); }
        .stoplight {
            width: 10px; height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--status-muted);
        }
        .stoplight.green { background: var(--status-active); box-shadow: 0 0 6px rgba(52,211,153,0.4); }
        .stoplight.yellow { background: var(--status-warning); box-shadow: 0 0 6px rgba(251,191,36,0.4); }
        .stoplight.red { background: var(--status-error); box-shadow: 0 0 6px rgba(248,113,113,0.4); }
        .sync-info { flex: 1; min-width: 0; }
        .sync-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
        .sync-time { font-size: 11px; color: var(--text-muted); display: block; }
        .section-subtitle {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
            margin-top: 14px;
        }
        .section-subtitle:first-child { margin-top: 0; }
        .system-pulse {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 14px;
            font-size: 13px;
            font-weight: 600;
        }
        .pulse-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        .pulse-dot.green { background: var(--status-active); }
        .pulse-dot.yellow { background: var(--status-warning); }
        .pulse-dot.red { background: var(--status-error); }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.85); }
        }

        /* ── Lesson Stats ── */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
            border-bottom: 1px solid var(--border-default);
        }

        .stat-row:last-child { border-bottom: none; }
        .stat-row .stat-label { color: var(--text-muted); }
        .stat-row .stat-value { color: var(--text-primary); font-weight: 600; }

        /* ── Phase Progress ── */
        .phase-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .phase-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--accent), #e0b588);
            transition: width 0.5s ease;
        }

        /* ── Wide cards ── */
        .grid-wide {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        /* ── Enforcement Stats Bar ── */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .mini-card {
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 12px 14px;
            text-align: center;
        }

        .mini-card .mini-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .mini-card .mini-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* ── Event Stream ── */
        .event-stream {
            max-height: 320px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 12px;
        }

        .event-badge {
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            flex-shrink: 0;
            min-width: 72px;
            text-align: center;
        }

        .event-badge.transition { background: rgba(52,211,153,0.15); color: #34D399; }
        .event-badge.blocked { background: rgba(248,113,113,0.15); color: #F87171; }
        .event-badge.gate-pass { background: rgba(96,165,250,0.15); color: #60A5FA; }
        .event-badge.gate-pending { background: rgba(251,191,36,0.15); color: #FBBF24; }
        .event-badge.rejected { background: rgba(248,113,113,0.15); color: #F87171; }
        .event-badge.other { background: rgba(156,163,175,0.15); color: #9CA3AF; }

        .event-action { flex: 1; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .event-time { color: var(--text-muted); font-size: 11px; flex-shrink: 0; }

        /* ── Gate List ── */
        .gate-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .gate-name { flex: 1; color: var(--text-secondary); }
        .gate-type { color: var(--text-muted); font-size: 11px; }

        /* ── Mutation Stream ── */
        .mutation-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .mutation-table {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 11px;
            color: var(--accent);
            min-width: 120px;
        }

        .mutation-type {
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            min-width: 55px;
            text-align: center;
        }

        .mutation-type.INSERT { background: rgba(52,211,153,0.15); color: #34D399; }
        .mutation-type.UPDATE { background: rgba(96,165,250,0.15); color: #60A5FA; }
        .mutation-type.DELETE { background: rgba(248,113,113,0.15); color: #F87171; }
        .mutation-type.ROLLBACK { background: rgba(167,139,250,0.15); color: #A78BFA; }

        .mutation-time { color: var(--text-muted); font-size: 11px; margin-left: auto; }

        /* ── Auto-approval Monitor ── */
        .approval-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .approval-decision {
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            min-width: 65px;
            text-align: center;
        }

        .approval-decision.approved { background: rgba(52,211,153,0.15); color: #34D399; }
        .approval-decision.denied { background: rgba(248,113,113,0.15); color: #F87171; }
        .approval-decision.escalated { background: rgba(251,191,36,0.15); color: #FBBF24; }
        .approval-decision.dry_run { background: rgba(167,139,250,0.15); color: #A78BFA; }

        @media (max-width: 768px) {
            .grid-wide { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
            .content { padding: 16px; }
            .top-nav { padding: 12px 16px; gap: 16px; }
        }

        /* ── Skeleton loading ── */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-elevated) 25%, var(--bg-hover) 50%, var(--bg-elevated) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .footer {
            padding: 12px 32px;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            border-top: 1px solid var(--border-default);
        }
    </style>
</head>
<body>
    <div class="layout">
        <nav class="top-nav">
            <span class="logo">ENDGAME</span>
            <a href="index.html">Chat</a>
            <a href="workspace.html">Workspace</a>
            <a href="health.html" class="active">Health</a>
            <span class="nav-spacer"></span>
            <div class="connection-badge">
                <span class="connection-dot" id="connDot"></span>
                <span id="connLabel">Connecting...</span>
            </div>
        </nav>

        <div class="content">
            <div class="page-header">
                <div>
                    <h1>System Health</h1>
                    <span class="subtitle" id="lastUpdated">Loading...</span>
                </div>
                <div>
                    <span class="badge muted" id="phaseBadge">--</span>
                </div>
            </div>

            <!-- Top-level KPIs -->
            <div class="grid">
                <!-- Daemon -->
                <div class="card">
                    <div class="card-header">
                        <h3>Daemon</h3>
                        <span class="badge muted" id="daemonBadge">--</span>
                    </div>
                    <div class="card-value" id="daemonStatus">--</div>
                    <div class="card-detail">
                        <span class="label">Last heartbeat:</span>
                        <span id="daemonHeartbeat">--</span>
                    </div>
                </div>

                <!-- Phase Progress -->
                <div class="card">
                    <div class="card-header">
                        <h3>Phase Progress</h3>
                    </div>
                    <div class="card-value"><span id="completionPct">--</span><span class="unit">%</span></div>
                    <div class="phase-bar">
                        <div class="phase-bar-fill" id="phaseBarFill" style="width:0%"></div>
                    </div>
                    <div class="card-detail">
                        <span class="label">Phase:</span>
                        <span id="currentPhase">--</span>
                    </div>
                </div>

                <!-- WO Pipeline -->
                <div class="card">
                    <div class="card-header">
                        <h3>WO Pipeline</h3>
                    </div>
                    <div class="card-value"><span id="activeWoCount">--</span></div>
                    <div class="pipeline" id="pipeline"></div>
                    <div class="card-detail">
                        <span id="pipelineDetail">--</span>
                    </div>
                </div>

                <!-- Completed This Week -->
                <div class="card">
                    <div class="card-header">
                        <h3>Completed (7d)</h3>
                    </div>
                    <div class="card-value"><span id="completedCount">--</span></div>
                    <div class="card-detail">
                        <span class="label">Lessons:</span>
                        <span id="lessonTotal">--</span>
                        <span class="label" style="margin-left:12px">Directives:</span>
                        <span id="directiveTotal">--</span>
                    </div>
                </div>
            </div>

            <!-- Detail sections -->
            <div class="grid-wide">
                <!-- Active Work Orders -->
                <div class="card">
                    <div class="section-title">Active Work Orders</div>
                    <div class="wo-list" id="woList">
                        <div class="wo-item"><span class="name" style="color:var(--text-muted)">Loading...</span></div>
                    </div>
                </div>

                <!-- System Components -->
                <div class="card">
                    <div class="section-title">System Stats</div>
                    <div id="systemStats">
                        <div class="stat-row"><span class="stat-label">Loading...</span></div>
                    </div>
                </div>
            </div>

            <!-- Recent Completions -->
            <div class="card">
                <div class="section-title">Recent Completions (7d)</div>
                <div class="wo-list" id="completionsList">
                    <div class="wo-item"><span class="name" style="color:var(--text-muted)">Loading...</span></div>
                </div>
            </div>
        </div>

        <!-- Brain Sync & State Integrity -->
        <div class="content" style="padding-top:0; margin-top:-8px;">
            <div class="card">
                <div class="section-title">System Pulse</div>
                <div id="systemPulse" class="system-pulse">
                    <span class="pulse-dot"></span>
                    <span>Initializing...</span>
                </div>

                <div class="section-subtitle">Brain Sync</div>
                <div class="brain-sync-grid" id="brainSyncGrid">
                    <div class="sync-card"><div class="sync-info"><span class="sync-label" style="color:var(--text-muted)">Loading...</span></div></div>
                </div>

                <div class="section-subtitle">Enforcement Checks</div>
                <div class="stats-bar" style="margin-bottom:12px;" id="enforcerStats">
                    <div class="mini-card"><div class="mini-value" id="enforcerRuns">--</div><div class="mini-label">Runs (24h)</div></div>
                    <div class="mini-card"><div class="mini-value" id="enforcerFindings">--</div><div class="mini-label">Findings (24h)</div></div>
                    <div class="mini-card"><div class="mini-value" id="enforcerCritical">--</div><div class="mini-label">Critical</div></div>
                    <div class="mini-card"><div class="mini-value" id="enforcerVerified">--</div><div class="mini-label">WOs Verified</div></div>
                </div>
                <div id="integrityChecks">
                    <div class="check-row"><span class="check-label" style="color:var(--text-muted)">Running checks...</span></div>
                </div>
                <div style="margin-top:8px; font-size:11px; color:var(--text-muted);" id="integrityTimestamp"></div>
            </div>
        </div>

        <!-- Enforcement Activity Dashboard -->
        <div class="content" style="padding-top:0; margin-top:-8px;">
            <div class="card">
                <div class="section-title">Enforcement Activity</div>

                <!-- Stats Bar -->
                <div class="stats-bar" id="enforcementStats">
                    <div class="mini-card"><div class="mini-value" id="statTransitions">--</div><div class="mini-label">Transitions (24h)</div></div>
                    <div class="mini-card"><div class="mini-value" id="statRejections">--</div><div class="mini-label">Rejections (24h)</div></div>
                    <div class="mini-card"><div class="mini-value" id="statGates">--</div><div class="mini-label">Gates Evaluated</div></div>
                    <div class="mini-card"><div class="mini-value" id="statPassRate">--</div><div class="mini-label">Pass Rate</div></div>
                </div>

                <div class="grid-wide" style="margin-bottom:16px;">
                    <!-- Event Stream -->
                    <div>
                        <div class="section-subtitle">Event Stream (Recent)</div>
                        <div class="event-stream" id="eventStream">
                            <div class="event-row"><span class="event-action" style="color:var(--text-muted)">Loading...</span></div>
                        </div>
                    </div>

                    <!-- Active Gates -->
                    <div>
                        <div class="section-subtitle">Decision Gates</div>
                        <div id="gateList">
                            <div class="gate-row"><span class="gate-name" style="color:var(--text-muted)">Loading...</span></div>
                        </div>
                    </div>
                </div>

                <div class="section-subtitle">Mutation Stream (Recent)</div>
                <div id="mutationStream" style="max-height:200px; overflow-y:auto;">
                    <div class="mutation-row"><span style="color:var(--text-muted); font-size:12px;">Loading...</span></div>
                </div>
            </div>
        </div>

        <!-- Auto-Approval Monitor -->
        <div class="content" style="padding-top:0; margin-top:-8px;">
            <div class="card">
                <div class="section-title">Auto-Approval Monitor</div>

                <div class="stats-bar" id="approvalStats">
                    <div class="mini-card"><div class="mini-value" id="approvalToday">--</div><div class="mini-label">Auto-Approved (24h)</div></div>
                    <div class="mini-card"><div class="mini-value" id="approvalDenied">--</div><div class="mini-label">Denied (24h)</div></div>
                    <div class="mini-card"><div class="mini-value" id="approvalDryRun">--</div><div class="mini-label">Dry Run (24h)</div></div>
                    <div class="mini-card"><div class="mini-value" id="circuitBreaker">--</div><div class="mini-label">Circuit Breaker</div></div>
                </div>

                <div class="section-subtitle">Recent Evaluations</div>
                <div id="approvalLog" style="max-height:240px; overflow-y:auto;">
                    <div class="approval-row"><span style="color:var(--text-muted); font-size:12px;">No evaluations yet</span></div>
                </div>
            </div>
        </div>

        <!-- Verification Coverage -->
        <div class="content" style="padding-top:0; margin-top:-8px;">
            <div class="card">
                <div class="section-title">E2E Verification Coverage</div>
                <div class="stats-bar" id="verificationStats">
                    <div class="mini-card"><div class="mini-value" id="verifiedCount">--</div><div class="mini-label">Verified</div></div>
                    <div class="mini-card"><div class="mini-value" id="unverifiedCount">--</div><div class="mini-label">Unverified</div></div>
                    <div class="mini-card"><div class="mini-value" id="skippedCount">--</div><div class="mini-label">Skipped</div></div>
                    <div class="mini-card"><div class="mini-value" id="verifCoverage">--</div><div class="mini-label">Coverage %</div></div>
                </div>
            </div>
        </div>

        <footer class="footer">
            Auto-refreshing every 10s &middot; ENDGAME-001
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://phfblljwuvzqzlbzkzpr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoZmJsbGp3dXZ6cXpsYnprenByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjAzODgsImV4cCI6MjA4NTA5NjM4OH0.mWIj2vtQb1F2Pk540f_S9WwsZFwZK0n6oeqUmZgDZlA';

        // Track open drill-down panels across refreshes
        const openPanels = new Set();

        async function apiFetch(endpoint, method = 'GET', body = null) {
            const opts = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                },
            };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(`${SUPABASE_URL}${endpoint}`, opts);
            return res.json();
        }

        function setConnection(ok) {
            const dot = document.getElementById('connDot');
            const label = document.getElementById('connLabel');
            dot.className = 'connection-dot ' + (ok ? 'connected' : 'error');
            label.textContent = ok ? 'Connected' : 'Disconnected';
        }

        function relativeTime(iso) {
            if (!iso) return '--';
            const diff = Date.now() - new Date(iso).getTime();
            if (diff < 60000) return `${Math.floor(diff / 1000)}s ago`;
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        }

        function formatDate(iso) {
            if (!iso) return '--';
            return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function toggleDrillDown(id) {
            const panel = document.getElementById('drill-' + id);
            const row = document.getElementById('check-' + id);
            if (!panel || !row) return;
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                row.classList.remove('expanded');
                openPanels.delete(id);
            } else {
                panel.classList.add('open');
                row.classList.add('expanded');
                openPanels.add(id);
            }
        }

        function classifyAuditEvent(action) {
            if (!action) return { type: 'other', label: 'EVENT' };
            const a = action.toLowerCase();
            if (a.includes('rejected') || a.includes('blocked')) return { type: 'rejected', label: 'BLOCKED' };
            if (a.includes('gates_passed') || a.includes('gate_pass')) return { type: 'gate-pass', label: 'GATE PASS' };
            if (a.includes('gate') && a.includes('pending')) return { type: 'gate-pending', label: 'PENDING' };
            if (a.includes('→')) return { type: 'transition', label: 'TRANSITION' };
            return { type: 'other', label: 'EVENT' };
        }

        async function refresh() {
            try {
                // Fetch all data in parallel
                const [context, status, lastMutations, lastLessons, lastDirectives,
                       auditEvents, decisionGates, mutationStream, docStatus, approvalLog, verifData,
                       enforcerRuns, enforcerFindings] = await Promise.all([
                    apiFetch('/functions/v1/context-load', 'POST', { project_code: 'METIS-001' }),
                    apiFetch('/functions/v1/work-order-executor/status'),
                    apiFetch('/rest/v1/state_mutations?select=target_table,created_at&order=created_at.desc&limit=20').catch(() => []),
                    apiFetch('/rest/v1/lessons?select=created_at,category&order=created_at.desc&limit=1').catch(() => []),
                    apiFetch('/rest/v1/directives?select=created_at&order=created_at.desc&limit=1').catch(() => []),
                    // Enforcement dashboard data
                    apiFetch('/rest/v1/audit_log?select=action,target_type,target_id,actor_type,event_type,created_at&event_type=in.(wo_transition,wo_transition_rejected,deployment_gate_passed,deployment_gate_blocked,qa_checklist_populated)&order=created_at.desc&limit=30').catch(() => []),
                    apiFetch('/rest/v1/decision_gates?select=name,trigger_type,requires_approval,active&order=name').catch(() => []),
                    apiFetch('/rest/v1/state_mutations?select=target_table,mutation_type,created_at&order=created_at.desc&limit=15').catch(() => []),
                    // Doc status (project_documents)
                    apiFetch('/rest/v1/project_documents?select=doc_type,updated_at&order=updated_at.desc&limit=10').catch(() => []),
                    // Auto-approval log
                    apiFetch('/rest/v1/auto_approval_log?select=work_order_id,risk_score,decision,denial_reasons,created_at&order=created_at.desc&limit=20').catch(() => []),
                    // Verification coverage
                    apiFetch('/rest/v1/work_orders?select=verification_status&status=neq.cancelled&status=neq.draft').catch(() => []),
                    // Audit enforcer data
                    apiFetch('/rest/v1/enforcer_runs?select=id,run_timestamp,status,findings_count,critical_findings_count&order=run_timestamp.desc&limit=50').catch(() => []),
                    apiFetch('/rest/v1/enforcer_findings?select=id,work_order_id,finding_type,severity,status,description,created_at&order=created_at.desc&limit=100').catch(() => []),
                ]);

                setConnection(true);
                document.getElementById('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString()}`;

                // Phase
                const phase = context.phase_status || {};
                const pct = phase.completion_pct || 0;
                document.getElementById('completionPct').textContent = pct;
                document.getElementById('phaseBarFill').style.width = pct + '%';
                document.getElementById('currentPhase').textContent = `Phase ${phase.current_phase || '?'}`;
                const phaseBadge = document.getElementById('phaseBadge');
                phaseBadge.textContent = `Phase ${phase.current_phase || '?'} \u2014 ${pct}%`;
                phaseBadge.className = 'badge ' + (pct >= 90 ? 'active' : pct >= 50 ? 'warning' : 'muted');

                // Daemon
                const daemon = context.daemon_status || {};
                const daemonActive = daemon.status === 'active';
                document.getElementById('daemonStatus').textContent = daemonActive ? 'Active' : (daemon.status || 'Unknown');
                const db = document.getElementById('daemonBadge');
                db.textContent = daemonActive ? 'Online' : 'Offline';
                db.className = 'badge ' + (daemonActive ? 'active' : 'error');
                document.getElementById('daemonHeartbeat').textContent = relativeTime(daemon.last_heartbeat);

                // WO Pipeline
                const summary = context.summary || {};
                const inProg = (status.in_progress || []).length;
                const pending = (status.pending || []).length;
                const blocked = summary.blocked_work_orders || 0;
                const drafts = summary.draft_work_orders || 0;
                const total = inProg + pending + drafts + blocked;
                document.getElementById('activeWoCount').textContent = total;
                document.getElementById('pipelineDetail').textContent =
                    `${inProg} in progress \u00b7 ${pending} pending \u00b7 ${drafts} draft \u00b7 ${blocked} blocked`;

                const pipe = document.getElementById('pipeline');
                pipe.innerHTML = '';
                const segments = [
                    { count: inProg, color: '#FBBF24' },
                    { count: pending, color: '#60A5FA' },
                    { count: drafts, color: '#9CA3AF' },
                    { count: blocked, color: '#F87171' },
                ];
                segments.forEach(s => {
                    if (s.count > 0) {
                        const el = document.createElement('div');
                        el.className = 'pipeline-segment';
                        el.style.flex = s.count;
                        el.style.background = s.color;
                        pipe.appendChild(el);
                    }
                });
                if (total === 0) {
                    const el = document.createElement('div');
                    el.className = 'pipeline-segment';
                    el.style.flex = 1;
                    el.style.background = 'var(--bg-hover)';
                    pipe.appendChild(el);
                }

                // Completed
                const completions = context.recent_completions || [];
                document.getElementById('completedCount').textContent = completions.length;
                const lessonStats = context.lesson_stats || {};
                document.getElementById('lessonTotal').textContent = lessonStats.total || 0;
                document.getElementById('directiveTotal').textContent = context.directive_count || 0;

                // Active WO list
                const wos = context.work_orders || [];
                const woList = document.getElementById('woList');
                if (wos.length === 0) {
                    woList.innerHTML = '<div class="wo-item"><span class="name" style="color:var(--text-muted)">No active work orders</span></div>';
                } else {
                    woList.innerHTML = wos.map(wo => `
                        <div class="wo-item">
                            <span class="slug">${escapeHtml(wo.slug)}</span>
                            <span class="name">${escapeHtml(wo.name || '')}</span>
                            <span class="wo-status ${wo.status}">${wo.status}</span>
                        </div>
                    `).join('');
                }

                // Completions list
                const compList = document.getElementById('completionsList');
                if (completions.length === 0) {
                    compList.innerHTML = '<div class="wo-item"><span class="name" style="color:var(--text-muted)">No completions this week</span></div>';
                } else {
                    compList.innerHTML = completions.map(wo => `
                        <div class="wo-item">
                            <span class="slug">${escapeHtml(wo.slug)}</span>
                            <span class="name">${escapeHtml(wo.name || '')}</span>
                            <span class="wo-status done">${formatDate(wo.completed_at)}</span>
                        </div>
                    `).join('');
                }

                // System stats
                const statsEl = document.getElementById('systemStats');
                const manifestCounts = status.manifest_counts || {};
                const lessonsBySev = status.unpromoted_lessons || {};
                const rows = [
                    ['Completed (24h)', status.completed_24h || 0],
                    ['Awaiting Review', (status.awaiting_review || []).length],
                    ['Lessons (unpromoted)', Object.values(lessonsBySev).reduce((a, b) => a + b, 0)],
                    ['Edge Functions', manifestCounts.edge_function || 0],
                    ['RPC Functions', manifestCounts.rpc_function || 0],
                    ['Triggers', manifestCounts.trigger || 0],
                    ['Integrations', manifestCounts.api_integration || 0],
                    ['Harness Version', status.harness_version || '--'],
                ];
                statsEl.innerHTML = rows.map(([l, v]) => `
                    <div class="stat-row">
                        <span class="stat-label">${l}</span>
                        <span class="stat-value">${v}</span>
                    </div>
                `).join('');

                // ── Brain Sync Stoplight ──
                function syncColor(ageMs, greenMs, yellowMs) {
                    if (ageMs == null) return 'red';
                    if (ageMs < greenMs) return 'green';
                    if (ageMs < yellowMs) return 'yellow';
                    return 'red';
                }

                const mutArr = Array.isArray(lastMutations) ? lastMutations : [];
                const woMutations = mutArr.filter(m => m.target_table === 'work_orders');
                const lastWoMutation = woMutations.length > 0 ? new Date(woMutations[0].created_at).getTime() : null;
                const lastAnyMutation = mutArr.length > 0 ? new Date(mutArr[0].created_at).getTime() : null;

                const lessonArr = Array.isArray(lastLessons) ? lastLessons : [];
                const lastLessonTs = lessonArr.length > 0 ? new Date(lessonArr[0].created_at).getTime() : null;

                const dirArr = Array.isArray(lastDirectives) ? lastDirectives : [];
                const lastDirectiveTs = dirArr.length > 0 ? new Date(dirArr[0].created_at).getTime() : null;

                const daemonTs = daemon.last_heartbeat ? new Date(daemon.last_heartbeat).getTime() : null;

                const now = Date.now();
                const syncItems = [
                    { label: 'Work Orders', ts: lastWoMutation, color: syncColor(lastWoMutation ? now - lastWoMutation : null, 21600000, 86400000) },
                    { label: 'Lessons', ts: lastLessonTs, color: syncColor(lastLessonTs ? now - lastLessonTs : null, 43200000, 86400000) },
                    { label: 'Directives', ts: lastDirectiveTs, color: syncColor(lastDirectiveTs ? now - lastDirectiveTs : null, 43200000, 86400000) },
                    { label: 'Daemon', ts: daemonTs, color: syncColor(daemonTs ? now - daemonTs : null, 120000, 600000) },
                    { label: 'State Mutations', ts: lastAnyMutation, color: syncColor(lastAnyMutation ? now - lastAnyMutation : null, 21600000, 86400000) },
                    { label: 'Context API', ts: context.agents ? now : null, color: (context.agents && context.work_orders !== undefined) ? 'green' : 'red' },
                ];

                const redCount = syncItems.filter(s => s.color === 'red').length;
                const yellowCount = syncItems.filter(s => s.color === 'yellow').length;
                const pulseColor = redCount > 0 ? 'red' : yellowCount > 0 ? 'yellow' : 'green';
                const pulseLabel = redCount > 0 ? `${redCount} subsystem${redCount > 1 ? 's' : ''} degraded`
                    : yellowCount > 0 ? `${yellowCount} subsystem${yellowCount > 1 ? 's' : ''} delayed`
                    : 'All systems operational';
                const pulseEl = document.getElementById('systemPulse');
                pulseEl.innerHTML = `<span class="pulse-dot ${pulseColor}"></span><span style="color:var(--text-primary)">${pulseLabel}</span>`;

                const syncGrid = document.getElementById('brainSyncGrid');
                syncGrid.innerHTML = syncItems.map(s => `
                    <div class="sync-card ${s.color}">
                        <div class="stoplight ${s.color}"></div>
                        <div class="sync-info">
                            <span class="sync-label">${s.label}</span>
                            <span class="sync-time">${s.ts ? relativeTime(new Date(s.ts).toISOString()) : 'No data'}</span>
                        </div>
                    </div>
                `).join('');

                // ══════════════════════════════════════════
                // AUDIT ENFORCER STATS
                // ══════════════════════════════════════════
                const enforcerRunsArr = Array.isArray(enforcerRuns) ? enforcerRuns : [];
                const enforcerFindingsArr = Array.isArray(enforcerFindings) ? enforcerFindings : [];

                const oneDayAgo = now - 86400000;
                const runs24h = enforcerRunsArr.filter(r => new Date(r.run_timestamp).getTime() > oneDayAgo);
                const findings24h = enforcerFindingsArr.filter(f => new Date(f.created_at).getTime() > oneDayAgo);
                const criticalFindings = enforcerFindingsArr.filter(f => f.severity === 'critical' && f.status === 'open');

                // Count WOs verified in last 24h
                const verifiedWos24h = runs24h.reduce((acc, r) => acc + (r.findings_count === 0 ? 1 : 0), 0);

                document.getElementById('enforcerRuns').textContent = runs24h.length;
                document.getElementById('enforcerFindings').textContent = findings24h.length;
                document.getElementById('enforcerCritical').textContent = criticalFindings.length;
                document.getElementById('enforcerCritical').style.color = criticalFindings.length > 0 ? 'var(--status-error)' : 'var(--status-active)';
                document.getElementById('enforcerVerified').textContent = verifiedWos24h;

                // ══════════════════════════════════════════
                // ENFORCEMENT CHECKS WITH DRILL-DOWN
                // ══════════════════════════════════════════
                const checks = [];

                // Check 1: Phase status consistency
                const phaseNum = phase.current_phase || 0;
                const phasesData = phase.phases || {};
                const phaseKeys = Object.keys(phasesData);
                const activePhases = phaseKeys.filter(k => phasesData[k]?.status === 'active');
                const completedPhases = phaseKeys.filter(k => phasesData[k]?.status === 'complete');

                let phaseCheckStatus = 'pass';
                let phaseCheckDetail = '';
                if (activePhases.length >= 1 && completedPhases.length >= phaseNum - 1) {
                    phaseCheckDetail = `Phase ${phaseNum} active, ${completedPhases.length} complete`;
                } else if (activePhases.length === 0 && phaseKeys.length > 0) {
                    phaseCheckStatus = 'warn';
                    phaseCheckDetail = 'No active phase detected';
                } else {
                    phaseCheckDetail = `${activePhases.length} active, ${completedPhases.length} complete`;
                }

                checks.push({
                    id: 'phase',
                    status: phaseCheckStatus,
                    label: 'Phase consistency',
                    detail: phaseCheckDetail,
                    reasoning: `Checks that current_phase (${phaseNum}) has a matching active entry in the phases array, and that all prior phases are marked complete.`,
                    rawData: JSON.stringify({ current_phase: phaseNum, completion_pct: pct, phases: phasesData }, null, 2),
                    remediation: phaseCheckStatus === 'pass'
                        ? 'No action needed.'
                        : 'Update project_briefs via migration: set current_phase to match the active phase in the phases array. Ensure all prior phases have status "complete".'
                });

                // Check 2: Stale in_progress WOs (>24h)
                const activeWos = (context.work_orders || []).filter(w => w.status === 'in_progress');
                const staleWos = activeWos.filter(w => {
                    if (!w.started_at) return false;
                    return (now - new Date(w.started_at).getTime()) > 86400000;
                });

                let freshStatus = 'pass';
                let freshDetail = `${activeWos.length} in_progress, none stale`;
                if (staleWos.length > 0) {
                    freshStatus = 'fail';
                    freshDetail = `${staleWos.length} stale >24h: ${staleWos.map(w => w.slug).join(', ')}`;
                }

                checks.push({
                    id: 'freshness',
                    status: freshStatus,
                    label: 'WO freshness',
                    detail: freshDetail,
                    reasoning: `Checks all in_progress work orders have started_at within the last 24 hours. Stale WOs indicate stuck execution.`,
                    rawData: JSON.stringify(activeWos.map(w => ({ slug: w.slug, started_at: w.started_at, age_h: w.started_at ? Math.round((now - new Date(w.started_at).getTime()) / 3600000) : null })), null, 2),
                    remediation: freshStatus === 'pass'
                        ? 'No action needed.'
                        : 'Review stale WOs. Either complete them via `wo review SLUG "summary"` or cancel and re-create if stuck. Check daemon logs for execution failures.'
                });

                // Check 3: State machine enforcement
                const woMutCount = woMutations.length;
                let smStatus = 'pass';
                let smDetail = '';
                if (woMutCount > 0) {
                    smDetail = `${woMutCount} recent WO transitions logged via state_write`;
                } else if (mutArr.length > 0) {
                    smStatus = 'warn';
                    smDetail = 'Mutations logged but no recent WO transitions';
                } else {
                    smStatus = 'warn';
                    smDetail = 'No mutation data \u2014 RLS may block anon reads';
                }

                checks.push({
                    id: 'statemachine',
                    status: smStatus,
                    label: 'State machine',
                    detail: smDetail,
                    reasoning: `Verifies that WO state transitions are being logged to state_mutations table. All WO updates must go through update_work_order_state() RPC which calls state_write(). Zero WO mutations means either no transitions or enforcement bypass.`,
                    rawData: JSON.stringify(mutArr.slice(0, 5), null, 2),
                    remediation: smStatus === 'pass'
                        ? 'No action needed.'
                        : 'Check that enforce_wo_state_changes trigger is active. Verify state_write() RPC is being called. Check RLS policies on state_mutations for anon read access.'
                });

                // Check 4: Learning pipeline
                const lessonCount = lessonStats.total || 0;
                const dirCount = context.directive_count || 0;
                const unpromotedCount = Object.values(lessonsBySev || {}).reduce((a, b) => a + b, 0);
                let lpStatus = 'pass';
                let lpDetail = '';
                if (lessonCount > 0 && dirCount > 0) {
                    lpDetail = `${lessonCount} lessons \u2192 ${dirCount} directives, ${unpromotedCount} queued`;
                } else if (lessonCount > 0 && dirCount === 0) {
                    lpStatus = 'warn';
                    lpDetail = `${lessonCount} lessons but 0 directives \u2014 promoter may not have run`;
                } else {
                    lpDetail = 'No lessons yet';
                }

                checks.push({
                    id: 'learning',
                    status: lpStatus,
                    label: 'Learning pipeline',
                    detail: lpDetail,
                    reasoning: `Checks that lessons are being created from errors and promoted to directives. The lesson-promoter cron runs every 6 hours. Unpromoted lessons queue indicates lessons awaiting promotion.`,
                    rawData: JSON.stringify({ total_lessons: lessonCount, directives: dirCount, unpromoted: unpromotedCount, by_severity: lessonsBySev }, null, 2),
                    remediation: lpStatus === 'pass'
                        ? 'No action needed.'
                        : 'Invoke lesson-promoter edge function manually. Check its cron schedule (0 */6 * * *). Verify lessons table has entries with promoted_at IS NULL.'
                });

                // Check 5: Manifest coverage
                const manifestEfCount = manifestCounts.edge_function || 0;
                let mcStatus = manifestEfCount >= 20 ? 'pass' : 'warn';
                let mcDetail = manifestEfCount >= 20
                    ? `${manifestEfCount} edge functions registered`
                    : `Only ${manifestEfCount} edge functions \u2014 some may be unregistered`;

                checks.push({
                    id: 'manifest',
                    status: mcStatus,
                    label: 'Manifest coverage',
                    detail: mcDetail,
                    reasoning: `Checks that system_manifest has entries for all known edge functions. Target is 20+ (system has ~29 deployed). Missing entries mean components are untracked.`,
                    rawData: JSON.stringify(manifestCounts, null, 2),
                    remediation: mcStatus === 'pass'
                        ? 'No action needed.'
                        : 'Register missing edge functions via state_write() to system_manifest table. Run: SELECT name FROM system_manifest WHERE component_type = \'edge_function\' to see what\'s registered.'
                });

                // Check 6: Audit trail integrity
                checks.push({
                    id: 'audit',
                    status: 'pass',
                    label: 'Audit immutability',
                    detail: 'DELETE/UPDATE blocked by audit_log_immutable trigger',
                    reasoning: `The audit_log_immutable trigger prevents any UPDATE or DELETE on the audit_log table. This ensures the audit trail cannot be tampered with. The trigger is structural and always active.`,
                    rawData: JSON.stringify({ trigger: 'audit_log_immutable', blocks: ['UPDATE', 'DELETE'], table: 'audit_log', active: true }, null, 2),
                    remediation: 'No action needed. If this check fails, the audit_log_immutable trigger has been removed or disabled \u2014 this is a critical security issue.'
                });

                // Check 7: Documentation currency
                const docArr = Array.isArray(docStatus) ? docStatus : [];
                const latestDocUpdate = docArr.length > 0 ? new Date(docArr[0].updated_at).getTime() : null;
                // Compare against last schema change or manifest mutation
                const manifestMuts = (Array.isArray(mutationStream) ? mutationStream : []).filter(m => m.target_table === 'system_manifest');
                const lastManifestMut = manifestMuts.length > 0 ? new Date(manifestMuts[0].created_at).getTime() : null;

                let docCheckStatus = 'pass';
                let docCheckDetail = '';
                if (docArr.length === 0) {
                    docCheckStatus = 'warn';
                    docCheckDetail = 'No project documents found';
                } else if (latestDocUpdate && lastManifestMut && latestDocUpdate < lastManifestMut) {
                    const driftMs = lastManifestMut - latestDocUpdate;
                    if (driftMs > 7 * 86400000) {
                        docCheckStatus = 'fail';
                        docCheckDetail = `Severe drift: docs ${Math.round(driftMs / 86400000)}d behind last manifest change`;
                    } else {
                        docCheckStatus = 'warn';
                        docCheckDetail = `Drift detected: docs ${relativeTime(new Date(latestDocUpdate).toISOString())} vs manifest change ${relativeTime(new Date(lastManifestMut).toISOString())}`;
                    }
                } else {
                    docCheckDetail = `Docs current (last update: ${latestDocUpdate ? relativeTime(new Date(latestDocUpdate).toISOString()) : 'N/A'})`;
                }

                checks.push({
                    id: 'doccurrency',
                    status: docCheckStatus,
                    label: 'Doc currency',
                    detail: docCheckDetail,
                    reasoning: `Compares project_documents.updated_at against the last system_manifest mutation. If docs are older than the last manifest change, architecture documentation may be stale.`,
                    rawData: JSON.stringify({
                        latest_doc_update: latestDocUpdate ? new Date(latestDocUpdate).toISOString() : null,
                        latest_manifest_mutation: lastManifestMut ? new Date(lastManifestMut).toISOString() : null,
                        doc_types: docArr.map(d => d.doc_type),
                        drift_detected: latestDocUpdate && lastManifestMut && latestDocUpdate < lastManifestMut
                    }, null, 2),
                    remediation: docCheckStatus === 'pass'
                        ? 'No action needed.'
                        : 'Run regenerate_architecture_docs() RPC to re-introspect live system and update project_documents. Or trigger doc sync via daemon.'
                });

                // Add enforcer findings to checks with human-readable summaries
                if (enforcerFindingsArr.length > 0) {
                    // Group findings by type
                    const findingsByType = {};
                    enforcerFindingsArr.filter(f => !f.resolved_at).forEach(f => {
                        if (!findingsByType[f.finding_type]) {
                            findingsByType[f.finding_type] = [];
                        }
                        findingsByType[f.finding_type].push(f);
                    });

                    Object.entries(findingsByType).forEach(([type, findings]) => {
                        const critCount = findings.filter(f => f.severity === 'critical').length;
                        const highCount = findings.filter(f => f.severity === 'high').length;
                        const medCount = findings.filter(f => f.severity === 'medium').length;
                        const lowCount = findings.filter(f => f.severity === 'low').length;

                        let status = 'pass';
                        if (critCount > 0) status = 'fail';
                        else if (highCount > 0) status = 'warn';

                        // Human-readable detail
                        const severityCounts = [
                            critCount > 0 ? `${critCount} critical` : null,
                            highCount > 0 ? `${highCount} high` : null,
                            medCount > 0 ? `${medCount} medium` : null,
                            lowCount > 0 ? `${lowCount} low` : null
                        ].filter(Boolean).join(', ');

                        const detail = severityCounts || `${findings.length} info-level findings`;

                        // Create human-readable summary instead of raw JSON
                        const humanReadable = findings.map((f, idx) =>
                            `Finding ${idx + 1} [${f.severity.toUpperCase()}]: ${f.description}\\n` +
                            `  Created: ${relativeTime(f.created_at)}\\n` +
                            (f.work_order_id ? `  WO: ${f.work_order_id}\\n` : '') +
                            (f.remediation_wo_id ? `  Remediation WO: ${f.remediation_wo_id}\\n` : '')
                        ).join('\\n');

                        checks.push({
                            id: 'enforcer-' + type.replace(/_/g, '-'),
                            status: status,
                            label: 'Enforcer: ' + type.replace(/_/g, ' '),
                            detail: detail,
                            reasoning: `Independent audit enforcer detected ${findings.length} ${type} finding(s) through verification of deployed artifacts, schema state, and audit trail cross-validation. Click to expand for details.`,
                            rawData: `=== HUMAN READABLE SUMMARY ===\\n\\n${humanReadable}\\n\\n=== RAW JSON (for debugging) ===\\n${JSON.stringify(findings, null, 2)}`,
                            remediation: critCount > 0 || highCount > 0
                                ? 'Review enforcer_findings table. Remediation WOs may have been auto-generated. Critical findings block WO completion until resolved.'
                                : 'Monitor findings. Low severity findings are informational.'
                        });
                    });
                }

                // Add overall enforcer health check
                const enforcerHealthDetail = runs24h.length === 0
                    ? 'No runs in 24h - enforcer may not be scheduled'
                    : findings24h.length === 0
                    ? `${runs24h.length} runs, no violations detected`
                    : `${runs24h.length} runs, ${findings24h.length} findings (${criticalFindings.length} critical)`;

                checks.push({
                    id: 'enforcer-health',
                    status: runs24h.length === 0 ? 'warn' : criticalFindings.length > 0 ? 'fail' : 'pass',
                    label: 'Enforcer health',
                    detail: enforcerHealthDetail,
                    reasoning: `Audit enforcer runs every 6 hours and on failure events. ${runs24h.length} runs executed in the last 24h. ${findings24h.length} findings generated, ${criticalFindings.length} critical.`,
                    rawData: `Last 5 runs:\\n${JSON.stringify(enforcerRunsArr.slice(0, 5), null, 2)}\\n\\nRecent findings:\\n${JSON.stringify(findings24h.slice(0, 10), null, 2)}`,
                    remediation: runs24h.length === 0
                        ? 'Check enforcer_config table has supabase_url and service_role_key set. Verify cron schedule or manually invoke via schedule_enforcer_run().'
                        : criticalFindings.length > 0
                        ? 'Critical findings detected. Review enforcer_findings table and resolve issues. WOs cannot transition to done until verified.'
                        : 'No action needed.'
                });

                // Render enforcement checks with drill-down panels
                const checksEl = document.getElementById('integrityChecks');
                checksEl.innerHTML = checks.map(c => `
                    <div class="check-row ${openPanels.has(c.id) ? 'expanded' : ''}" id="check-${c.id}" onclick="toggleDrillDown('${c.id}')">
                        <span class="check-icon ${c.status}">${c.status === 'pass' ? '\u2713' : c.status === 'fail' ? '\u2717' : '!'}</span>
                        <span class="check-label">${c.label}</span>
                        <span class="check-detail">${c.detail}</span>
                        <span class="expand-icon">\u25B6</span>
                    </div>
                    <div class="drill-down ${openPanels.has(c.id) ? 'open' : ''}" id="drill-${c.id}">
                        <h4>Reasoning</h4>
                        <p>${escapeHtml(c.reasoning)}</p>
                        <h4>Evidence</h4>
                        ${c.id.startsWith('enforcer-') && c.rawData.includes('HUMAN READABLE') ?
                            `<pre style="white-space: pre-wrap;">${escapeHtml(c.rawData.split('=== RAW JSON')[0].replace('=== HUMAN READABLE SUMMARY ===\\n\\n', ''))}</pre>
                            <details style="margin-top:8px;">
                                <summary style="cursor:pointer; color:var(--text-muted); font-size:11px; font-weight:600;">Show raw JSON</summary>
                                <pre style="margin-top:8px;">${escapeHtml(c.rawData.split('=== RAW JSON (for debugging) ===\\n')[1] || '')}</pre>
                            </details>` :
                            `<pre>${escapeHtml(c.rawData)}</pre>`
                        }
                        <h4>Remediation</h4>
                        <p class="remediation">${escapeHtml(c.remediation)}</p>
                    </div>
                `).join('');
                document.getElementById('integrityTimestamp').textContent = `Last checked: ${new Date().toLocaleTimeString()} • Enforcer: ${runs24h.length} runs (24h)`;

                // ══════════════════════════════════════════
                // ENFORCEMENT ACTIVITY DASHBOARD
                // ══════════════════════════════════════════
                const auditArr = Array.isArray(auditEvents) ? auditEvents : [];
                const mutStreamArr = Array.isArray(mutationStream) ? mutationStream : [];
                const gatesArr = Array.isArray(decisionGates) ? decisionGates : [];

                // Filter 24h events
                const oneDayAgo = now - 86400000;
                const recent24h = auditArr.filter(e => new Date(e.created_at).getTime() > oneDayAgo);
                const transitions24h = recent24h.filter(e => e.event_type === 'wo_transition');
                const rejections24h = recent24h.filter(e => e.event_type === 'wo_transition_rejected');
                const gatesPassed24h = recent24h.filter(e => e.event_type === 'deployment_gate_passed');
                const gatesBlocked24h = recent24h.filter(e => e.event_type === 'deployment_gate_blocked');
                const totalGateEvents = gatesPassed24h.length + gatesBlocked24h.length;
                const passRate = totalGateEvents > 0 ? Math.round((gatesPassed24h.length / totalGateEvents) * 100) : 100;

                document.getElementById('statTransitions').textContent = transitions24h.length;
                document.getElementById('statRejections').textContent = rejections24h.length;
                document.getElementById('statRejections').style.color = rejections24h.length > 0 ? 'var(--status-error)' : 'var(--text-primary)';
                document.getElementById('statGates').textContent = totalGateEvents;
                document.getElementById('statPassRate').textContent = passRate + '%';
                document.getElementById('statPassRate').style.color = passRate >= 90 ? 'var(--status-active)' : passRate >= 70 ? 'var(--status-warning)' : 'var(--status-error)';

                // Event stream
                const eventStreamEl = document.getElementById('eventStream');
                if (auditArr.length === 0) {
                    eventStreamEl.innerHTML = '<div class="event-row"><span class="event-action" style="color:var(--text-muted)">No enforcement events</span></div>';
                } else {
                    eventStreamEl.innerHTML = auditArr.map(e => {
                        const cls = classifyAuditEvent(e.action);
                        return `<div class="event-row">
                            <span class="event-badge ${cls.type}">${cls.label}</span>
                            <span class="event-action">${escapeHtml(e.action || e.event_type || 'unknown')}</span>
                            <span class="event-time">${relativeTime(e.created_at)}</span>
                        </div>`;
                    }).join('');
                }

                // Decision gates
                const gateListEl = document.getElementById('gateList');
                if (gatesArr.length === 0) {
                    gateListEl.innerHTML = '<div class="gate-row"><span class="gate-name" style="color:var(--text-muted)">No decision gates</span></div>';
                } else {
                    gateListEl.innerHTML = gatesArr.map(g => `
                        <div class="gate-row">
                            <span class="check-icon ${g.active ? 'pass' : 'warn'}" style="width:16px;height:16px;font-size:10px;">${g.active ? '\u2713' : '\u2014'}</span>
                            <span class="gate-name">${escapeHtml(g.name)}</span>
                            <span class="gate-type">${escapeHtml(g.trigger_type)}</span>
                            <span class="badge ${g.requires_approval ? 'warning' : 'active'}" style="font-size:10px;padding:1px 6px;">${g.requires_approval ? 'Approval' : 'Auto'}</span>
                        </div>
                    `).join('');
                }

                // Mutation stream
                const mutStreamEl = document.getElementById('mutationStream');
                if (mutStreamArr.length === 0) {
                    mutStreamEl.innerHTML = '<div class="mutation-row"><span style="color:var(--text-muted); font-size:12px;">No recent mutations</span></div>';
                } else {
                    mutStreamEl.innerHTML = mutStreamArr.map(m => `
                        <div class="mutation-row">
                            <span class="mutation-table">${escapeHtml(m.target_table)}</span>
                            <span class="mutation-type ${m.mutation_type}">${m.mutation_type}</span>
                            <span class="mutation-time">${relativeTime(m.created_at)}</span>
                        </div>
                    `).join('');
                }

                // ══════════════════════════════════════════
                // AUTO-APPROVAL MONITOR
                // ══════════════════════════════════════════
                const approvalArr = Array.isArray(approvalLog) ? approvalLog : [];
                const recent24hApproval = approvalArr.filter(a => new Date(a.created_at).getTime() > oneDayAgo);
                const approved24h = recent24hApproval.filter(a => a.decision === 'approved').length;
                const denied24h = recent24hApproval.filter(a => a.decision === 'denied').length;
                const dryRun24h = recent24hApproval.filter(a => a.decision === 'dry_run').length;

                document.getElementById('approvalToday').textContent = approved24h;
                document.getElementById('approvalDenied').textContent = denied24h;
                document.getElementById('approvalDryRun').textContent = dryRun24h;

                // Check circuit breaker from user_preferences
                const failedRecent = recent24hApproval.filter(a => a.decision === 'approved');
                // Circuit breaker: just display status
                const cbEl = document.getElementById('circuitBreaker');
                if (approved24h >= 5) {
                    cbEl.textContent = 'LIMIT';
                    cbEl.style.color = 'var(--status-warning)';
                } else {
                    cbEl.textContent = 'OK';
                    cbEl.style.color = 'var(--status-active)';
                }

                // Approval log
                const approvalLogEl = document.getElementById('approvalLog');
                if (approvalArr.length === 0) {
                    approvalLogEl.innerHTML = '<div class="approval-row"><span style="color:var(--text-muted); font-size:12px;">No evaluations yet</span></div>';
                } else {
                    approvalLogEl.innerHTML = approvalArr.map(a => `
                        <div class="approval-row">
                            <span class="approval-decision ${a.decision}">${a.decision}</span>
                            <span style="font-family:monospace; font-size:11px; color:var(--accent); min-width:60px;">Risk: ${a.risk_score != null ? Number(a.risk_score).toFixed(0) : '?'}</span>
                            <span style="flex:1; color:var(--text-secondary); font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                ${a.denial_reasons && a.denial_reasons.length > 0 ? escapeHtml(a.denial_reasons.join(', ')) : ''}
                            </span>
                            <span style="color:var(--text-muted); font-size:11px;">${relativeTime(a.created_at)}</span>
                        </div>
                    `).join('');
                }

                // ══════════════════════════════════════════
                // VERIFICATION COVERAGE
                // ══════════════════════════════════════════
                const verifArr = Array.isArray(verifData) ? verifData : [];
                const vVerified = verifArr.filter(w => w.verification_status === 'verified').length;
                const vUnverified = verifArr.filter(w => w.verification_status === 'unverified' || !w.verification_status).length;
                const vSkipped = verifArr.filter(w => w.verification_status === 'skipped').length;
                const vFailed = verifArr.filter(w => w.verification_status === 'failed').length;
                const vTotal = verifArr.length;
                const vCoverage = vTotal > 0 ? Math.round(((vVerified + vSkipped) / vTotal) * 100) : 0;

                document.getElementById('verifiedCount').textContent = vVerified;
                document.getElementById('unverifiedCount').textContent = vUnverified + vFailed;
                document.getElementById('unverifiedCount').style.color = (vUnverified + vFailed) > 0 ? 'var(--status-warning)' : 'var(--text-primary)';
                document.getElementById('skippedCount').textContent = vSkipped;
                document.getElementById('verifCoverage').textContent = vCoverage + '%';
                document.getElementById('verifCoverage').style.color = vCoverage >= 80 ? 'var(--status-active)' : vCoverage >= 50 ? 'var(--status-warning)' : 'var(--status-error)';

            } catch (err) {
                console.error('Refresh error:', err);
                setConnection(false);
            }
        }

        refresh();
        setInterval(refresh, 10000);
    </script>
</body>
</html>
