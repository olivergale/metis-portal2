<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Dashboard - ENDGAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #2b2a27;
            --bg-surface: #353432;
            --bg-elevated: #3f3e3b;
            --bg-hover: #4a4946;
            --text-primary: #ececec;
            --text-secondary: #b8b8b6;
            --text-muted: #888886;
            --border-default: #4a4946;
            --border-strong: #5a5956;
            --accent: #d4a574;
            --accent-hover: #e0b588;
            --accent-subtle: rgba(212, 165, 116, 0.15);
            --status-active: #34D399;
            --status-warning: #FBBF24;
            --status-error: #F87171;
            --status-muted: #9CA3AF;
            --status-blue: #60A5FA;
            --status-purple: #A78BFA;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .layout { display: flex; flex-direction: column; min-height: 100vh; }

        /* Nav */
        .top-nav {
            display: flex; align-items: center; gap: 24px;
            padding: 12px 32px; background: var(--bg-surface);
            border-bottom: 1px solid var(--border-default);
        }
        .top-nav .logo { font-weight: 700; font-size: 15px; color: var(--accent); letter-spacing: 0.5px; }
        .top-nav a { color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 500; padding: 4px 0; transition: color 0.15s; }
        .top-nav a:hover { color: var(--text-primary); }
        .top-nav a.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .nav-spacer { flex: 1; }
        .connection-badge { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-muted); }
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--status-muted); }
        .connection-dot.connected { background: var(--status-active); }
        .connection-dot.error { background: var(--status-error); }

        /* Content */
        .content { flex: 1; padding: 32px; max-width: 1400px; margin: 0 auto; width: 100%; }

        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .page-header h1 { font-size: 22px; font-weight: 600; }
        .page-header .subtitle { font-size: 13px; color: var(--text-muted); }

        /* Date selector */
        .date-controls { display: flex; align-items: center; gap: 8px; }
        .date-btn {
            padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border-default);
            background: var(--bg-surface); color: var(--text-secondary); font-size: 12px; font-weight: 500;
            cursor: pointer; transition: all 0.15s;
        }
        .date-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .date-btn.active { background: var(--accent-subtle); color: var(--accent); border-color: var(--accent); }

        /* Delta cards */
        .delta-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 28px; }
        .delta-card {
            background: var(--bg-surface); border: 1px solid var(--border-default);
            border-radius: 10px; padding: 16px;
        }
        .delta-card .label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 6px; }
        .delta-card .value { font-size: 28px; font-weight: 700; line-height: 1.1; }
        .delta-card .delta { font-size: 12px; font-weight: 600; margin-top: 4px; }
        .delta-card .delta.up { color: var(--status-active); }
        .delta-card .delta.down { color: var(--status-error); }
        .delta-card .delta.neutral { color: var(--text-muted); }
        .delta-card .baseline { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        /* Chart grid */
        .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        .chart-card {
            background: var(--bg-surface); border: 1px solid var(--border-default);
            border-radius: 10px; padding: 20px;
        }
        .chart-card h3 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px; }
        .chart-container { position: relative; height: 180px; }
        .chart-container canvas { width: 100%; height: 100%; }
        .chart-empty { display: flex; align-items: center; justify-content: center; height: 180px; color: var(--text-muted); font-size: 13px; }
        .chart-legend { display: flex; gap: 16px; margin-top: 8px; font-size: 11px; color: var(--text-muted); }
        .chart-legend .swatch { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; vertical-align: middle; }

        /* Full-width chart */
        .chart-card.full { grid-column: 1 / -1; }
        .chart-card.full .chart-container { height: 200px; }

        .footer { padding: 12px 32px; text-align: center; font-size: 12px; color: var(--text-muted); border-top: 1px solid var(--border-default); }

        @media (max-width: 900px) { .chart-grid { grid-template-columns: 1fr; } .delta-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .delta-grid { grid-template-columns: 1fr; } .content { padding: 16px; } .top-nav { padding: 12px 16px; gap: 16px; } }
    </style>
</head>
<body>
    <div class="layout">
        <nav class="top-nav">
            <span class="logo">ENDGAME</span>
            <a href="index.html">Chat</a>
            <a href="workspace.html">Workspace</a>
            <a href="health.html">Health</a>
            <a href="dashboard.html" class="active">Dashboard</a>
            <span class="nav-spacer"></span>
            <div class="connection-badge">
                <span class="connection-dot" id="connDot"></span>
                <span id="connLabel">Connecting...</span>
            </div>
        </nav>

        <div class="content">
            <div class="page-header">
                <div>
                    <h1>Platform Dashboard</h1>
                    <span class="subtitle" id="lastUpdated">Loading...</span>
                </div>
                <div class="date-controls">
                    <button class="date-btn" data-range="7">7d</button>
                    <button class="date-btn active" data-range="30">30d</button>
                    <button class="date-btn" data-range="90">90d</button>
                    <button class="date-btn" data-range="all">All</button>
                </div>
            </div>

            <!-- Baseline Delta Cards -->
            <div class="delta-grid" id="deltaGrid">
                <div class="delta-card"><div class="label">Loading...</div></div>
            </div>

            <!-- Charts -->
            <div class="chart-grid">
                <div class="chart-card full">
                    <h3>WO Pipeline</h3>
                    <div class="chart-container"><canvas id="chart-pipeline"></canvas></div>
                    <div class="chart-legend">
                        <span><span class="swatch" style="background:#34D399"></span>Done</span>
                        <span><span class="swatch" style="background:#F87171"></span>Cancelled</span>
                        <span><span class="swatch" style="background:#60A5FA"></span>In Flight</span>
                        <span><span class="swatch" style="background:#d4a574"></span>Total</span>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>QA Pass Rate</h3>
                    <div class="chart-container"><canvas id="chart-qa"></canvas></div>
                </div>

                <div class="chart-card">
                    <h3>Lesson Application Rate</h3>
                    <div class="chart-container"><canvas id="chart-lessons"></canvas></div>
                </div>

                <div class="chart-card">
                    <h3>Enforcer Coverage</h3>
                    <div class="chart-container"><canvas id="chart-enforcer"></canvas></div>
                </div>

                <div class="chart-card">
                    <h3>Auto-Approval Rate</h3>
                    <div class="chart-container"><canvas id="chart-approval"></canvas></div>
                </div>

                <div class="chart-card">
                    <h3>Verification Coverage</h3>
                    <div class="chart-container"><canvas id="chart-verification"></canvas></div>
                </div>

                <div class="chart-card">
                    <h3>Edge Function JWT Coverage</h3>
                    <div class="chart-container"><canvas id="chart-jwt"></canvas></div>
                </div>
            </div>
        </div>

        <footer class="footer">
            Auto-refreshing every 30s &middot; ENDGAME-001 Platform Dashboard
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://phfblljwuvzqzlbzkzpr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoZmJsbGp3dXZ6cXpsYnprenByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjAzODgsImV4cCI6MjA4NTA5NjM4OH0.mWIj2vtQb1F2Pk540f_S9WwsZFwZK0n6oeqUmZgDZlA';

        let selectedRange = 30;
        let allSnapshots = [];

        async function apiFetch(endpoint) {
            const res = await fetch(`${SUPABASE_URL}${endpoint}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                },
            });
            return res.json();
        }

        function setConnection(ok) {
            document.getElementById('connDot').className = 'connection-dot ' + (ok ? 'connected' : 'error');
            document.getElementById('connLabel').textContent = ok ? 'Connected' : 'Disconnected';
        }

        function formatDate(iso) {
            if (!iso) return '--';
            const d = new Date(iso);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateTime(iso) {
            if (!iso) return '--';
            const d = new Date(iso);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Filter snapshots by selected date range
        function filteredSnapshots() {
            if (selectedRange === 'all') return allSnapshots;
            const cutoff = Date.now() - (selectedRange * 86400000);
            return allSnapshots.filter(s => new Date(s.snapshot_at).getTime() > cutoff);
        }

        // --- Mini chart renderer ---
        function drawChart(canvasId, datasets, opts = {}) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            const W = rect.width;
            const H = rect.height;

            ctx.clearRect(0, 0, W, H);

            if (!datasets || datasets.length === 0 || datasets[0].points.length === 0) {
                ctx.fillStyle = '#888886';
                ctx.font = '13px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No snapshot data yet', W / 2, H / 2);
                return;
            }

            const pad = { top: 20, right: 16, bottom: 32, left: 48 };
            const chartW = W - pad.left - pad.right;
            const chartH = H - pad.top - pad.bottom;

            // Compute global Y range
            let yMin = opts.yMin != null ? opts.yMin : Infinity;
            let yMax = opts.yMax != null ? opts.yMax : -Infinity;
            datasets.forEach(ds => {
                ds.points.forEach(p => {
                    if (p.y < yMin) yMin = p.y;
                    if (p.y > yMax) yMax = p.y;
                });
            });
            if (yMin === yMax) { yMin -= 1; yMax += 1; }
            const yRange = yMax - yMin;

            // X range from timestamps
            const allTimestamps = datasets[0].points.map(p => p.x);
            const xMin = Math.min(...allTimestamps);
            const xMax = Math.max(...allTimestamps);
            const xRange = xMax - xMin || 1;

            function toX(ts) { return pad.left + ((ts - xMin) / xRange) * chartW; }
            function toY(val) { return pad.top + chartH - ((val - yMin) / yRange) * chartH; }

            // Grid lines
            ctx.strokeStyle = '#4a4946';
            ctx.lineWidth = 0.5;
            const ySteps = 4;
            for (let i = 0; i <= ySteps; i++) {
                const y = pad.top + (i / ySteps) * chartH;
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
                const val = yMax - (i / ySteps) * yRange;
                ctx.fillStyle = '#888886';
                ctx.font = '10px Inter, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(opts.isPercent ? val.toFixed(0) + '%' : val.toFixed(0), pad.left - 6, y + 3);
            }

            // X axis labels
            const points0 = datasets[0].points;
            const xLabelCount = Math.min(points0.length, 6);
            const xStep = Math.max(1, Math.floor(points0.length / xLabelCount));
            ctx.fillStyle = '#888886';
            ctx.font = '10px Inter, sans-serif';
            ctx.textAlign = 'center';
            for (let i = 0; i < points0.length; i += xStep) {
                const p = points0[i];
                const x = toX(p.x);
                ctx.fillText(formatDate(new Date(p.x).toISOString()), x, H - 6);
            }

            // Draw lines and points
            datasets.forEach(ds => {
                if (ds.points.length === 0) return;
                ctx.strokeStyle = ds.color;
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';

                // Fill area
                if (ds.fill) {
                    ctx.beginPath();
                    ctx.moveTo(toX(ds.points[0].x), toY(ds.points[0].y));
                    ds.points.forEach(p => ctx.lineTo(toX(p.x), toY(p.y)));
                    ctx.lineTo(toX(ds.points[ds.points.length - 1].x), pad.top + chartH);
                    ctx.lineTo(toX(ds.points[0].x), pad.top + chartH);
                    ctx.closePath();
                    ctx.fillStyle = ds.color.replace(')', ', 0.1)').replace('rgb', 'rgba');
                    ctx.fill();
                }

                // Line
                ctx.beginPath();
                ds.points.forEach((p, i) => {
                    const x = toX(p.x); const y = toY(p.y);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // Points
                ds.points.forEach(p => {
                    const x = toX(p.x); const y = toY(p.y);
                    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fillStyle = ds.color; ctx.fill();
                    ctx.strokeStyle = '#2b2a27'; ctx.lineWidth = 1.5; ctx.stroke();
                });

                // Latest value label
                if (ds.points.length > 0) {
                    const last = ds.points[ds.points.length - 1];
                    const x = toX(last.x); const y = toY(last.y);
                    ctx.fillStyle = ds.color;
                    ctx.font = 'bold 11px Inter, sans-serif';
                    ctx.textAlign = 'left';
                    const label = opts.isPercent ? last.y.toFixed(1) + '%' : last.y.toFixed(0);
                    ctx.fillText(label, x + 6, y - 6);
                }
            });
        }

        // --- Delta card rendering ---
        function renderDeltaCards(snapshots) {
            const grid = document.getElementById('deltaGrid');
            if (snapshots.length === 0) {
                grid.innerHTML = '<div class="delta-card"><div class="label">No snapshots</div><div class="value" style="color:var(--text-muted)">--</div></div>';
                return;
            }

            const latest = snapshots[snapshots.length - 1];
            const baseline = snapshots[0]; // First snapshot is baseline

            const metrics = [
                { key: 'wo_total', label: 'Total WOs', fmt: v => v },
                { key: 'wo_done', label: 'WOs Done', fmt: v => v },
                { key: 'qa_pass_rate_pct', label: 'QA Pass Rate', fmt: v => v + '%', invert: false },
                { key: 'lesson_application_rate_pct', label: 'Lesson Rate', fmt: v => v + '%' },
                { key: 'enforcer_coverage_pct', label: 'Enforcer Coverage', fmt: v => v + '%' },
                { key: 'auto_approval_success_rate_pct', label: 'Auto-Approval', fmt: v => v + '%' },
                { key: 'edge_functions_total', label: 'Edge Functions', fmt: v => v },
            ];

            grid.innerHTML = metrics.map(m => {
                const current = Number(latest[m.key]) || 0;
                const base = Number(baseline[m.key]) || 0;
                const diff = current - base;
                const isOnlyOne = snapshots.length === 1;
                let deltaClass = 'neutral';
                let deltaText = 'baseline';
                if (!isOnlyOne) {
                    deltaClass = diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral';
                    const sign = diff > 0 ? '+' : '';
                    deltaText = `${sign}${m.key.includes('pct') ? diff.toFixed(1) + '%' : diff} from baseline`;
                }
                return `<div class="delta-card">
                    <div class="label">${m.label}</div>
                    <div class="value">${m.fmt(current)}</div>
                    <div class="delta ${deltaClass}">${isOnlyOne ? '' : (diff > 0 ? '\u2191' : diff < 0 ? '\u2193' : '\u2194')} ${deltaText}</div>
                    <div class="baseline">Baseline: ${m.fmt(base)}</div>
                </div>`;
            }).join('');
        }

        // --- Main refresh ---
        async function refresh() {
            try {
                const data = await apiFetch('/rest/v1/platform_health_snapshots?select=*&order=snapshot_at.asc');
                setConnection(true);
                allSnapshots = Array.isArray(data) ? data : [];
                document.getElementById('lastUpdated').textContent =
                    `${allSnapshots.length} snapshot${allSnapshots.length !== 1 ? 's' : ''} \u00b7 Updated ${new Date().toLocaleTimeString()}`;
                render();
            } catch (err) {
                console.error('Refresh error:', err);
                setConnection(false);
            }
        }

        function render() {
            const snaps = filteredSnapshots();
            renderDeltaCards(snaps);

            const points = snaps.map(s => ({ x: new Date(s.snapshot_at).getTime(), ...s }));

            // Chart 1: WO Pipeline (multi-line)
            drawChart('chart-pipeline', [
                { color: '#d4a574', points: points.map(p => ({ x: p.x, y: Number(p.wo_total) })), fill: false },
                { color: '#34D399', points: points.map(p => ({ x: p.x, y: Number(p.wo_done) })), fill: true },
                { color: '#F87171', points: points.map(p => ({ x: p.x, y: Number(p.wo_cancelled) })), fill: false },
                { color: '#60A5FA', points: points.map(p => ({ x: p.x, y: Number(p.wo_in_flight) })), fill: false },
            ]);

            // Chart 2: QA Pass Rate
            drawChart('chart-qa', [
                { color: '#34D399', points: points.map(p => ({ x: p.x, y: Number(p.qa_pass_rate_pct) })), fill: true },
            ], { isPercent: true, yMin: 0, yMax: 100 });

            // Chart 3: Lesson Application Rate
            drawChart('chart-lessons', [
                { color: '#A78BFA', points: points.map(p => ({ x: p.x, y: Number(p.lesson_application_rate_pct) })), fill: true },
            ], { isPercent: true, yMin: 0, yMax: 100 });

            // Chart 4: Enforcer Coverage
            drawChart('chart-enforcer', [
                { color: '#FBBF24', points: points.map(p => ({ x: p.x, y: Number(p.enforcer_coverage_pct) })), fill: true },
            ], { isPercent: true, yMin: 0, yMax: 100 });

            // Chart 5: Auto-Approval Rate
            drawChart('chart-approval', [
                { color: '#60A5FA', points: points.map(p => ({ x: p.x, y: Number(p.auto_approval_success_rate_pct) })), fill: true },
            ], { isPercent: true, yMin: 0, yMax: 100 });

            // Chart 6: Verification Coverage
            drawChart('chart-verification', [
                { color: '#34D399', points: points.map(p => ({ x: p.x, y: Number(p.verification_pass_rate_pct) })), fill: true },
            ], { isPercent: true, yMin: 0, yMax: 100 });

            // Chart 7: JWT Coverage
            drawChart('chart-jwt', [
                { color: '#d4a574', points: points.map(p => ({ x: p.x, y: Number(p.jwt_coverage_pct) })), fill: true },
            ], { isPercent: true, yMin: 0, yMax: 100 });
        }

        // Date range buttons
        document.querySelectorAll('.date-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedRange = btn.dataset.range === 'all' ? 'all' : Number(btn.dataset.range);
                render();
            });
        });

        // Resize handler
        window.addEventListener('resize', () => { if (allSnapshots.length > 0) render(); });

        // Init
        refresh();
        setInterval(refresh, 30000);
    </script>
</body>
</html>
