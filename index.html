<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metis Portal</title>
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    .prose { color: #e5e7eb; line-height: 1.75; }
    .prose h1, .prose h2, .prose h3, .prose h4 { color: #f3f4f6; font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; }
    .prose h1 { font-size: 1.5em; }
    .prose h2 { font-size: 1.25em; }
    .prose h3 { font-size: 1.1em; }
    .prose p { margin: 0.75em 0; }
    .prose ul, .prose ol { padding-left: 1.5em; margin: 0.75em 0; }
    .prose li { margin: 0.25em 0; }
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
    .prose strong { color: #f9fafb; font-weight: 600; }
    .prose em { font-style: italic; }
    .prose a { color: #60a5fa; text-decoration: underline; }
    .prose blockquote { border-left: 3px solid #4b5563; padding-left: 1em; margin: 1em 0; color: #9ca3af; }
    .prose hr { border-color: #374151; margin: 1.5em 0; }
    .prose pre { margin: 0; padding: 0; background: transparent; }
    .prose code { background: #1e1e1e; padding: 2px 6px; border-radius: 4px; font-size: 0.875em; }
    .prose pre code { padding: 1rem; display: block; overflow-x: auto; background: #0d1117; border-radius: 8px; }
    .copy-btn { position: absolute; top: 8px; right: 8px; opacity: 0; transition: opacity 0.2s; }
    .code-block:hover .copy-btn { opacity: 1; }
    .message-content table { border-collapse: collapse; margin: 1rem 0; }
    .message-content th, .message-content td { border: 1px solid #374151; padding: 8px 12px; }
    .message-content th { background: #1f2937; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
  <div id="root"></div>
  <script>
    var e = React.createElement;
    var useState = React.useState;
    var useEffect = React.useEffect;
    var useRef = React.useRef;
    
    var SUPABASE_URL = 'https://phfblljwuvzqzlbzkzpr.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoZmJsbGp3dXZ6cXpsYnprenByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5NDI5MzYsImV4cCI6MjA1MzUxODkzNn0.kPykOvy2rXy1B9gHrWmQ6ArBq0VqdZdhNfpU20J3vvU';
    var LANGFUSE_URL = 'https://us.cloud.langfuse.com';

    function MessageContent(props) {
      var content = props.content;
      var containerRef = useRef(null);
      
      useEffect(function() {
        if (containerRef.current && content) {
          marked.setOptions({
            highlight: function(code, lang) {
              if (lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
              }
              return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
          });
          
          containerRef.current.innerHTML = marked.parse(content);
          
          containerRef.current.querySelectorAll('pre').forEach(function(pre) {
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block relative';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);
            
            var btn = document.createElement('button');
            btn.className = 'copy-btn absolute bg-gray-700 hover:bg-gray-600 text-xs px-2 py-1 rounded';
            btn.textContent = 'Copy';
            btn.onclick = function() {
              navigator.clipboard.writeText(pre.textContent);
              btn.textContent = 'Copied!';
              setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
            };
            wrapper.appendChild(btn);
          });
        }
      }, [content]);
      
      return e('div', { ref: containerRef, className: 'message-content prose prose-invert max-w-none' });
    }

    function App() {
      var threadsState = useState([]);
      var threads = threadsState[0];
      var setThreads = threadsState[1];
      
      var currentThreadState = useState(null);
      var currentThread = currentThreadState[0];
      var setCurrentThread = currentThreadState[1];
      
      var messagesState = useState([]);
      var messages = messagesState[0];
      var setMessages = messagesState[1];
      
      var inputState = useState('');
      var input = inputState[0];
      var setInput = inputState[1];
      
      var loadingState = useState(false);
      var loading = loadingState[0];
      var setLoading = loadingState[1];
      
      var projectCodeState = useState('METIS-001');
      var projectCode = projectCodeState[0];
      var setProjectCode = projectCodeState[1];
      
      var statsState = useState({ directives: 0, cost: 0, tokens: 0 });
      var stats = statsState[0];
      var setStats = statsState[1];
      
      var lastContextState = useState(null);
      var lastContext = lastContextState[0];
      var setLastContext = lastContextState[1];
      
      var observabilityState = useState(null);
      var observability = observabilityState[0];
      var setObservability = observabilityState[1];
      
      var sidebarOpenState = useState(true);
      var sidebarOpen = sidebarOpenState[0];
      var setSidebarOpen = sidebarOpenState[1];
      
      var messagesEndRef = useRef(null);

      function loadThreads() {
        fetch(SUPABASE_URL + '/functions/v1/portal-threads')
          .then(function(res) { return res.json(); })
          .then(function(data) { setThreads(data.threads || []); })
          .catch(function(err) { console.error('Failed to load threads:', err); });
      }

      function loadThread(threadId) {
        fetch(SUPABASE_URL + '/rest/v1/thread_messages?thread_id=eq.' + threadId + '&order=created_at.asc', {
          headers: { 'apikey': SUPABASE_ANON_KEY }
        })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            setMessages(data.map(function(m) {
              return {
                role: m.role,
                content: m.content,
                tokens: (m.input_tokens || 0) + (m.output_tokens || 0),
                cost: m.cost_usd,
                model: m.model_used,
                trace_id: m.trace_id
              };
            }));
            setCurrentThread(threadId);
            
            var thread = threads.find(function(t) { return t.id === threadId; });
            if (thread) {
              setStats(function(prev) {
                return {
                  directives: prev.directives,
                  cost: parseFloat(thread.total_cost_usd) || 0,
                  tokens: thread.total_tokens || 0
                };
              });
            }
          })
          .catch(function(err) { console.error('Failed to load thread:', err); });
      }

      function sendMessage(evt) {
        evt.preventDefault();
        if (!input.trim() || loading) return;
        
        var userMessage = input.trim();
        setInput('');
        setMessages(function(prev) { return prev.concat([{ role: 'user', content: userMessage }]); });
        setLoading(true);
        
        fetch(SUPABASE_URL + '/functions/v1/portal-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: userMessage,
            thread_id: currentThread,
            project_code: projectCode
          })
        })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            if (data.error) {
              setMessages(function(prev) { return prev.concat([{ role: 'error', content: data.error }]); });
            } else {
              var usage = data.usage || {};
              var obs = data.observability || {};
              setMessages(function(prev) {
                return prev.concat([{
                  role: 'assistant',
                  content: data.message,
                  tokens: (usage.input_tokens || 0) + (usage.output_tokens || 0),
                  cost: usage.cost_usd,
                  latency: usage.latency_ms,
                  llm_latency: usage.llm_latency_ms,
                  trace_id: obs.trace_id
                }]);
              });
              
              if (!currentThread && data.thread_id) {
                setCurrentThread(data.thread_id);
                loadThreads();
              }
              
              setLastContext(data.context);
              setObservability(data.observability);
              var ctx = data.context || {};
              setStats(function(prev) {
                return {
                  directives: ctx.directives_applied || prev.directives,
                  cost: prev.cost + (usage.cost_usd || 0),
                  tokens: prev.tokens + (usage.input_tokens || 0) + (usage.output_tokens || 0)
                };
              });
            }
          })
          .catch(function(err) {
            setMessages(function(prev) { return prev.concat([{ role: 'error', content: String(err) }]); });
          })
          .finally(function() {
            setLoading(false);
          });
      }

      function newThread() {
        setCurrentThread(null);
        setMessages([]);
        setStats({ directives: 0, cost: 0, tokens: 0 });
        setLastContext(null);
        setObservability(null);
      }

      useEffect(function() {
        loadThreads();
      }, []);

      useEffect(function() {
        if (messagesEndRef.current) {
          messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
      }, [messages]);

      return e('div', { className: 'h-screen flex' },
        // Sidebar
        e('div', { className: (sidebarOpen ? 'w-72' : 'w-0') + ' transition-all duration-300 bg-gray-800 border-r border-gray-700 flex flex-col overflow-hidden' },
          // Header
          e('div', { className: 'p-4 border-b border-gray-700' },
            e('div', { className: 'flex items-center justify-between mb-4' },
              e('h1', { className: 'text-xl font-bold text-blue-400' }, 'Metis Portal')
            ),
            e('button', {
              onClick: newThread,
              className: 'w-full bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-lg'
            }, '+ New Thread')
          ),
          // Project selector
          e('div', { className: 'p-4 border-b border-gray-700' },
            e('label', { className: 'text-xs text-gray-400 block mb-1' }, 'Project'),
            e('select', {
              value: projectCode,
              onChange: function(evt) { setProjectCode(evt.target.value); },
              className: 'w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm'
            },
              e('option', { value: 'METIS-001' }, 'METIS-001'),
              e('option', { value: 'ILMARINEN-001' }, 'ILMARINEN-001')
            )
          ),
          // Thread list
          e('div', { className: 'flex-1 overflow-y-auto scrollbar-thin p-2' },
            e('div', { className: 'text-xs text-gray-400 px-2 mb-2' }, 'Recent Threads'),
            threads.map(function(t) {
              return e('button', {
                key: t.id,
                onClick: function() { loadThread(t.id); },
                className: 'w-full text-left px-3 py-2 rounded-lg mb-1 text-sm ' + (currentThread === t.id ? 'bg-gray-700' : 'hover:bg-gray-700/50')
              },
                e('div', { className: 'truncate' }, t.title || 'Untitled'),
                e('div', { className: 'text-xs text-gray-500' }, t.message_count + ' msgs | $' + parseFloat(t.total_cost_usd || 0).toFixed(4))
              );
            })
          ),
          // Stats
          e('div', { className: 'p-4 border-t border-gray-700 text-xs text-gray-400' },
            e('div', { className: 'flex justify-between mb-1' },
              e('span', null, 'Directives'),
              e('span', { className: 'text-green-400' }, stats.directives + ' active')
            ),
            e('div', { className: 'flex justify-between mb-1' },
              e('span', null, 'Session Cost'),
              e('span', null, '$' + stats.cost.toFixed(4))
            ),
            e('div', { className: 'flex justify-between mb-1' },
              e('span', null, 'Tokens'),
              e('span', null, stats.tokens.toLocaleString())
            ),
            observability && observability.trace_id && e('a', {
              href: LANGFUSE_URL + '/trace/' + observability.trace_id,
              target: '_blank',
              rel: 'noopener noreferrer',
              className: 'block mt-2 text-purple-400 hover:text-purple-300'
            }, 'View in Langfuse')
          )
        ),
        // Main content
        e('div', { className: 'flex-1 flex flex-col' },
          // Header
          e('div', { className: 'h-14 border-b border-gray-700 flex items-center px-4 gap-4' },
            e('button', {
              onClick: function() { setSidebarOpen(!sidebarOpen); },
              className: 'text-gray-400 hover:text-white'
            },
              e('svg', { className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 12h16M4 18h16' })
              )
            ),
            e('div', { className: 'text-sm text-gray-400' },
              currentThread ? 'Thread: ' + currentThread.slice(0, 8) + '...' : 'New Conversation'
            ),
            lastContext && e('div', { className: 'flex gap-3 text-xs ml-auto' },
              lastContext.memory_recalled && e('span', { className: 'text-purple-400' }, 'Memory'),
              lastContext.work_order_created && e('span', { className: 'text-yellow-400' }, 'WO: ' + lastContext.work_order_created)
            )
          ),
          // Messages
          e('div', { className: 'flex-1 overflow-y-auto scrollbar-thin p-4' },
            messages.length === 0 && e('div', { className: 'h-full flex items-center justify-center' },
              e('div', { className: 'text-center text-gray-500' },
                e('div', { className: 'text-6xl mb-4' }, '\u26A1'),
                e('div', { className: 'text-xl mb-2' }, 'Metis Portal'),
                e('div', { className: 'text-sm' }, 'AI orchestration with enforced directives, memory recall, and work order tracking.'),
                e('div', { className: 'text-xs mt-4 text-gray-600' }, 'Observability powered by Langfuse')
              )
            ),
            messages.map(function(msg, i) {
              return e('div', {
                key: i,
                className: 'mb-4 ' + (msg.role === 'user' ? 'flex justify-end' : '')
              },
                e('div', {
                  className: 'max-w-3xl ' + (
                    msg.role === 'user' ? 'bg-blue-600 rounded-2xl rounded-br-sm px-4 py-2' :
                    msg.role === 'error' ? 'bg-red-900/50 border border-red-700 rounded-lg p-4' :
                    'bg-gray-800 rounded-2xl rounded-bl-sm px-4 py-3'
                  )
                },
                  msg.role === 'assistant' ?
                    e(MessageContent, { content: msg.content }) :
                    e('div', { className: 'whitespace-pre-wrap' }, msg.content),
                  msg.role === 'assistant' && (msg.tokens || msg.latency) && e('div', {
                    className: 'mt-2 pt-2 border-t border-gray-700 text-xs text-gray-500 flex gap-4 flex-wrap'
                  },
                    msg.tokens > 0 && e('span', null, msg.tokens.toLocaleString() + ' tokens'),
                    msg.cost > 0 && e('span', null, '$' + parseFloat(msg.cost).toFixed(4)),
                    msg.latency > 0 && e('span', null, (msg.latency / 1000).toFixed(1) + 's'),
                    msg.trace_id && e('a', {
                      href: LANGFUSE_URL + '/trace/' + msg.trace_id,
                      target: '_blank',
                      rel: 'noopener noreferrer',
                      className: 'text-purple-400 hover:text-purple-300'
                    }, 'trace')
                  )
                )
              );
            }),
            loading && e('div', { className: 'mb-4' },
              e('div', { className: 'bg-gray-800 rounded-2xl rounded-bl-sm px-4 py-3 max-w-3xl' },
                e('div', { className: 'flex items-center gap-2 text-gray-400' },
                  e('span', { className: 'animate-pulse' }, '\u2022'),
                  e('span', { className: 'animate-pulse' }, '\u2022'),
                  e('span', { className: 'animate-pulse' }, '\u2022'),
                  e('span', { className: 'ml-2 text-sm' }, 'Metis is thinking...')
                )
              )
            ),
            e('div', { ref: messagesEndRef })
          ),
          // Input
          e('div', { className: 'p-4 border-t border-gray-700' },
            e('form', { onSubmit: sendMessage, className: 'flex gap-3' },
              e('input', {
                type: 'text',
                value: input,
                onChange: function(evt) { setInput(evt.target.value); },
                placeholder: 'Message Metis...',
                className: 'flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500',
                disabled: loading
              }),
              e('button', {
                type: 'submit',
                disabled: loading || !input.trim(),
                className: 'bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:text-gray-500 text-white px-6 py-3 rounded-xl font-medium transition-colors'
              }, loading ? 'Sending...' : 'Send')
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>
